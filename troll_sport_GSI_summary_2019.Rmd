---
title: "Troll + Sport GSI Plots AY 2019"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

```{r setup, message=FALSE, results='hide'}
knitr::opts_chunk$set(echo = FALSE, fig.width = 10)
source("~/../R/Functions.GCL.R")
library(tidyverse)
library(lubridate)
load_objects("../Objects/")
load_objects("../Estimates objects/")
```

# Objective

This notebook has GSI results for AY 2019 troll and sport. The winter troll data has been shared previously, but the spring and summer troll + sport GSI data is new. I've included some annual summaries to provide context for how AY 2019 stacks up to previous years (previous treaty period AY 2009-2018). Please let me know if you have any questions or comments.

# Winter Troll - AY 2019

## Harvest

Low harvest in Early Winter NO, with a higher proportion of Early Winter harvest in NI and SI. Late Winter harvest was higher in NO than last year.
```{r winter_harvest, message=FALSE}
(winter_harvest <- read_csv("../Harvest Data/20191021_ft - Detailed Fish Tickets.csv") %>% 
  mutate(Month = month(`Date Fishing Ended`, label = TRUE, abbr = FALSE)) %>% 
  mutate(Fishery = case_when(Month %in% month.name[1:4] ~ "Late Winter",
                             Month %in% month.name[5] ~ "Spring Ret 1", 
                             Month %in% month.name[6] ~ "Spring Ret 2", 
                             Month %in% month.name[7] ~ "Summer Ret 1",
                             Month %in% month.name[8:9] ~ "Summer Ret 2",
                             Month %in% month.name[10:12] ~ "Early Winter"
                             )) %>% 
 mutate(Quadrant = case_when(District %in% c(113, 114, 116, 154, 156, 157, 181, 183, 189) ~ 171,
                             District %in% c(103, 104, 152) ~ 172,
                             District %in% c(109, 110, 111, 112, 115) ~ 173,
                             District %in% c(101, 102, 105, 106, 107, 108) ~ 174)) %>% 
  filter(Year == 2018 & Fishery == "Early Winter" | Year == 2019 & Fishery == "Late Winter") %>% 
  group_by(Quadrant, Fishery) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  spread(Fishery, Harvest, fill = 0))
```

## Sample sizes

Final samples sizes for all Quadrant x Period. **Note** in all quadrants, we had to subsample in order to make everything proportional to harvest by stat week.
```{r winter_n}
winter_2019_sample_sizes %>% 
  separate(silly, into = c("Fishery", "Year"), sep = "_") %>% 
  select(Fishery, genotyped, missing, duplicate, final) %>% 
  mutate(Quadrant = str_sub(string = Fishery, start = 6, end = 7),
         Fishery = str_sub(string = Fishery, start = 1, end = 5)) %>% 
  mutate(Fishery = case_when(Fishery == "EWint" ~ "Early Winter",
                             Fishery == "LWint" ~ "Late Winter")) %>% 
  mutate(Quadrant = case_when(Quadrant == "NO" ~ 171,
                              Quadrant == "SO" ~ 172,
                              Quadrant == "NI" ~ 173,
                              Quadrant == "SI" ~ 174)) %>% 
  select(Fishery, Quadrant, final) %>% 
  spread(Fishery, final, fill = 0)
```

## Stock composition

For each Quadrant and Period there will be a table showing stock composition results for all major stocks (i.e. those contributing > 5% to harvest).  
**Note** Sample sizes for Early Winter are small given the limited harvest and subsampling.

### Early Winter - Northern Outside (171), Northern Inside (173), and Southern Inside (174)
What are the major stocks contributing to these mixtures (mean > 5%)? **Note** these sample sizes are all ~100 fish, so please take with a grain of salt!
```{r winter_stock_comp_table_EWintNO}
winter_2019_33RG_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & fishery == "EWint" & quadrant != "SO") %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(quadrant, fishery, desc(mean)) %>% 
  select(fishery, quadrant, group, mean, sd, `5%`, `95%`)
```

Lower proportion of Columbia River stocks than last year.
```{r winter_troll_figures_EWintNO, fig.height=10}
winter_2019_33RG_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(fishery == "EWint" & quadrant != "SO") %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Early Winter Troll AY 2019: Quadrant") +
  facet_grid(quadrant ~ .)
```

### Early Winter - All Quadrants

What are the major stocks contributing to these mixtures (mean > 5%)?
```{r winter_stock_comp_table_EWintAllQuad}
winter_2019_33RG_stratified_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & fishery == "EWint") %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(quadrant, fishery, desc(mean)) %>% 
  select(fishery, quadrant, group, mean, sd, `5%`, `95%`)
```

Much lower prevalence of Columbia River stocks and higher proportion of SSEAK stocks. This is partly due to the shift in harvest away from NO to NI and SI
```{r winter_troll_figures_EWintAllQuad}
winter_2019_33RG_stratified_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(fishery == "EWint") %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Early Winter Troll AY 2019: All Quad")
```

### Late Winter - Northern Outside (171), Northern Inside (173), and Southern Inside (174)

What are the major stocks contributing to these mixtures (mean > 5%)?  
**Note** sample sizes for NI and SI are much less than NO, so please take with a grain of salt!
```{r winter_stock_comp_table_LWintNONISI}
winter_2019_33RG_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & fishery == "LWint" & quadrant != "SO") %>% 
  mutate(quadrant = factor(x = quadrant, levels = c("NO", "SO", "NI", "SI"))) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(quadrant, fishery, desc(mean)) %>% 
  select(fishery, quadrant, group, mean, sd, `5%`, `95%`)
```

These stock compositions are more in line with what we saw last year.
```{r winter_troll_figures_LWintNONISI}
winter_2019_33RG_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(fishery == "LWint" & quadrant != "SO") %>% 
  mutate(quadrant = factor(x = quadrant, levels = c("NO", "SO", "NI", "SI"))) %>%   ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Late Winter Troll AY 2019: Quadrant") +
  facet_grid(quadrant ~ .)
```

### Late Winter - All Quadrants

What are the major stocks contributing to these mixtures (mean > 5%)?
```{r winter_stock_comp_table_LWintAllQuad}
winter_2019_33RG_stratified_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & fishery == "LWint") %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(quadrant, fishery, desc(mean)) %>% 
  select(fishery, quadrant, group, mean, sd, `5%`, `95%`)
```

Overall picture for Late Winter is similar to last year. Most of the harvest is from WCVI and BC stocks + SSEAK in inside waters.
```{r winter_troll_figures_LWintAllQuad}
winter_2019_33RG_stratified_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(fishery == "LWint") %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Late Winter Troll AY 2019: All Quad")
```

# Spring Troll - AY 2019

## Harvest

```{r spring_harvest, message=FALSE}
(spring_harvest <- read_csv("../Harvest Data/20191021_ft - Detailed Fish Tickets.csv") %>% 
   filter(`Harvest Code` == 13 & Year == 2019) %>% 
   mutate(Month = month(`Date Fishing Ended`, label = TRUE, abbr = FALSE)) %>% 
   group_by(`Stat Area`, Month) %>% 
   summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
   spread(Month, Harvest, fill = 0))
```

## Sample sizes

Final samples sizes for all Stat Area x Month mixtures.
```{r spring_n}
spring_2019_sample_sizes %>% 
  separate(silly, into = c("period", "Stat Area", "Year"), sep = "_") %>% 
  mutate(Month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>%
  mutate(Month = factor(x = Month, levels = month.name)) %>% 
  select(`Stat Area`, Month, final) %>% 
  spread(Month, final, fill = 0)
```

## Stock composition

For each Stat Area there will be a table showing stock composition results for all major stocks (i.e. those contributing > 5% to harvest).  
**Note** we had to subsample in order to make sure that the number of samples analyzed were proportional to harvest by stat week.

### Mountain Point 101-45

What are the major stocks contributing to these mixtures (mean > 5%)?
```{r spring_stock_comp_table_10145}
spring_2019_33RG_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & stat_area == "10145") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(stat_area, month, desc(mean)) %>% 
  select(stat_area, month, group, mean, sd, `5%`, `95%`)
```

```{r spring_troll_figures_10145}
spring_2019_33RG_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(stat_area == "10145") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Spring Troll AY 2019: Mountain Point 101-45") +
  facet_grid(month ~ .)
```

### Rock Point 101-46

What are the major stocks contributing to these mixtures (mean > 5%)?
```{r spring_stock_comp_table_10146}
spring_2019_33RG_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & stat_area == "10146") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(stat_area, month, desc(mean)) %>% 
  select(stat_area, month, group, mean, sd, `5%`, `95%`)
```

```{r spring_troll_figures_10146}
spring_2019_33RG_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(stat_area == "10146") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Spring Troll AY 2019: Rock Point 101-46") +
  facet_grid(month ~ .)
```

### Bucareli Bay 103-50

What are the major stocks contributing to these mixtures (mean > 5%)?  
**Note** sample size is <100 fish for June, take these with a grain of salt.
```{r spring_stock_comp_table_10350}
spring_2019_33RG_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & stat_area == "10350") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(stat_area, month, desc(mean)) %>% 
  select(stat_area, month, group, mean, sd, `5%`, `95%`)
```

```{r spring_troll_figures_10350}
spring_2019_33RG_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(stat_area == "10350") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Spring Troll AY 2019: Bucareli Bay 103-50") +
  facet_grid(month ~ .)
```

### Western Chanel 113-01

What are the major stocks contributing to these mixtures (mean > 5%)?  
**Note** sample size is ~100 fish, take these with a grain of salt.
```{r spring_stock_comp_table_11301}
spring_2019_33RG_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & stat_area == "11301") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(stat_area, month, desc(mean)) %>% 
  select(stat_area, month, group, mean, sd, `5%`, `95%`)
```

```{r spring_troll_figures_11301, out.width="50%"}
spring_2019_33RG_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(stat_area == "11301") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Spring Troll AY 2019: Western Chanel 113-01") +
  facet_grid(month ~ .)
```

### Redoubt Bay 113-30

What are the major stocks contributing to these mixtures (mean > 5%)?  
**Note** sample size is ~100 fish for May and <100 fish for June, take these with a grain of salt.
```{r spring_stock_comp_table_11330}
spring_2019_33RG_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & stat_area == "11330") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(stat_area, month, desc(mean)) %>% 
  select(stat_area, month, group, mean, sd, `5%`, `95%`)
```

```{r spring_troll_figures_11330, out.width="50%"}
spring_2019_33RG_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(stat_area == "11330") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Spring Troll AY 2019: Redoubt Bay 113-30") +
  facet_grid(month ~ .)
```

### Sitka Sound 113-41

What are the major stocks contributing to these mixtures (mean > 5%)?
```{r spring_stock_comp_table_11341}
spring_2019_33RG_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & stat_area == "11341") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(stat_area, month, desc(mean)) %>% 
  select(stat_area, month, group, mean, sd, `5%`, `95%`)
```

```{r spring_troll_figures_11341}
spring_2019_33RG_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(stat_area == "11341") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Spring Troll AY 2019: Sitka Sound 113-41") +
  facet_grid(month ~ .)
```

### Salisbury Sound 113-62

What are the major stocks contributing to these mixtures (mean > 5%)?  
**Note** sample size is ~100 fish for May, take these with a grain of salt.
```{r spring_stock_comp_table_11362}
spring_2019_33RG_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & stat_area == "11362") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(stat_area, month, desc(mean)) %>% 
  select(stat_area, month, group, mean, sd, `5%`, `95%`)
```

```{r spring_troll_figures_11362, out.width="50%"}
spring_2019_33RG_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(stat_area == "11362") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Spring Troll AY 2019: Salisbury Sound 113-62") +
  facet_grid(month ~ .)
```

### Yakutat Bay 183-10

What are the major stocks contributing to these mixtures (mean > 5%)?  
**Note** sample size is ~100 fish for both May and June, take these with a grain of salt.
```{r spring_stock_comp_table_18310}
spring_2019_33RG_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & stat_area == "18310") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(stat_area, month, desc(mean)) %>% 
  select(stat_area, month, group, mean, sd, `5%`, `95%`)
```

```{r spring_troll_figures_18310, out.width="50%"}
spring_2019_33RG_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(stat_area == "18310") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Spring Troll AY 2019: Yakutat Bay 183-10") +
  facet_grid(month ~ .)
```

### Spring - All Quadrants

What are the major stocks contributing to these mixtures (mean > 5%)?  
**Note** Since we did not analyze samples for all months and stat areas, we applied stock compositions from nearby areas/months to represent unanalyzed harvest. These unanalyzed harvests were very low, so this shouldn't have a big effect.
```{r spring_stock_comp_table_SpringAllQuad}
 spring_2019_33RG_stratified_estimates.tdy <-  bind_rows(
    lapply(c("SpringAllQuad_2019"), function(mix) {  # loop over mixture names
      list("SpringAllQuad_2019" = Spring_2019_33RG_StratifiedEstimatesStats)[[mix]] %>%  # for each matrix
        as_tibble(rownames = "group") %>%  # make tibble with rownames as group
        mutate(mixname = mix) %>%  # make column for mixname
        mutate(n_group = n_distinct(group))  # make column for number of groups
    } )
  ) %>% 
  gather(estimator, value, -mixname, -group, - n_group) %>%  # gather all estimators
  separate(mixname, c("mix", "year"), sep = "_", remove = FALSE) %>%  # extract mixture and year
  separate(mix, c("fishery", "quadrant"), sep = 6) %>%  # extract district and gear
  mutate(estimator = factor(estimator, c("mean", "sd", "5%", "95%", "median", "P=0", "GR"))) %>%  # factor for ordering
  mutate(group = factor(group, GroupNames33))  # factor for ordering

spring_2019_33RG_stratified_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(quadrant, fishery, desc(mean)) %>% 
  select(fishery, quadrant, group, mean, sd, `5%`, `95%`)
```

Overall picture for Spring is similar to last year. Most of the harvest is of Alaska stocks (Andrew Creek + SSEAK) with the remainder from WCVI.
```{r spring_troll_figures_LWintAllQuad}
spring_2019_33RG_stratified_estimates.tdy %>% 
  spread(estimator, value) %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Spring Troll AY 2019: All Quad")
```

# Summer Troll - AY 2019

## Harvest

```{r summer_harvest, message=FALSE}
(summer_harvest <- read_csv("../Harvest Data/20191021_ft - Detailed Fish Tickets.csv") %>% 
  mutate(Month = month(`Date Fishing Ended`, label = TRUE, abbr = FALSE)) %>% 
  mutate(Fishery = case_when(Month %in% month.name[1:4] ~ "Late Winter",
                             Month %in% month.name[5] ~ "Spring Ret 1", 
                             Month %in% month.name[6] ~ "Spring Ret 2", 
                             Month %in% month.name[7] ~ "Summer Ret 1",
                             Month %in% month.name[8:9] ~ "Summer Ret 2",
                             Month %in% month.name[10:12] ~ "Early Winter"
                             )) %>% 
 mutate(Quadrant = case_when(District %in% c(113, 114, 116, 154, 156, 157, 181, 183, 189) ~ 171,
                             District %in% c(103, 104, 152) ~ 172,
                             District %in% c(109, 110, 111, 112, 115) ~ 173,
                             District %in% c(101, 102, 105, 106, 107, 108) ~ 174)) %>% 
  filter(Year == 2019 & Fishery %in% c("Summer Ret 1", "Summer Ret 2")) %>%
  group_by(Quadrant, Fishery) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  spread(Fishery, Harvest, fill = 0))
```

## Sample sizes

Final samples sizes for all Quadrant x Period. In order to get full period estimates, stock compositions for each quadrant were stratified by quadrant-specific harvest.
```{r summer_n}
summer_2019_sample_sizes %>% 
  separate(silly, into = c("Fishery", "Year"), sep = "_") %>% 
  separate(Fishery, into = c("Fishery", "Quadrant"), sep = 10) %>% 
  mutate(Fishery = case_when(Fishery == "SummerRet1" ~ "Summer Ret 1",
                             Fishery == "SummerRet2" ~ "Summer Ret 2")) %>% 
  mutate(Quadrant = case_when(Quadrant == "NO" ~ 171,
                              Quadrant == "SO" ~ 172,
                              Quadrant == "NI" ~ 173,
                              Quadrant == "SI" ~ 174)) %>% 
  select(Fishery, Quadrant, final) %>% 
  spread(Fishery, final, fill = 0)
```

## Stock composition

For each Quadrant and Period there will be a table showing stock composition results for all major stocks (i.e. those contributing > 5% to harvest).  

### Summer Retention 1 - Northern Outside (171), Southern Outside (172)

What are the major stocks contributing to these mixtures (mean > 5%)?  
**Note** the sample sizes for NO are larger than SO, hence the smaller standard deviations (and credibility intervals) for NO estiamtes.
```{r summer_stock_comp_table_SummerRet1NOSO}
summer_2019_33RG_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & fishery == "SummerRet1" & quadrant %in% c("NO", "SO")) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(quadrant, fishery, desc(mean)) %>% 
  select(fishery, quadrant, group, mean, sd, `5%`, `95%`)
```

```{r summer_troll_figures_SummerRet1NOSO}
summer_2019_33RG_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(fishery == "SummerRet1" & quadrant %in% c("NO", "SO")) %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Summer Retention 1 Troll AY 2019: Quadrant") +
  facet_grid(quadrant ~ fishery)
```

### Summer Retention 1 - All Quadrants

What are the major stocks contributing to these mixtures (mean > 5%)?
```{r summer_stock_comp_table_SummerRet1AllQuad}
summer_2019_33RG_stratified_estimates.tdy <- 
  bind_rows(
    lapply(c("SummerRet1AllQuad_2019", "SummerRet2AllQuad_2019"), function(mix) {  # loop over mixture names
      list("SummerRet1AllQuad_2019" = SummerRet1_2019_33RG_StratifiedEstimatesStats,
           "SummerRet2AllQuad_2019" = SummerRet2_2019_33RG_StratifiedEstimatesStats)[[mix]] %>%  # for each matrix
        as_tibble(rownames = "group") %>%  # make tibble with rownames as group
        mutate(mixname = mix) %>%  # make column for mixname
        mutate(n_group = n_distinct(group))  # make column for number of groups
    } )
  ) %>% 
  gather(estimator, value, -mixname, -group, - n_group) %>%  # gather all estimators
  separate(mixname, c("mix", "year"), sep = "_", remove = FALSE) %>%  # extract mixture and year
  separate(mix, c("fishery", "quadrant"), sep = 10) %>%  # extract district and gear
  mutate(estimator = factor(estimator, c("mean", "sd", "5%", "95%", "median", "P=0", "GR"))) %>%  # factor for ordering
  mutate(group = factor(group, GroupNames33))  # factor for ordering

summer_2019_33RG_stratified_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & fishery == "SummerRet1") %>%
  mutate_if(is.numeric, round, 1) %>% 
  arrange(quadrant, fishery, desc(mean)) %>% 
  select(fishery, quadrant, group, mean, sd, `5%`, `95%`)
```

The big change from AY 2018  is the high prevalence of Souther Thompson (Fraser) and a decrease in Washington Coastals.
```{r summer_troll_figures_SummerRet1AllQuad}
summer_2019_33RG_stratified_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(fishery == "SummerRet1") %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Summer Retention 1 Troll AY 2019: All Quad")
```

### Summer Retention 2 - Northern Outside (171), Southern Outside (172)

What are the major stocks contributing to these mixtures (mean > 5%)?  
**Note** the sample sizes for NO are larger than SO, hence the smaller standard deviations (and credibility intervals) for NO estiamtes. Also, the sample size for SO is < 200 fish.
```{r summer_stock_comp_table_SummerRet2NOSO}
summer_2019_33RG_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & fishery == "SummerRet2" & quadrant %in% c("NO", "SO")) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(quadrant, fishery, desc(mean)) %>% 
  select(fishery, quadrant, group, mean, sd, `5%`, `95%`)
```

```{r summer_troll_figures_SummerRet2NOSO}
summer_2019_33RG_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(fishery == "SummerRet2" & quadrant %in% c("NO", "SO")) %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Summer Retention 2 Troll AY 2019: Quadrant") +
  facet_grid(quadrant ~ .)
```

### Summer Retention 2 - All Quadrants

What are the major stocks contributing to these mixtures (mean > 5%)?
```{r summer_stock_comp_table_SummerRet2AllQuad}
summer_2019_33RG_stratified_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & fishery == "SummerRet2") %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(quadrant, fishery, desc(mean)) %>% 
  select(fishery, quadrant, group, mean, sd, `5%`, `95%`)
```

More South Thompson (Fraser) and Columbia River fish compared to AY 2018.
```{r summer_troll_figures_SummerRet2AllQuad}
summer_2019_33RG_stratified_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(fishery == "SummerRet2") %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Summer Retention 2 Troll AY 2019: All Quad")
```

# Troll Summary - AY 2019

This is a heatmap showing the mean stock composition for the 7 "Driver" stocks for each troll period for the Northern Outside Quadrant (NO - 171) and stratified by harvest across all quadrants (All). Overall, the spatio-temporal patterns of stock composition are similar to previous years. Some exceptions are:  

  1) Higher contribution from South Thompson (Fraser) during summer AY 2019 than AY 2018.  
  2) Lower contributions of Interior Columbia Summer/Fall to the troll fishery in general after the highs of 2014-2016.  
  3) Lower contribution of Washington Coast during summer AY 2019 than AY 2018.
```{r troll_2019_heatmap, out.height="100%", warning=FALSE, message=FALSE}
troll_2019_8RG_estimates.tdy %>% 
  mutate(quad = case_when(grepl(pattern = "NO", x = mix) ~ "NO",
                          TRUE ~ "All")) %>% 
  mutate(fishery = toupper(substr(x = mixname, start = 1, stop = 2))) %>% 
  mutate(fishery = case_when(grepl(pattern = "SumRet1", x = mix) ~ "SU1",
                             grepl(pattern = "SumRet2", x = mix) ~ "SU2",
                             TRUE ~ fishery)) %>% 
  mutate(fishery = factor(x = fishery, levels = c("EW", "LW", "SP", "SU1", "SU2"))) %>% 
  filter(quad %in% c("NO", "All")) %>% 
  mutate(quad = factor(x = quad, levels = c("All", "NO"))) %>% 
  spread(estimator, value) %>% 
  left_join(tibble(group = GroupNames8, group_pub = GroupNames8Pub)) %>% 
  mutate(group_pub = factor(x = group_pub, levels = GroupNames8Pub)) %>% 
  ggplot(aes(x = fishery, y = quad, fill = mean)) +
  geom_tile(colour = "grey") +
  scale_fill_gradient(low = "white", high = "red", name = "Stock\nComposition") +
  facet_wrap(~group_pub, nrow = 4, ncol = 2) +
  theme_bw() +
  xlab("Fishery") +
  ylab("Quadrant") +
  ggtitle("Troll AY 2019")
```

# Troll Annual Summary - AY 2009-2019

Below is a stratified annual summary of the total AY troll harvest for this past year (AY 2019) and the past treaty period (AY 2009-2018). The first plot shows stock composition (% of harvest in a given year), the second shows stock-specific harvest (i.e. stock composition * annual harvest). The plot of stock-specific harvest really drives home how much those three years of high Interior Columbia Su/F abundance contributed to the troll fishery. You can also see the increases in stock composition for South Thompson (Fraser) and the decease in Washington Coast from AY 2018.
```{r troll_stockcomp_2009-2019}
troll_AY_2009_2019_8RG_estimates.tdy %>% 
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = mean * 100, fill = group)) +
  geom_col() +
  scale_fill_manual(name = "Reporting Group", 
                    values = c("blue", "red4", "green2", "purple", "cyan2", "orange", "lightblue", "pink2"),
                    labels = GroupNames8Pub) +
  scale_y_continuous(breaks = seq(0, 100, 20)) +
  ylab("Stock Composition (%)") +
  xlab("Year") +
  ggtitle("SEAK Troll Stock Composition by AY") +
  theme_classic() +
  theme(text = element_text(size = 14))
```

```{r troll_stockharvest_2009, message=FALSE, warning=FALSE}
troll_harvest_AY_2009_2019 <- read_csv("../Harvest Data/CE012326.csv", skip = 22) %>% 
  mutate(Quadrant = case_when(`Area Value` == "NE" ~ "NI",
                              `Area Value` == "NW" ~ "NO",
                              `Area Value` == "SE" ~ "SI",
                              `Area Value` == "SW" ~ "SO")) %>% 
  mutate(District = case_when(Quadrant == "NO" ~ 171,
                              Quadrant == "SO" ~ 172,
                              Quadrant == "NI" ~ 173,
                              Quadrant == "SI" ~ 174)) %>% 
  mutate(Fishery = case_when(`Time Value` == 6 ~ "Early Winter",
                             `Time Value` == 1 ~ "Late Winter",
                             `Time Value` == 2 ~ "Spring Ret 1",
                             `Time Value` == 3 ~ "Spring Ret 2",
                             `Time Value` == 4 ~ "Summer Ret 1",
                             `Time Value` == 5 ~ "Summer Ret 2")) %>% 
  mutate(Fishery = factor(Fishery, c("Early Winter", "Late Winter", "Spring Ret 1", "Spring Ret 2", "Summer Ret 1", "Summer Ret 2"))) %>% 
  mutate(AY = case_when(Fishery == "Early Winter" ~ Year + 1,
                        TRUE ~ Year)) %>% 
  filter(AY >= 2009 & AY < 2020) %>% 
  select(AY, Year, Fishery, Quadrant, District, `N Catch`) %>% 
  dplyr::rename(Harvest = `N Catch`)

(annual_troll_harvest_AY_2009_2019 <- troll_harvest_AY_2009_2019 %>% 
    group_by(AY) %>% 
    summarise(Harvest = sum(Harvest)))

troll_AY_2009_2019_8RG_estimates.tdy %>% 
  left_join(annual_troll_harvest_AY_2009_2019, by = c("year" = "AY")) %>% 
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = mean * Harvest / 1000, fill = group)) +
  geom_col() +
  scale_fill_manual(name = "Reporting Group", 
                    values = c("blue", "red4", "green2", "purple", "cyan2", "orange", "lightblue", "pink2"),
                    labels = GroupNames8Pub) +
  # scale_y_continuous(breaks = seq(0, 100, 20)) +
  ylab("Stock-Specific Harvest (1,000's)") +
  xlab("Year") +
  ggtitle("SEAK Troll Stock-specific Harvest by AY") +
  theme_classic() +
  theme(text = element_text(size = 14))
```

# Sport - AY 2019

## Harvest

**Note** 2019 harvest numbers are *preliminary* from the creel estimates, not the final numbers from the SWHS!
```{r sport_harvest, message=FALSE}
harvest_sport <- read_csv(file = "../Harvest Data/preliminary_2019_sport_harvest_chinook.csv")

#~~~~~~~~~~~~~~~~~~
## Manipulate harvest data
# Make data tall (tidy), recode sites to ALL CAPS
level_key <- list("Juneau" = "JUNEAU", 
                  "Ketchikan" = "KETCHIKAN", 
                  "Wrangell" = "WRANGELL", 
                  "Petersburg" = "PETERSBURG", 
                  "Sitka" = "SITKA", 
                  "Craig" = "CRAIG_KLAWOCK", 
                  "Gustavus" = "GUSTAVUS", 
                  "Elfin Cove" = "ELFIN_COVE", 
                  "Yakutat" = "YAKUTAT")

harvest_sport <- harvest_sport %>% 
  gather(site, harvest, -biweek) %>% 
  mutate(site = recode_factor(site, !!!level_key, .ordered = TRUE))

# Create a variable for Fishery
harvest_sport <- harvest_sport %>% 
  mutate(fishery = case_when(site == "KETCHIKAN" ~ "KTN",
                             site %in% c("PETERSBURG", "WRANGELL") ~ "PB-WR",
                             site == "JUNEAU" ~ "Inside",
                             site %in% c("YAKUTAT", "GUSTAVUS", "ELFIN_COVE", "SITKA", "CRAIG_KLAWOCK") & biweek <= 13 ~ "Outside_early",
                             site %in% c("YAKUTAT", "GUSTAVUS", "ELFIN_COVE", "SITKA", "CRAIG_KLAWOCK") & biweek > 13 ~ "Outside_late")) %>% 
  mutate(Fishery = factor(fishery, levels = c("KTN", "PB-WR", "Inside", "Outside_early", "Outside_late")))

# Table of Harvest by site
harvest_sport %>% 
  group_by(Fishery) %>% 
  summarise(Harvest = sum(harvest))
```

## Sample sizes

Final samples sizes for all "Fisheries".  
**Note** Outside period 1 (thru biweek 13) and 2 (after biweek 13) contain fish sampled from Yakutat, Gustavus, Elfin Cove, Sitka, and Craig. Fish were subsampled by port and biweek proportional to harvest to provide a representative sample of the "fishery".
```{r sport_n}
sport_2019_sample_sizes %>% 
  separate(silly, into = c("Fishery", "Year"), sep = "Sport_") %>% 
  filter(!Fishery %in% c("CRG", "SIT")) %>% 
  dplyr::rename(n = final) %>% 
  select(Fishery, n)
```

## Stock composition

For each Fishery there will be a table showing stock composition results for all major stocks (i.e. those contributing > 5% to harvest).  
**Note** the sample size for PBGWRN was only 87 fish (see table above) , please take estiamtes from PBGWRN with a grain of salt.
```{r sport_stock_comp_table}
sport_2019_33RG_estimates.tdy %>% 
  separate(mixname, into = c("fishery", "year"), sep = "Sport_") %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & !fishery %in% c("CRG", "SIT")) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  mutate(fishery = factor(x = fishery, levels = c("KTN", "PBGWRN", "Inside", "OutsidePer1", "OutsidePer2"))) %>% 
  arrange(fishery, desc(mean)) %>% 
  select(fishery, group, mean, sd, `5%`, `95%`)
```

```{r sport_troll_figures, fig.height=10}
sport_2019_33RG_estimates.tdy %>% 
  separate(mixname, into = c("fishery", "year"), sep = "Sport_") %>% 
  filter(!fishery %in% c("CRG", "SIT")) %>% 
  mutate(fishery = factor(x = fishery, levels = c("KTN", "PBGWRN", "Inside", "OutsidePer1", "OutsidePer2"))) %>% 
  spread(estimator, value) %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Sport AY 2019") +
  facet_grid(fishery ~ .)
```

# Sport Summary - AY 2019

This is a heatmap showing the mean stock composition for the 7 "Driver" stocks for each sport "fishery. Overall, the spatio-temporal patterns of stock composition are very similar to previous years. Some minor exceptions are:  

  1) Similar to the troll fishery there was an increase in South Thompson (Fraser), a small in crease in WCVI, and a corresponding decrease in Washington Coast.
```{r sport_2019_heatmap, out.height="100%", warning=FALSE, message=FALSE}
tmp <- sport_2019_8RG_estimates.tdy %>% 
  filter(!mix %in% c("CRG", "SIT")) %>% 
  mutate(area = case_when(mix %in% c("OutsidePer1", "OutsidePer2") ~ "Outside",
                             TRUE ~ mix)) %>% 
  mutate(area = factor(x = area, levels = c("KTN", "PBGWRN", "Inside", "Outside"))) %>% 
  mutate(period = case_when(mix == "OutsidePer1" ~ "Early",
                            mix == "OutsidePer2" ~ "Late",
                            TRUE ~ "Late"))

sport_2019_8RG_estimates.tdy %>% 
  filter(!mix %in% c("CRG", "SIT")) %>% 
  mutate(area = case_when(mix %in% c("OutsidePer1", "OutsidePer2") ~ "Outside",
                             TRUE ~ mix)) %>% 
  mutate(area = factor(x = area, levels = c("KTN", "PBGWRN", "Inside", "Outside"))) %>% 
  mutate(period = case_when(mix == "OutsidePer1" ~ "Early",
                            mix == "OutsidePer2" ~ "Late",
                            TRUE ~ "Early")) %>% 
  bind_rows(tmp) %>%
  distinct() %>% 
  mutate(period = factor(x = period, levels = c("Late", "Early"))) %>% 
  spread(estimator, value) %>% 
  left_join(tibble(group = GroupNames8, group_pub = GroupNames8Pub)) %>% 
  mutate(group_pub = factor(x = group_pub, levels = GroupNames8Pub)) %>% 
  ggplot(aes(x = area, y = period, fill = mean)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red", name = "Stock\nComposition") +
  facet_wrap(~group_pub, nrow = 4, ncol = 2) +
  theme_bw() +
  xlab("Area") +
  ylab("Period") +
  ggtitle("Sport AY 2019")
```

# Sport Annual Summary - AY 2009-2019

Below is a stratified annual summary of the total AY sport harvest for this past year (AY 2019) and the past treaty period (AY 2009-2018). The first plot shows stock composition (% of harvest in a given year), the second shows stock-specific harvest (i.e. stock composition * annual harvest). The plot of stock-specific harvest really drives home how much those three years of high Interior Columbia Su/F abundance contributed to the sport fishery (although mostly for outside waters).  
**Note** 2019 harvest numbers are *preliminary* from the creel estimates, not the final numbers from the SWHS!
```{r sport_stockcomp_2009-2019}
sport_AY_2009_2019_8RG_estimates.tdy %>% 
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = mean * 100, fill = group)) +
  geom_col() +
  scale_fill_manual(name = "Reporting Group", 
                    values = c("blue", "red4", "green2", "purple", "cyan2", "orange", "lightblue", "pink2"),
                    labels = GroupNames8Pub) +
  scale_y_continuous(breaks = seq(0, 100, 20)) +
  ylab("Stock Composition (%)") +
  xlab("Year") +
  ggtitle("SEAK Sport Stock Composition by AY") +
  theme_classic() +
  theme(text = element_text(size = 14))
```

```{r sport_stockharvest_2009, message=FALSE, warning=FALSE}
sport_harvest_AY_2009_2018 <- read_csv("../Harvest Data/swhs_est_20200127124345.csv", skip = 2) %>% 
  gather(year, harvest, -SOUTHEAST)

sport_harvest <- read_csv("../Harvest Data/preliminary_2019_sport_harvest_chinook.csv") %>% 
  gather(port, harvest, -biweek) %>% 
  mutate(period = case_when(biweek <= 13 ~ "early",
                            biweek > 13 ~ "late")) %>% 
  mutate(fishery = case_when(port == "Ketchikan" ~ "Ketchikan",
                             port %in% c("Petersburg", "Wrangell") ~ "PBG/WRN",
                             port == "Juneau" ~ "Inside",
                             TRUE ~ "Outside"))

(annual_sport_harvest_AY_2009_2019 <- sport_harvest_AY_2009_2018 %>% 
    filter(year >= 2009 & year <= 2018 & SOUTHEAST == "Southeast Total") %>% 
    select(year, harvest) %>% 
    bind_rows(tibble(year = "2019", harvest = sum(sport_harvest$harvest))))

sport_AY_2009_2019_8RG_estimates.tdy %>% 
  mutate(year = as.character(year)) %>% 
  left_join(annual_sport_harvest_AY_2009_2019, by = "year") %>% 
  ggplot(aes(x = year, y = mean * harvest / 1000, fill = group)) +
  geom_col() +
  scale_fill_manual(name = "Reporting Group", 
                    values = c("blue", "red4", "green2", "purple", "cyan2", "orange", "lightblue", "pink2"),
                    labels = GroupNames8Pub) +
  # scale_y_continuous(breaks = seq(0, 100, 20)) +
  ylab("Stock-Specific Harvest (1,000's)") +
  xlab("Year") +
  ggtitle("SEAK Sport Stock-specific Harvest by AY") +
  theme_classic() +
  theme(text = element_text(size = 14))
```

# Troll vs. Sport Annual Summary - AY 2009-2019

Below is a stratified annual summary of the total AY troll and sport harvest for this past year (AY 2019) and the past treaty period (AY 2009-2018). The first plot shows stock composition (% of harvest in a given year), the second shows stock-specific harvest (i.e. stock composition * annual harvest). These plots illustrate the differences in stocks targeted by each fishery. Whereas a lot of sport harvest comes from targeting SEAK hatchery-origin fish (especially in inside waters), the vast majority of troll harvest comes from non-SEAK stocks (predominantly in outside waters).
```{r troll_v_sport_stockcomp}
sport_AY_2009_2019_8RG_estimates <- sport_AY_2009_2019_8RG_estimates.tdy %>% 
  mutate(year = as.character(year)) %>% 
  mutate(fishery = "Sport")

troll_AY_2009_2019_8RG_estimates <- troll_AY_2009_2019_8RG_estimates.tdy %>% 
  mutate(year = as.character(year)) %>% 
  mutate(fishery = "Troll")

bind_rows(sport_AY_2009_2019_8RG_estimates, troll_AY_2009_2019_8RG_estimates) %>% 
  ggplot(aes(x = year, y = mean * 100, fill = group)) +
  geom_col() +
  scale_fill_manual(name = "Reporting Group", 
                    values = c("blue", "red4", "green2", "purple", "cyan2", "orange", "lightblue", "pink2"),
                    labels = GroupNames8Pub) +
  # scale_y_continuous(breaks = seq(0, 100, 20)) +
  ylab("Stock Composition (%)") +
  xlab("Year") +
  ggtitle("SEAK Stock Composition by AY and Fishery") +
  theme_classic() +
  theme(text = element_text(size = 14), axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  facet_grid(. ~ fishery)
```

```{r troll_v_sport_stockharvest}
sport_AY_2009_2019_8RG_estimates_harvest <- sport_AY_2009_2019_8RG_estimates.tdy %>% 
  mutate(year = as.character(year)) %>% 
  left_join(annual_sport_harvest_AY_2009_2019, by = "year") %>% 
  mutate(fishery = "Sport")

troll_AY_2009_2019_8RG_estimates_harvest <- troll_AY_2009_2019_8RG_estimates.tdy %>% 
  left_join(annual_troll_harvest_AY_2009_2019, by = c("year" = "AY")) %>% 
  mutate(year = as.character(year)) %>% 
  dplyr::rename(harvest = Harvest) %>% 
  mutate(fishery = "Troll")

bind_rows(sport_AY_2009_2019_8RG_estimates_harvest, troll_AY_2009_2019_8RG_estimates_harvest) %>% 
  ggplot(aes(x = year, y = mean * harvest / 1000, fill = group)) +
  geom_col() +
  scale_fill_manual(name = "Reporting Group", 
                    values = c("blue", "red4", "green2", "purple", "cyan2", "orange", "lightblue", "pink2"),
                    labels = GroupNames8Pub) +
  # scale_y_continuous(breaks = seq(0, 100, 20)) +
  ylab("Stock-Specific Harvest (1,000's)") +
  xlab("Year") +
  ggtitle("SEAK Harvest by AY and Fishery") +
  theme_classic() +
  theme(text = element_text(size = 14), axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  facet_grid(. ~ fishery)
```

What is the total toll + sport harvest?
```{r}
(annual_harvest <- bind_rows(sport_AY_2009_2019_8RG_estimates_harvest, troll_AY_2009_2019_8RG_estimates_harvest) %>% 
   mutate(stock_harvest = mean * harvest) %>% 
   group_by(year) %>% 
   summarise(total_harvest = sum(stock_harvest))
)
```

How much of that total troll + sport harvest was SEAK?
```{r}
(annual_seak_harvest <- bind_rows(sport_AY_2009_2019_8RG_estimates_harvest, troll_AY_2009_2019_8RG_estimates_harvest) %>% 
   mutate(stock_harvest = round(mean * harvest)) %>% 
   filter(group == "SEAK/TBR") %>% 
   group_by(year) %>% 
   summarise(seak_harvest = sum(stock_harvest))
)
```

Annual stock comp for troll + sport for SEAK
```{r}
annual_seak_harvest %>% 
  left_join(annual_harvest) %>% 
  mutate(p_seak = round(seak_harvest / total_harvest * 100, 1))
```

Weighted average SEAK stock comp for troll + sport for AY 2009-2019
```{r}
sum(annual_seak_harvest$seak_harvest) / sum(annual_harvest$total_harvest) * 100
```

