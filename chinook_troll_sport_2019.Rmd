---
title: "Chinook Troll + Sport AY 2019"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

# Introduction

## Goals & Objectives

The goal of this R Notebook is to analyze Chinook salmon mixtures from SEAK troll and sport fisheries for AY 2019. The individuals mixtures are indicated below by fishery:

  * Troll
    + Early Winter
        - NO
        - SO
        - NI
        - SI
    + Late Winter
        - NO
        - SO
        - NI
        - SI
    + Spring 1 (May)
        - 10350 - 121 fish
        - 11330 - 100 fish
        - 11341 - 200 fish
        - 11362 - 100 fish
        - 18310 - 100 fish
    + Spring 2 (June)
        - 10145 - 200 fish
        - 10146 - 174 fish
        - 10350 - 58 fish
        - 11301 - 100 fish
        - 11330 - 40 fish
        - 11341 - 200 fish
        - 11362 - 200 fish
        - 18310 - 100 fish
    + Summer 1
        - NO
        - SO
        - NI
        - SI
    + Summer 2
        - NO
        - SO
        - NI
        - SI
  * Sport
    + Outside
        - Through BW 13
        - After BW 13
    + Petersburg-Wrangell (PBG-WRN)
    + Juneau (JNU)
    + Ketchikan (KTN)
    + Sitka (SIT)
    + Craig (CRG)

We are going to run everything for 33 reporting groups and then summarise from there for whoever needs it.

## Outline

This R Notebook will:

1) Import mixture genotypes
2) Join ASL
3) Define mixture strata
3) Data QA
4) Create *BAYES* files
5) Summarize *BAYES* results
6) Output tables

## Setup

Load *GCL-R-Functions* and all necessary packages.
```{r setup, message=FALSE, results='hide'}
source("~/../R/Functions.GCL.R")
library(tidyverse)
library(lubridate)

.username <- "krshedd"
.password <- ""
```

Read in those objects and `LocusControl`
```{r load_objects}
load_objects("../Objects/")
```

# Winter troll: import mixture genotypes

Read in genotypes from *LOKI* as `.gcl` objects. Save in directory.
```{r winter_loki}
winter_2019_sillys <- c("KTROL18EW", "KTROL19LW")
LOKI2R_GAPS.GCL(sillyvec = winter_2019_sillys, username = .username, password = .password)
rm(.username, .password)

sapply(winter_2019_sillys, function(silly) {get(paste0(silly, ".gcl"))$n} )

save_sillys(sillyvec = winter_2019_sillys, path = "../Genotypes/original")
save_objects(objects = c("winter_2019_sillys"), path = "../Objects/")
```

# Join ASL

## Winter Troll

Read in the troll ASL data.
```{r troll_asl, message=FALSE}
(troll_ASL <- read_csv(file = "../ASL Data/20191021_Detailed ASL Samples.csv") %>% 
   select(Year, `Sample Date`, `Stat Week`, `Port Code`, `Gear`, `District`, `Dna Specimen No`, `Cwt Strap Tag No`, `Gear Code`, `Harvest Code`))

# Any duplicate Dna Specimen No?
table(table(troll_ASL$`Dna Specimen No`, useNA = "always"), useNA = "always")
```

Filter for just winter troll fish to avoid this maddness.
```{r}
(asl_winter <- troll_ASL %>% 
   mutate(Year_f = factor(Year)) %>% 
   dplyr::rename(Quadrant = District) %>% 
   mutate(Fishery = case_when(`Harvest Code` == 13 ~ "Spring",
                              `Harvest Code` == 11 & `Stat Week` <= 11 ~ "Late Winter",
                              `Harvest Code` == 11 & `Stat Week` >= 41 ~ "Early Winter",
                              `Harvest Code` == 11 & `Stat Week` >= 27 & `Stat Week` <= 31 ~ "Summer Ret 1",
                              `Harvest Code` == 11 & `Stat Week` >= 32 & `Stat Week` <= 36 ~ "Summer Ret 2")) %>% 
   mutate(Fishery = factor(Fishery, levels = c("Late Winter", "Spring", "Summer Ret 1", "Summer Ret 2", "Early Winter"))) %>% 
   filter(Year == 2018 & Fishery == "Early Winter" | Year == 2019 & Fishery == "Late Winter")
)
```

Now how about duplicate Dna Specimen No?
```{r}
table(table(asl_winter$`Dna Specimen No`))
```

Cool, just one, no biggie.
```{r asl_duplicates}
asl_winter_duplicates <- asl_winter %>% 
  group_by(`Dna Specimen No`) %>% 
  summarise(n = n()) %>% 
  filter(n > 1) %>% 
  pull(`Dna Specimen No`)

asl_winter %>% 
  filter(`Dna Specimen No` %in% asl_winter_duplicates) %>% 
  arrange(`Dna Specimen No`)
```

Are any of these fish in our winter troll samples?
```{r asl_duplicates_winter_troll}
early_winter_samples <- KTROL18EW.gcl$attributes %>% 
  mutate(`Dna Specimen No` = as.integer(paste0(str_sub(DNA_TRAY_CODE, 7, 10), str_pad(DNA_TRAY_WELL_CODE, 2, "left", "0")))) %>% 
  pull(`Dna Specimen No`)

table(early_winter_samples %in% asl_winter_duplicates)

late_winter_samples <- KTROL19LW.gcl$attributes %>% 
  mutate(`Dna Specimen No` = as.integer(paste0(str_sub(DNA_TRAY_CODE, 7, 10), str_pad(DNA_TRAY_WELL_CODE, 2, "left", "0")))) %>% 
  pull(`Dna Specimen No`)

table(late_winter_samples %in% asl_winter_duplicates)
```

Hrmm, better resolve this. Looking at Iris' datasheet, it appears that the sample from Petersburg in SW 9 should be 527301.
```{r}
asl_winter <- asl_winter %>% 
  mutate(`Dna Specimen No` = case_when(`Dna Specimen No` == 627301 & `Port Code` == "PBG" & `Stat Week` == 9 ~ 527301,
                                       TRUE ~ `Dna Specimen No`))
```

Did we fix it?
```{r}
table(table(asl_winter$`Dna Specimen No`))
```

Cool, none of our ASL duplicate Dna Specimen No are in there. Now verify that all winter samples are in the ASL data.
```{r winter_in_asl}
all(early_winter_samples %in% troll_ASL$`Dna Specimen No`)
all(late_winter_samples %in% troll_ASL$`Dna Specimen No`)
```

Now that we've resolved our ASL discrepancy, join with attributes to get quadrant level information.
```{r join_winter_asl}
# Join ASL with attributes table
# Early Winter
KTROL18EW.gcl$attributes <- KTROL18EW.gcl$attributes %>% 
  mutate(`Dna Specimen No` = as.integer(paste0(str_sub(DNA_TRAY_CODE, 7, 10), str_pad(DNA_TRAY_WELL_CODE, 2, "left", "0")))) %>% 
  left_join(asl_winter, by = "Dna Specimen No")

# Late Winter
KTROL19LW.gcl$attributes <- KTROL19LW.gcl$attributes %>% 
  mutate(`Dna Specimen No` = as.integer(paste0(str_sub(DNA_TRAY_CODE, 7, 10), str_pad(DNA_TRAY_WELL_CODE, 2, "left", "0")))) %>% 
  left_join(asl_winter, by = "Dna Specimen No")
```

How many fish per district?
```{r winter_district_counts}
KTROL18EW.gcl$attributes %>% 
  count(Quadrant)

KTROL19LW.gcl$attributes %>% 
  count(Quadrant)
```

# Define mixture strata

Winter mixtures are each quadrant by itself.

Create early winter mixtures.
```{r early_winter_define_mixtures}
EWintNO_2019.vials <- setNames(object = list(AttributesToIDs.GCL(silly = "KTROL18EW", attribute = "Quadrant", matching = 171)), nm = "KTROL18EW")
PoolCollections.GCL(collections = "KTROL18EW", loci = GAPSLoci_reordered, IDs = EWintNO_2019.vials, newname = "EWintNO_2019")

EWintSO_2019.vials <- setNames(object = list(AttributesToIDs.GCL(silly = "KTROL18EW", attribute = "Quadrant", matching = 172)), nm = "KTROL18EW")
PoolCollections.GCL(collections = "KTROL18EW", loci = GAPSLoci_reordered, IDs = EWintSO_2019.vials, newname = "EWintSO_2019")

EWintNI_2019.vials <- setNames(object = list(AttributesToIDs.GCL(silly = "KTROL18EW", attribute = "Quadrant", matching = 173)), nm = "KTROL18EW")
PoolCollections.GCL(collections = "KTROL18EW", loci = GAPSLoci_reordered, IDs = EWintNI_2019.vials, newname = "EWintNI_2019")

EWintSI_2019.vials <- setNames(object = list(AttributesToIDs.GCL(silly = "KTROL18EW", attribute = "Quadrant", matching = 174)), nm = "KTROL18EW")
PoolCollections.GCL(collections = "KTROL18EW", loci = GAPSLoci_reordered, IDs = EWintSI_2019.vials, newname = "EWintSI_2019")

sapply(grep(pattern = "EWint", objects(pattern = "\\.gcl"), value = TRUE), function(silly) {get(silly)$n})
```

Create late winter mixtures.
```{r late_winter_define_mixtures}
LWintNO_2019.vials <- setNames(object = list(AttributesToIDs.GCL(silly = "KTROL19LW", attribute = "Quadrant", matching = 171)), nm = "KTROL19LW")
PoolCollections.GCL(collections = "KTROL19LW", loci = GAPSLoci_reordered, IDs = LWintNO_2019.vials, newname = "LWintNO_2019")

LWintSO_2019.vials <- setNames(object = list(AttributesToIDs.GCL(silly = "KTROL19LW", attribute = "Quadrant", matching = 172)), nm = "KTROL19LW")
PoolCollections.GCL(collections = "KTROL19LW", loci = GAPSLoci_reordered, IDs = LWintSO_2019.vials, newname = "LWintSO_2019")

LWintNI_2019.vials <- setNames(object = list(AttributesToIDs.GCL(silly = "KTROL19LW", attribute = "Quadrant", matching = 173)), nm = "KTROL19LW")
PoolCollections.GCL(collections = "KTROL19LW", loci = GAPSLoci_reordered, IDs = LWintNI_2019.vials, newname = "LWintNI_2019")

LWintSI_2019.vials <- setNames(object = list(AttributesToIDs.GCL(silly = "KTROL19LW", attribute = "Quadrant", matching = 174)), nm = "KTROL19LW")
PoolCollections.GCL(collections = "KTROL19LW", loci = GAPSLoci_reordered, IDs = LWintSI_2019.vials, newname = "LWintSI_2019")

sapply(grep(pattern = "LWint", objects(pattern = "\\.gcl"), value = TRUE), function(silly) {get(silly)$n})
```

Save genotypes for winter strata.
```{r save_winter_strata_genotypes}
if(!dir.exists("../Genotypes/strata")) {dir.create("../Genotypes/strata")}

winter_2019_mixnames <- c(paste0("EWint", c("NO", "SO", "NI", "SI"), "_2019"), 
                          paste0("LWint", c("NO", "SO", "NI", "SI"), "_2019"))

save_objects(objects = "winter_2019_mixnames", path = "../Objects/")
save_sillys(sillyvec = winter_2019_mixnames, path = "../Genotypes/strata/")
```

# Data QA

Standard data QA:

  * Remove fish missing <80% genotypes
  * Remove duplicates (>95% genotype concordance)

```{r QA}
# original sample sizes
winter_2019_sample_sizes <- tibble(silly = winter_2019_mixnames,
                                   genotyped = sapply(winter_2019_mixnames, function(x) {get(paste0(x, ".gcl"))$n }))

# missing
winter_2019_missing <- RemoveIndMissLoci.GCL(sillyvec = winter_2019_mixnames, proportion = 0.8)
save_objects("winter_2019_missing", "../Objects/")

winter_2019_sample_sizes <- winter_2019_sample_sizes %>% 
  mutate(missing = genotyped - sapply(winter_2019_mixnames, function(x) {get(paste0(x, ".gcl"))$n }))

# duplicate
winter_2019_duplicates <- CheckDupWithinSilly.GCL(sillyvec = winter_2019_mixnames, loci = GAPSLoci_reordered, quantile = NULL, minproportion = 0.95)
(winter_2019_duplicates_summary <- sapply(winter_2019_mixnames, function(x) {winter_2019_duplicates[[x]]$report}))
save_objects("winter_2019_duplicates_summary", "../Objects/")

winter_2019_duplciates_removed <- RemoveDups.GCL(dupcheck = winter_2019_duplicates)

winter_2019_sample_sizes <- winter_2019_sample_sizes %>% 
  mutate(duplicate = genotyped - missing - sapply(winter_2019_mixnames, function(x) {get(paste0(x, ".gcl"))$n }))

# final
winter_2019_sample_sizes <- winter_2019_sample_sizes %>% 
  mutate(final = sapply(winter_2019_mixnames, function(x) {get(paste0(x, ".gcl"))$n }))
winter_2019_sample_sizes
save_objects("winter_2019_sample_sizes", "../Objects/")

write_csv(winter_2019_sample_sizes, "../Tables/winter_2019_sample_sizes.csv")
```

Save post-QA genotypes
```{r post_QA}
if(!dir.exists("../Genotypes/strata_postQA/")) {dir.create("../Genotypes/strata_postQA/")}
save_sillys(sillyvec = winter_2019_mixnames, path = "../Genotypes/strata_postQA")
```

# Create *BAYES* files

## Directory setup

First need to set up *BAYES* directory structure and copy over baseline file and *BAYES* objects. This was already done when we ran TBR.
```{r BAYES_setup, results='hide'}
# dir.create(path = "../BAYES")
# sapply(c("Baseline", "Control", "Mixture", "Output"), function(folder) {dir.create(path = paste("../BAYES", folder, sep = "/"))} )
# 
# file.copy(from = "V:/Analysis/1_SEAK/Chinook/Baseline/GAPS3.0/Objects/SEAKPops357.txt", to = "../Objects")
# file.copy(from = "V:/Analysis/1_SEAK/Chinook/Baseline/GAPS3.0/Objects/bayesfortran_357.txt", to = "../Objects")
# file.copy(from = "V:/Analysis/1_SEAK/Chinook/Baseline/GAPS3.0/BAYES/Baseline/GAPS357pops13loci.bse", to = "../BAYES/Baseline")
# file.copy(from = "V:/Analysis/4_Westward/Sockeye/KMA Commercial Harvest 2014-2016/Mixtures/Objects/WASSIPSockeyeSeeds.txt", to = "../Objects")
# 
# TBR_mixnames <- setNames(c("D108Gill_2019", "D111Gill_2019", "D111Sport_2019"), TBR_sillys)
# save_objects("TBR_mixnames", "../Objects/")
# load_objects("../Objects/")
```

## Create mixtures

Save the fortran format and create TBR *BAYES* mixture files. This was already done when we ran TBR.
```{r BAYES_mixtures}
# mixfortran <- CreateMixture.GCL(sillys = TBR_sillys[1], loci = GAPSLoci_reordered, IDs = NULL, mixname = TBR_mixnames[TBR_sillys[1]], dir = "../BAYES/Mixture", type = "BAYES", PT = FALSE)
# save_objects("mixfortran", "../Objects/")

sapply(winter_2019_mixnames, function(mix) {
  CreateMixture.GCL(sillys = mix, loci = GAPSLoci_reordered, IDs = NULL, mixname = mix, dir = "../BAYES/Mixture", type = "BAYES", PT = FALSE)
} )
```

## Create priors

Use last year's 33RG estimates
```{r read_2018_estimates}
EWint_2018_33RG_EstimatesStats <- dget("../../SEAK18/Estimates objects/EWint_2018_33RG_EstimatesStats.txt")
LWint_2018_33RG_EstimatesStats <- dget("../../SEAK18/Estimates objects/LWint_2018_33RG_EstimatesStats.txt")

(winter_2018_means <- sapply(c(EWint_2018_33RG_EstimatesStats, LWint_2018_33RG_EstimatesStats), function(mix) {mix[, "mean"]}))
```

Change names
```{r setup_2019_priors}
# Fix dimnames
colnames(winter_2018_means) <- str_replace(string = colnames(winter_2018_means), pattern = "2018", replacement = "2019")

# Verify
apply(winter_2018_means, 2, sum)
```

Now create 2019 priors.
```{r create_2019_priors}
winter_2019_priors <- apply(winter_2018_means, 2, function(mix) {
  Prior.GCL(groupvec = GroupVec33RG_357, groupweights = mix, minval = 0.01)
} )
colnames(winter_2019_priors) <- winter_2019_mixnames
save_objects("winter_2019_priors", "../Objects/")
```

## Create control files

Now that we have priors, just need to create *BAYES* control files.
```{r BAYES_control}
sapply(winter_2019_mixnames, function(mix) {
  CreateControlFile.GCL(
    sillyvec = SEAKPops357,
    loci = GAPSLoci_reordered,
    mixname = mix,
    basename = "GAPS357pops13loci",
    suffix = "",
    nreps = 40000,
    nchains = 5,
    groupvec = GroupVec33RG_357,
    priorvec = winter_2019_priors[, mix],
    initmat = GAPS357PopsInits,
    dir = "../BAYES/Control",
    seeds = WASSIPSockeyeSeeds,
    thin = c(1, 1, 100),
    mixfortran = mixfortran,
    basefortran = bayesfortran_357,
    switches = "F T F T T T F"
  )
} )
```

## Create output directories

```{r BAYES_output}
sapply(winter_2019_mixnames, function(mix) {dir.create(paste0("../BAYES/Output/", mix))} )
```

# Summarize *BAYES* results

Summarize results for both the full 33 reporting groups, the 5 TBR groups, 3 TBR groups, and 2 TBR groups.

## 33 reporting groups

Create standard summary and save.
```{r winter_BAYES_summarise_33RG}
# full 33 reporting groups
EWint_2019_33RG_EstimatesStats <- 
  CustomCombineBAYESOutput.GCL(groupvec = 1:33, groupnames = GroupNames33, maindir = "../BAYES/Output", mixvec = winter_2019_mixnames[1:4],
                               prior = "", ext = "RGN", nchains = 5, burn = 0.5, alpha = 0.1, PosteriorOutput = FALSE)

LWint_2019_33RG_EstimatesStats <- 
  CustomCombineBAYESOutput.GCL(groupvec = 1:33, groupnames = GroupNames33, maindir = "../BAYES/Output", mixvec = winter_2019_mixnames[5:8],
                               prior = "", ext = "RGN", nchains = 5, burn = 0.5, alpha = 0.1, PosteriorOutput = FALSE)

# dir.create("../Estimates objects")
save_objects(c("EWint_2019_33RG_EstimatesStats", "LWint_2019_33RG_EstimatesStats"), "../Estimates objects")
```

Make in to tall tibble.
```{r winter_BAYES_33RG_tibble}
# make in to a tidy tibble (tall)
winter_2019_33RG_estimates.tdy <- 
  bind_rows(
    lapply(winter_2019_mixnames, function(mix) {  # loop over mixture names
      c(EWint_2019_33RG_EstimatesStats, LWint_2019_33RG_EstimatesStats)[[mix]] %>%  # for each matrix
        as_tibble(rownames = "group") %>%  # make tibble with rownames as group
        mutate(mixname = mix) %>%  # make column for mixname
        mutate(n_group = n_distinct(group))  # make column for number of groups
    } )
  ) %>% 
  gather(estimator, value, -mixname, -group, - n_group) %>%  # gather all estimators
  separate(mixname, c("mix", "year"), sep = "_", remove = FALSE) %>%  # extract mixture and year
  separate(mix, c("fishery", "quadrant"), sep = 5) %>%  # extract district and gear
  mutate(estimator = factor(estimator, c("mean", "sd", "5%", "95%", "median", "P=0", "GR"))) %>%  # factor for ordering
  mutate(group = factor(group, GroupNames33))  # factor for ordering

save_objects(c("winter_2019_33RG_estimates.tdy"), "../Estimates objects")
```

## Stratified estimate for 33 RG

Generate All Quad estimates for Early and Late Winter.
```{r winter_stratified_33RG}
EWint_2019_33RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = 1:33, groupnames = GroupNames33, maindir = "../BAYES/Output/", mixvec = winter_2019_mixnames[1:4], catchvec = c(1441, 68, 1878, 2520), newname = "EWintAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

LWint_2019_33RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = 1:33, groupnames = GroupNames33, maindir = "../BAYES/Output/", mixvec = winter_2019_mixnames[5:8], catchvec = c(3030, 543, 908, 1978), newname = "LWintAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

save_objects(c("EWint_2019_33RG_StratifiedEstimatesStats", "LWint_2019_33RG_StratifiedEstimatesStats"), "../Estimates objects")
```

Make in to tall tibble.
```{r winter_stratified_33RG_tibble}
# make in to a tidy tibble (tall)
winter_2019_33RG_stratified_estimates.tdy <- 
  bind_rows(
    lapply(c("EWintAllQuad_2019", "LWintAllQuad_2019"), function(mix) {  # loop over mixture names
      list("EWintAllQuad_2019" = EWint_2019_33RG_StratifiedEstimatesStats, 
           "LWintAllQuad_2019" = LWint_2019_33RG_StratifiedEstimatesStats)[[mix]] %>%  # for each matrix
        as_tibble(rownames = "group") %>%  # make tibble with rownames as group
        mutate(mixname = mix) %>%  # make column for mixname
        mutate(n_group = n_distinct(group))  # make column for number of groups
    } )
  ) %>% 
  gather(estimator, value, -mixname, -group, - n_group) %>%  # gather all estimators
  separate(mixname, c("mix", "year"), sep = "_", remove = FALSE) %>%  # extract mixture and year
  separate(mix, c("fishery", "quadrant"), sep = 5) %>%  # extract district and gear
  mutate(estimator = factor(estimator, c("mean", "sd", "5%", "95%", "median", "P=0", "GR"))) %>%  # factor for ordering
  mutate(group = factor(group, GroupNames33))  # factor for ordering

save_objects(c("winter_2019_33RG_stratified_estimates.tdy"), "../Estimates objects")
```

## 18 reporting groups

Create standard + stratified summaries and save.
```{r winter_BAYES_summarise_18RG}
# 18 reporting groups
EWint_2019_18RG_EstimatesStats <- 
  CustomCombineBAYESOutput.GCL(groupvec = GroupVec33RG_to18RG, groupnames = GroupNames18, maindir = "../BAYES/Output", mixvec = winter_2019_mixnames[1:4],
                               prior = "", ext = "RGN", nchains = 5, burn = 0.5, alpha = 0.1, PosteriorOutput = FALSE)

LWint_2019_18RG_EstimatesStats <- 
  CustomCombineBAYESOutput.GCL(groupvec = GroupVec33RG_to18RG, groupnames = GroupNames18, maindir = "../BAYES/Output", mixvec = winter_2019_mixnames[5:8],
                               prior = "", ext = "RGN", nchains = 5, burn = 0.5, alpha = 0.1, PosteriorOutput = FALSE)

# dir.create("../Estimates objects")
save_objects(c("EWint_2019_18RG_EstimatesStats", "LWint_2019_18RG_EstimatesStats"), "../Estimates objects")

# Stratified
EWint_2019_18RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to18RG, groupnames = GroupNames18, maindir = "../BAYES/Output/", mixvec = winter_2019_mixnames[1:4], catchvec = c(1441, 68, 1878, 2520), newname = "EWintAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

LWint_2019_18RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to18RG, groupnames = GroupNames18, maindir = "../BAYES/Output/", mixvec = winter_2019_mixnames[5:8], catchvec = c(3030, 543, 908, 1978), newname = "LWintAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

save_objects(c("EWint_2019_18RG_StratifiedEstimatesStats", "LWint_2019_18RG_StratifiedEstimatesStats"), "../Estimates objects")
```

## 8 reporting groups

Create standard + stratified summaries and save.
```{r winter_BAYES_summarise_8RG}
# 8 reporting groups
EWint_2019_8RG_EstimatesStats <- 
  CustomCombineBAYESOutput.GCL(groupvec = GroupVec33RG_to8RG, groupnames = GroupNames8, maindir = "../BAYES/Output", mixvec = winter_2019_mixnames[1:4],
                               prior = "", ext = "RGN", nchains = 5, burn = 0.5, alpha = 0.1, PosteriorOutput = FALSE)

LWint_2019_8RG_EstimatesStats <- 
  CustomCombineBAYESOutput.GCL(groupvec = GroupVec33RG_to8RG, groupnames = GroupNames8, maindir = "../BAYES/Output", mixvec = winter_2019_mixnames[5:8],
                               prior = "", ext = "RGN", nchains = 5, burn = 0.5, alpha = 0.1, PosteriorOutput = FALSE)

# dir.create("../Estimates objects")
save_objects(c("EWint_2019_8RG_EstimatesStats", "LWint_2019_8RG_EstimatesStats"), "../Estimates objects")

# Stratified
EWint_2019_8RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to8RG, groupnames = GroupNames8, maindir = "../BAYES/Output/", mixvec = winter_2019_mixnames[1:4], catchvec = c(1441, 68, 1878, 2520), newname = "EWintAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

LWint_2019_8RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to8RG, groupnames = GroupNames8, maindir = "../BAYES/Output/", mixvec = winter_2019_mixnames[5:8], catchvec = c(3030, 543, 908, 1978), newname = "LWintAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

save_objects(c("EWint_2019_8RG_StratifiedEstimatesStats", "LWint_2019_8RG_StratifiedEstimatesStats"), "../Estimates objects")
```

## 4 reporting groups

Create standard + stratified summaries and save.
```{r winter_BAYES_summarise_4RG}
# 4 reporting groups
EWint_2019_4RG_EstimatesStats <- 
  CustomCombineBAYESOutput.GCL(groupvec = GroupVec33RG_to4RG, groupnames = GroupNames4, maindir = "../BAYES/Output", mixvec = winter_2019_mixnames[1:4],
                               prior = "", ext = "RGN", nchains = 5, burn = 0.5, alpha = 0.1, PosteriorOutput = FALSE)

LWint_2019_4RG_EstimatesStats <- 
  CustomCombineBAYESOutput.GCL(groupvec = GroupVec33RG_to4RG, groupnames = GroupNames4, maindir = "../BAYES/Output", mixvec = winter_2019_mixnames[5:8],
                               prior = "", ext = "RGN", nchains = 5, burn = 0.5, alpha = 0.1, PosteriorOutput = FALSE)

# dir.create("../Estimates objects")
save_objects(c("EWint_2019_4RG_EstimatesStats", "LWint_2019_4RG_EstimatesStats"), "../Estimates objects")

# Stratified
EWint_2019_4RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to4RG, groupnames = GroupNames4, maindir = "../BAYES/Output/", mixvec = winter_2019_mixnames[1:4], catchvec = c(1441, 68, 1878, 2520), newname = "EWintAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

LWint_2019_4RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to4RG, groupnames = GroupNames4, maindir = "../BAYES/Output/", mixvec = winter_2019_mixnames[5:8], catchvec = c(3030, 543, 908, 1978), newname = "LWintAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

save_objects(c("EWint_2019_4RG_StratifiedEstimatesStats", "LWint_2019_4RG_StratifiedEstimatesStats"), "../Estimates objects")
```


# Spring troll: import mixture genotypes

Read in genotypes from *LOKI* as `.gcl` objects. Save in directory.
```{r spring_loki}
spring_2019_sillys <- c("KTROL19SP")
LOKI2R_GAPS.GCL(sillyvec = spring_2019_sillys, username = .username, password = .password)
rm(.username, .password)

sapply(spring_2019_sillys, function(silly) {get(paste0(silly, ".gcl"))$n} )

save_sillys(sillyvec = spring_2019_sillys, path = "../Genotypes/original")
save_objects(objects = c("spring_2019_sillys"), path = "../Objects/")
```

Reload genotypes.
```{r}
load_sillys(path = "../Genotypes/original/", sillyvec = spring_2019_sillys)
```


# Join ASL

## Spring Troll

Read in the spring troll ASL data **with District/Sub-District data from Iris**.
```{r spring_troll_asl, message=FALSE}
(asl_spring <- read_csv(file = "../Associated Data/Spring/2019 Spring Troll Chinook with Dist Sub Dist (version 1).csv") %>% 
   filter(!is.na(`Dna Specimen No`)))

# Any duplicate Dna Specimen No?
table(table(asl_spring$`Dna Specimen No`, useNA = "always"), useNA = "always")
```

Now how about duplicate Dna Specimen No?
```{r}
table(table(asl_spring$`Dna Specimen No`))
```

OMG, thank goodness. No more problems.

Are any of these fish in our spring troll samples?
```{r asl_duplicates_spring_troll}
spring_samples <- KTROL19SP.gcl$attributes %>% 
  mutate(`Dna Specimen No` = as.integer(paste0(str_sub(DNA_TRAY_CODE, 7, 10), str_pad(DNA_TRAY_WELL_CODE, 2, "left", "0")))) %>% 
  pull(`Dna Specimen No`)
```

Cool, none of our ASL duplicate Dna Specimen No are in there. Now verify that all spring samples are in the ASL data.
```{r spring_in_asl_check}
all(spring_samples %in% asl_spring$`Dna Specimen No`)
```

Fuck, not all of our genotyped samples appear in the ASL. How many are "missing"?
```{r spring_in_asl_table}
table(spring_samples %in% asl_spring$`Dna Specimen No`)
```

Crap, we have 7 fish that were genotyped, but not in the ASL. What gives? We should have solved this at extraction!
```{r}
(missing_fish <- setdiff(spring_samples, asl_spring$`Dna Specimen No`))
```

Went and checked the *extraction_list* notebook and it looks like these samples were all flagged there for ASL vs. LOKI discrepancies.

Change ASL to match what is in LOKI  
  * 4969 = 4696
  * 5743 = 5473
  * 25711 = 25710
```{r}
asl_spring <- asl_spring %>%
  mutate(`Dna Specimen No` = as.numeric(
    str_replace(
      string = as.character(`Dna Specimen No`),
      pattern = "4969",
      replacement = "4696"
    )
  )) %>%
  mutate(`Dna Specimen No` = as.numeric(
    str_replace(
      string = as.character(`Dna Specimen No`),
      pattern = "5743",
      replacement = "5473"
    )
  )) %>%
  mutate(`Dna Specimen No` = as.numeric(
    str_replace(
      string = as.character(`Dna Specimen No`),
      pattern = "25711",
      replacement = "25710"
    )
  ))
```

Now how about duplicate Dna Specimen No?
```{r}
table(table(asl_spring$`Dna Specimen No`))
```

Now verify that all spring samples are in the ASL data.
```{r spring_in_asl}
all(spring_samples %in% asl_spring$`Dna Specimen No`)
```

OMG, thank goodness. No more problems. Add additional columns.
```{r}
(asl_spring <- asl_spring %>% 
   mutate(`Sample Date` = mdy(`Sample Date`)) %>% 
   mutate(Year_f = factor(Year)) %>% 
   mutate(Fishery = case_when(Harvest == "Spring Troll Fishery" ~ "Spring")) %>% 
   mutate(Fishery = factor(Fishery, levels = c("Late Winter", "Spring", "Summer Ret 1", "Summer Ret 2", "Early Winter"))) %>% 
   mutate(Month = case_when(`Stat Week` <= 22 ~ "May",
                            `Stat Week` >= 23 ~ "June")) %>%  # update! anything SW22 and less is May
   mutate(Month = factor(Month, levels = c("May", "June"))) %>% 
   mutate(month = month(`Sample Date`, label = TRUE, abbr = FALSE)) %>% 
   mutate(subdistrict = str_pad(string = `Sub-District`, width = 2, side = "left", pad = "0")) %>% 
   unite("Stat Area", c(District, subdistrict), sep = '', remove = FALSE)
)
```

Save ASL.
```{r}
write_csv(x = asl_spring, path = "../ASL Data/spring_troll_samples_ASL.csv")
```

Now that we've resolved our ASL discrepancy, join with attributes to get quadrant level information.
```{r join_spring_asl}
# Join ASL with attributes table
KTROL19SP.gcl$attributes <- KTROL19SP.gcl$attributes %>% 
  mutate(`Dna Specimen No` = as.integer(paste0(str_sub(DNA_TRAY_CODE, 7, 10), str_pad(DNA_TRAY_WELL_CODE, 2, "left", "0")))) %>% 
  left_join(asl_spring, by = "Dna Specimen No") 
```

How many fish per Stat Area and Month?
```{r spring_district_counts}
KTROL19SP.gcl$attributes %>% 
  count(`Stat Area`, Month) %>% 
  spread(Month, n, fill = 0)
```


# Define mixture strata

Spring mixtures are each stat area and month by itself (except 113-30 and 183-10, which are combined for May and June). Use `case_when` to creat an attribute in the attributes table for mixture.
```{r spring_mixture_attribute}
KTROL19SP.gcl$attributes <- KTROL19SP.gcl$attributes %>% 
  mutate(mixname = case_when(`Stat Area` == "10145" & Month == "June" ~ "SpringRet2_10145_2019",
                             `Stat Area` == "10146" & Month == "June" ~ "SpringRet2_10146_2019",
                             `Stat Area` == "10350" & Month == "May" ~ "SpringRet1_10350_2019",
                             `Stat Area` == "10350" & Month == "June" ~ "SpringRet2_10350_2019",
                             `Stat Area` == "11301" & Month == "June" ~ "SpringRet2_11301_2019",
                             `Stat Area` == "11330" & Month == "May" ~ "SpringRet1_11330_2019",
                             `Stat Area` == "11330" & Month == "June" ~ "SpringRet2_11330_2019",
                             `Stat Area` == "11341" & Month == "May" ~ "SpringRet1_11341_2019",
                             `Stat Area` == "11341" & Month == "June" ~ "SpringRet2_11341_2019",
                             `Stat Area` == "11362" & Month == "May" ~ "SpringRet1_11362_2019",
                             `Stat Area` == "11362" & Month == "June" ~ "SpringRet2_11362_2019",
                             `Stat Area` == "18310" & Month == "May" ~ "SpringRet1_18310_2019",
                             `Stat Area` == "18310" & Month == "June" ~ "SpringRet2_18310_2019",
                             TRUE ~ as.character(NA)))

KTROL19SP.gcl$attributes %>% 
  count(mixname)
```

Create spring mixtures.
```{r spring_define_mixtures}
spring_2019_mixnames <- sort(unique(KTROL19SP.gcl$attributes$mixname))

sapply(spring_2019_mixnames, function(mixname) {
  ids <- setNames(object = list(AttributesToIDs.GCL(silly = "KTROL19SP", attribute = "mixname", matching = mixname)), nm = "KTROL19SP")
  PoolCollections.GCL(collections = "KTROL19SP", loci = GAPSLoci_reordered, IDs = ids, newname = mixname)
})

sapply(spring_2019_mixnames, function(silly) {get(paste0(silly, ".gcl"))$n} )
```

Save genotypes for spring strata.
```{r save_spring_strata_genotypes}
if(!dir.exists("../Genotypes/strata")) {dir.create("../Genotypes/strata")}

save_objects(objects = "spring_2019_mixnames", path = "../Objects/")
save_sillys(sillyvec = spring_2019_mixnames, path = "../Genotypes/strata/")
```

# Data QA

Standard data QA:

  * Remove fish missing <80% genotypes
  * Remove duplicates (>95% genotype concordance)

```{r spring_QA}
# original sample sizes
spring_2019_sample_sizes <- tibble(silly = spring_2019_mixnames,
                                   genotyped = sapply(spring_2019_mixnames, function(x) {
                                     get(paste0(x, ".gcl"))$n
                                   }))

# missing
spring_2019_missing <-
  RemoveIndMissLoci.GCL(sillyvec = spring_2019_mixnames, proportion = 0.8)

save_objects("spring_2019_missing", "../Objects/")

spring_2019_sample_sizes <- spring_2019_sample_sizes %>%
  mutate(missing = genotyped - sapply(spring_2019_mixnames, function(x) {
    get(paste0(x, ".gcl"))$n
  }))

# duplicate
spring_2019_duplicates <-
  CheckDupWithinSilly.GCL(
    sillyvec = spring_2019_mixnames,
    loci = GAPSLoci_reordered,
    quantile = NULL,
    minproportion = 0.95
  )

(spring_2019_duplicates_summary <-
    sapply(spring_2019_mixnames, function(x) {
      spring_2019_duplicates[[x]]$report
    }))

save_objects("spring_2019_duplicates_summary", "../Objects/")

spring_2019_duplciates_removed <-
  RemoveDups.GCL(dupcheck = spring_2019_duplicates)

spring_2019_sample_sizes <- spring_2019_sample_sizes %>%
  mutate(duplicate = genotyped - missing - sapply(spring_2019_mixnames, function(x) {
    get(paste0(x, ".gcl"))$n
  }))

# final
spring_2019_sample_sizes <- spring_2019_sample_sizes %>%
  mutate(final = sapply(spring_2019_mixnames, function(x) {
    get(paste0(x, ".gcl"))$n
  }))

spring_2019_sample_sizes

save_objects("spring_2019_sample_sizes", "../Objects/")

write_csv(spring_2019_sample_sizes,
          "../Tables/spring_2019_sample_sizes.csv")
```

Save post-QA genotypes
```{r spring_post_QA}
if(!dir.exists("../Genotypes/strata_postQA/")) {dir.create("../Genotypes/strata_postQA/")}
save_sillys(sillyvec = spring_2019_mixnames, path = "../Genotypes/strata_postQA")
```

# Create *BAYES* files

## Directory setup

First need to set up *BAYES* directory structure and copy over baseline file and *BAYES* objects. This was already done when we ran TBR.


## Create mixtures

Save the fortran format and create TBR *BAYES* mixture files. This was already done when we ran TBR.
```{r spring_BAYES_mixtures}
# mixfortran <- CreateMixture.GCL(sillys = TBR_sillys[1], loci = GAPSLoci_reordered, IDs = NULL, mixname = TBR_mixnames[TBR_sillys[1]], dir = "../BAYES/Mixture", type = "BAYES", PT = FALSE)
# save_objects("mixfortran", "../Objects/")

sapply(spring_2019_mixnames, function(mix) {
  CreateMixture.GCL(sillys = mix, loci = GAPSLoci_reordered, IDs = NULL, mixname = mix, dir = "../BAYES/Mixture", type = "BAYES", PT = FALSE)
} )
```

## Create priors

Get estimates from 2018 to set priors
```{r}
load_objects(path = "../../SEAK18/Estimates objects/", pattern = "spring_2018_33RG_estimates.tdy")
```

Spread out object in to a matrix with rows as reporting group and columns as mixture
```{r}
spring_2018_means_33RG <- spring_2018_33RG_estimates.tdy %>% 
  filter(estimator == "mean") %>% 
  select(group, mixname, value) %>% 
  spread(mixname, value) %>% 
  column_to_rownames("group") %>% 
  as.matrix()

dimnames(spring_2018_means_33RG)
```

What are 2019 mixtures?
```{r}
spring_2019_mixnames
```

Line up 2018 vs. 2019 mixtures for seeting priors
```{r}
cbind("2018" = colnames(spring_2018_means_33RG[, c(4, 1, 5, 10, 2, 3, 3, 7, 8, 1, 9, 10, 2)]), 
      "2019" = spring_2019_mixnames)
```

Create means for priors and rename to 2019 mixnames
```{r}
# Duplicate NISISO to NI, SI, SO
spring_2018_means_33RG <- spring_2018_means_33RG[, c(4, 1, 5, 10, 2, 3, 3, 7, 8, 1, 9, 10, 2)]

# Fix dimnames
colnames(spring_2018_means_33RG) <- spring_2019_mixnames

# Verify
apply(spring_2018_means_33RG, 2, sum)
```

Now create 2019 priors.
```{r spring_create_2019_priors}
spring_2019_priors <- apply(spring_2018_means_33RG, 2, function(mix) {
  Prior.GCL(groupvec = GroupVec33RG_357, groupweights = mix, minval = 0.01)
} )

colnames(spring_2019_priors) <- spring_2019_mixnames

save_objects("spring_2019_priors", "../Objects/")
```

## Create control files

Now that we have priors, just need to create *BAYES* control files.
```{r spring_BAYES_control}
sapply(spring_2019_mixnames, function(mix) {
  CreateControlFile.GCL(
    sillyvec = SEAKPops357,
    loci = GAPSLoci_reordered,
    mixname = mix,
    basename = "GAPS357pops13loci",
    suffix = "",
    nreps = 40000,
    nchains = 5,
    groupvec = GroupVec33RG_357,
    priorvec = spring_2019_priors[, mix],
    initmat = GAPS357PopsInits,
    dir = "../BAYES/Control",
    seeds = WASSIPSockeyeSeeds,
    thin = c(1, 1, 100),
    mixfortran = mixfortran,
    basefortran = bayesfortran_357,
    switches = "F T F T F T F"
  )
})
```

## Create output directories

```{r spring_BAYES_output}
sapply(spring_2019_mixnames, function(mix) {dir.create(paste0("../BAYES/Output/", mix))} )
```

## Running *BAYES*

Look at mixtures in order of sample size to maximize efficiency while I'm here.
```{r}
spring_2019_sample_sizes %>% 
  arrange(final)
```

# Summarize *BAYES* results

Summarize results for both the full 33 reporting groups, the 5 TBR groups, 3 TBR groups, and 2 TBR groups.

## 33 reporting groups

Create standard summary and save.
```{r spring_BAYES_summarise_33RG}
# full 33 reporting groups
Spring_2019_33RG_EstimatesStats <- 
  CustomCombineBAYESOutput.GCL(groupvec = 1:33, groupnames = GroupNames33, maindir = "../BAYES/Output", mixvec = spring_2019_mixnames,
                               prior = "", ext = "RGN", nchains = 5, burn = 0.5, alpha = 0.1, PosteriorOutput = FALSE)

# dir.create("../Estimates objects")
save_objects(c("Spring_2019_33RG_EstimatesStats"), "../Estimates objects")
```

Make in to tall tibble.
```{r spring_BAYES_33RG_tibble}
# make in to a tidy tibble (tall)
spring_2019_33RG_estimates.tdy <- 
  bind_rows(
    lapply(spring_2019_mixnames, function(mix) {  # loop over mixture names
      c(Spring_2019_33RG_EstimatesStats)[[mix]] %>%  # for each matrix
        as_tibble(rownames = "group") %>%  # make tibble with rownames as group
        mutate(mixname = mix) %>%  # make column for mixname
        mutate(n_group = n_distinct(group))  # make column for number of groups
    } )
  ) %>% 
  gather(estimator, value, -mixname, -group, - n_group) %>%  # gather all estimators
  separate(mixname, c("period", "stat_area", "year"), sep = "_", remove = FALSE) %>%  # extract mixture and year
  mutate(estimator = factor(estimator, c("mean", "sd", "5%", "95%", "median", "P=0", "GR"))) %>%  # factor for ordering
  mutate(group = factor(group, GroupNames33))  # factor for ordering

save_objects(c("spring_2019_33RG_estimates.tdy"), "../Estimates objects")
```

Check GR
```{r spring_GR}
spring_2019_33RG_estimates.tdy %>% 
  filter(estimator == "GR") %>% 
  filter(value > 1.2)
```

This is why we report to Interior Columbia Su/Fa, not to summer and fall separately.

## 5 reporting groups

Create standard summary and tall tibble, save both.
```{r BAYES_summarise_spring_5RG}
Spring_2019_5RG_EstimatesStats <- 
  CustomCombineBAYESOutput.GCL(groupvec = GroupVec5RG_THA_33, groupnames = GroupNames5_THA, maindir = "../BAYES/Output", 
                               mixvec = spring_2019_mixnames,
                               prior = "", ext = "RGN", nchains = 5, burn = 0.5, alpha = 0.1, PosteriorOutput = FALSE)

# make in to a tidy tibble (tall)
spring_2019_5RG_estimates.tdy <- 
  bind_rows(
    lapply(spring_2019_mixnames, function(mix) {  # loop over mixture names
      c(Spring_2019_5RG_EstimatesStats)[[mix]] %>%  # for each matrix
        as_tibble(rownames = "group") %>%  # make tibble with rownames as group
        mutate(mixname = mix) %>%  # make column for mixname
        mutate(n_group = n_distinct(group))  # make column for number of groups
    } )
  ) %>% 
  gather(estimator, value, -mixname, -group, - n_group) %>%  # gather all estimators
  separate(mixname, c("period", "stat_area", "year"), sep = "_", remove = FALSE) %>%  # extract mixture and year
  mutate(estimator = factor(estimator, c("mean", "sd", "5%", "95%", "median", "P=0", "GR"))) %>%  # factor for ordering
  mutate(group = factor(group, GroupNames5_THA))  # factor for ordering

save_objects(c("Spring_2019_5RG_EstimatesStats", "spring_2019_5RG_estimates.tdy"), "../Estimates objects")
```

# Harvest - Spring troll

Read in harvest data

```{r spring_harvest}
(spring_harvest <- read_csv(file = "../Harvest Data/20191021_ft - Detailed Fish Tickets.csv") %>% 
  mutate(Month = month(`Date Fishing Ended`, label = TRUE, abbr = FALSE)) %>% 
  group_by(District, `Stat Area`, Month) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)))
```

```{r spring_troll_figures, out.width="100%"}
spring_2019_33RG_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(mean > 0.05) %>% 
  arrange(mixname, desc(mean)) %>% 
  select(mixname, period, stat_area, mean, group) %>% 
  spread(group, mean, fill = 0)

spring_2019_33RG_estimates.tdy %>% 
  spread(estimator, value) %>% 
  # filter(stat_area == "10145") %>% 
  mutate(month = case_when(period == "SpringRet1" ~ "May",
                           period == "SpringRet2" ~ "June", 
                           period == "Spring" ~ "Spring")) %>% 
  mutate(month = factor(x = month, levels = month.name)) %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Spring Troll AY 2019") +
  facet_grid(stat_area ~ month)
```


# Summer troll: import mixture genotypes

Read in genotypes from *LOKI* as `.gcl` objects. Save in directory.
```{r summer_loki}
summer_2019_sillys <- c("KTROL19SU")
LOKI2R_GAPS.GCL(sillyvec = summer_2019_sillys, username = .username, password = .password)
rm(.username, .password)

sapply(summer_2019_sillys, function(silly) {get(paste0(silly, ".gcl"))$n} )

save_sillys(sillyvec = summer_2019_sillys, path = "../Genotypes/original")
save_objects(objects = c("summer_2019_sillys"), path = "../Objects/")
```

# Join ASL

## Summer Troll

Read in the troll ASL data.
```{r read_troll_asl, message=FALSE}
(
  troll_ASL <-
    read_csv(file = "../ASL Data/20191021_Detailed ASL Samples.csv") %>%
    select(
      Year,
      `Sample Date`,
      `Stat Week`,
      `Port Code`,
      `Gear`,
      `District`,
      `Dna Specimen No`,
      `Cwt Strap Tag No`,
      `Gear Code`,
      `Harvest Code`
    )
)

# Any duplicate Dna Specimen No?
table(table(troll_ASL$`Dna Specimen No`, useNA = "always"), useNA = "always")
```

Filter for just summer troll fish to avoid this maddness.
```{r}
(asl_summer <- troll_ASL %>% 
   mutate(Year_f = factor(Year)) %>% 
   dplyr::rename(Quadrant = District) %>% 
   mutate(Fishery = case_when(`Harvest Code` == 13 ~ "Spring",
                              `Harvest Code` == 11 & `Stat Week` <= 11 ~ "Late Winter",
                              `Harvest Code` == 11 & `Stat Week` >= 41 ~ "Early Winter",
                              `Harvest Code` == 11 & `Stat Week` >= 27 & `Stat Week` <= 31 ~ "Summer Ret 1",
                              `Harvest Code` == 11 & `Stat Week` >= 32 & `Stat Week` <= 36 ~ "Summer Ret 2")) %>% 
   mutate(Fishery = factor(Fishery, levels = c("Late Winter", "Spring", "Summer Ret 1", "Summer Ret 2", "Early Winter"))) %>% 
   filter(Year == 2019 & Fishery %in% c("Summer Ret 1", "Summer Ret 2"))
)
```

Now how about duplicate Dna Specimen No?
```{r}
table(table(asl_summer$`Dna Specimen No`))
```

Damnit why are there so many...
```{r summer_asl_duplicates}
asl_summer_duplicates <- asl_summer %>% 
  group_by(`Dna Specimen No`) %>% 
  summarise(n = n()) %>% 
  filter(n > 1) %>% 
  pull(`Dna Specimen No`)

asl_summer %>% 
  filter(`Dna Specimen No` %in% asl_summer_duplicates) %>% 
  arrange(`Dna Specimen No`)
```

Are any of these fish in our summer troll samples?
```{r asl_duplicates_summer_troll}
summer_samples <- KTROL19SU.gcl$attributes %>% 
  mutate(`Dna Specimen No` = as.integer(paste0(str_sub(DNA_TRAY_CODE, 7, 10), str_pad(DNA_TRAY_WELL_CODE, 2, "left", "0")))) %>%
  pull(`Dna Specimen No`)

table(summer_samples %in% asl_summer_duplicates)
```

Which ones?
```{r}
intersect(summer_samples, asl_summer_duplicates)
```

What are the duplicate cards? Which ports?
```{r}
asl_summer %>% 
  mutate(WGC_4digit = str_sub(string = `Dna Specimen No`, start = 1, end = 4)) %>% 
  filter(WGC_4digit %in% c("4199", "4210", "4204")) %>% 
  count(WGC_4digit, `Stat Week`, Quadrant, `Port Code`)
```

Issues for WGC 4199, 4204, and 4210, thes came up in Extraction!!!
After checking Iris' sheet, the 100000XXXX WGC are from Wrangell and the 000003XXXX WGC are from Ketchikan!
```{r}
asl_summer <- asl_summer %>%
  mutate(WGC_4digit = str_sub(string = `Dna Specimen No`, start = 1, end = 4)) %>%
  mutate(`Dna Specimen No` = case_when(
      WGC_4digit %in% c("4199", "4210", "4204") & `Port Code` == "KTN" ~ as.numeric(paste0(3, `Dna Specimen No`)),
      TRUE ~ `Dna Specimen No`
    )
  )
```

Did we fix ASL?
```{r}
table(table(asl_summer$`Dna Specimen No`))
table(nchar(asl_summer$`Dna Specimen No`))
```

Huzzah! Now to fix *LOKI*
```{r}
summer_samples <- KTROL19SU.gcl$attributes %>%
  mutate(`Dna Specimen No` = as.integer(paste0(
    str_sub(DNA_TRAY_CODE, 7, 10),
    str_pad(DNA_TRAY_WELL_CODE, 2, "left", "0")
  ))) %>%
  mutate(`Dna Specimen No` = case_when(
    DNA_TRAY_CODE %in% c("0000034199", "0000034204", "0000034210") ~ as.integer(paste0(3, `Dna Specimen No`)),
    TRUE ~ `Dna Specimen No`
  )) %>%
  pull(`Dna Specimen No`)
```

Did we fix *LOKI*?
```{r}
table(table(summer_samples))
table(nchar(summer_samples))
```

Cool, and all *LOKI* samples are in ASL?
```{r}
all(summer_samples %in% asl_summer$`Dna Specimen No`)
```

Ugh, which ones?
```{r}
setdiff(summer_samples, asl_summer$`Dna Specimen No`)
```

Ah right, we found this out in extraction. They got coded as 3900 in ASL.
```{r}
asl_summer <- asl_summer %>% 
  mutate(`Dna Specimen No` = as.numeric(str_replace(string = as.character(`Dna Specimen No`), pattern = "3900", replacement = "3904")))
```

Cool, and all *LOKI* samples are in ASL?
```{r}
all(summer_samples %in% asl_summer$`Dna Specimen No`)
```

Now that we've resolved our ASL discrepancy, join with attributes to get quadrant level information.
```{r join_summer_asl}
# Join ASL with attributes table
# Summer
KTROL19SU.gcl$attributes <- KTROL19SU.gcl$attributes %>%
  mutate(`Dna Specimen No` = as.integer(paste0(
    str_sub(DNA_TRAY_CODE, 7, 10),
    str_pad(DNA_TRAY_WELL_CODE, 2, "left", "0")
  ))) %>%
  mutate(`Dna Specimen No` = case_when(
    DNA_TRAY_CODE %in% c("0000034199", "0000034204", "0000034210") ~ as.integer(paste0(3, `Dna Specimen No`)),
    TRUE ~ `Dna Specimen No`
  )) %>%
  left_join(asl_summer, by = "Dna Specimen No")
```

How many fish per district?
```{r summer_district_counts}
KTROL19SU.gcl$attributes %>% 
  count(Quadrant, Fishery) %>% 
  spread(Fishery, n, fill = 0)
```

# Define mixture strata

Summer mixtures are each Quadrant and Period by itself. Use `case_when` to creat an attribute in the attributes table for mixture.
```{r summer_mixture_attribute}
KTROL19SU.gcl$attributes <- KTROL19SU.gcl$attributes %>% 
  mutate(mixname = case_when(Fishery == "Summer Ret 1" & Quadrant == 171 ~ "SummerRet1NO_2019",
                             Fishery == "Summer Ret 1" & Quadrant == 172 ~ "SummerRet1SO_2019",
                             Fishery == "Summer Ret 1" & Quadrant == 173 ~ "SummerRet1NI_2019",
                             Fishery == "Summer Ret 1" & Quadrant == 174 ~ "SummerRet1SI_2019",
                             Fishery == "Summer Ret 2" & Quadrant == 171 ~ "SummerRet2NO_2019",
                             Fishery == "Summer Ret 2" & Quadrant == 172 ~ "SummerRet2SO_2019",
                             Fishery == "Summer Ret 2" & Quadrant == 173 ~ "SummerRet2NI_2019",
                             Fishery == "Summer Ret 2" & Quadrant == 174 ~ "SummerRet2SI_2019",
                             TRUE ~ as.character(NA)))

KTROL19SU.gcl$attributes %>% 
  count(mixname)
```

Create summer mixtures.
```{r summer_define_mixtures}
summer_2019_mixnames <- c(paste0("SummerRet1", c("NO", "SO", "NI", "SI"), "_2019"), 
                          paste0("SummerRet2", c("NO", "SO", "NI", "SI"), "_2019"))

sapply(summer_2019_mixnames, function(mixname) {
  ids <- setNames(object = list(AttributesToIDs.GCL(silly = "KTROL19SU", attribute = "mixname", matching = mixname)), nm = "KTROL19SU")
  PoolCollections.GCL(collections = "KTROL19SU", loci = GAPSLoci_reordered, IDs = ids, newname = mixname)
})

sapply(summer_2019_mixnames, function(silly) {get(paste0(silly, ".gcl"))$n} )
```

Save genotypes for summer strata.
```{r save_summer_strata_genotypes}
if(!dir.exists("../Genotypes/strata")) {dir.create("../Genotypes/strata")}

save_objects(objects = "summer_2019_mixnames", path = "../Objects/")
save_sillys(sillyvec = summer_2019_mixnames, path = "../Genotypes/strata/")
```

# Data QA

Standard data QA:

  * Remove fish missing <80% genotypes
  * Remove duplicates (>95% genotype concordance)

```{r summer_QA}
# original sample sizes
summer_2019_sample_sizes <- tibble(silly = summer_2019_mixnames,
                                   genotyped = sapply(summer_2019_mixnames, function(x) {
                                     get(paste0(x, ".gcl"))$n
                                   }))

# missing
summer_2019_missing <-
  RemoveIndMissLoci.GCL(sillyvec = summer_2019_mixnames, proportion = 0.8)

save_objects("summer_2019_missing", "../Objects/")

summer_2019_sample_sizes <- summer_2019_sample_sizes %>%
  mutate(missing = genotyped - sapply(summer_2019_mixnames, function(x) {
    get(paste0(x, ".gcl"))$n
  }))

# duplicate
summer_2019_duplicates <-
  CheckDupWithinSilly.GCL(
    sillyvec = summer_2019_mixnames,
    loci = GAPSLoci_reordered,
    quantile = NULL,
    minproportion = 0.95
  )

(summer_2019_duplicates_summary <-
    sapply(summer_2019_mixnames, function(x) {
      summer_2019_duplicates[[x]]$report
    }))

save_objects("summer_2019_duplicates_summary", "../Objects/")

summer_2019_duplciates_removed <-
  RemoveDups.GCL(dupcheck = summer_2019_duplicates)

summer_2019_sample_sizes <- summer_2019_sample_sizes %>%
  mutate(duplicate = genotyped - missing - sapply(summer_2019_mixnames, function(x) {
    get(paste0(x, ".gcl"))$n
  }))

# final
summer_2019_sample_sizes <- summer_2019_sample_sizes %>%
  mutate(final = sapply(summer_2019_mixnames, function(x) {
    get(paste0(x, ".gcl"))$n
  }))

summer_2019_sample_sizes

save_objects("summer_2019_sample_sizes", "../Objects/")

write_csv(summer_2019_sample_sizes,
          "../Tables/summer_2019_sample_sizes.csv")
```

Save post-QA genotypes
```{r summer_post_QA}
if(!dir.exists("../Genotypes/strata_postQA/")) {dir.create("../Genotypes/strata_postQA/")}
save_sillys(sillyvec = summer_2019_mixnames, path = "../Genotypes/strata_postQA")
```

# Create *BAYES* files

## Directory setup

First need to set up *BAYES* directory structure and copy over baseline file and *BAYES* objects. This was already done when we ran TBR.
```{r summer_BAYES_setup, results='hide'}
# dir.create(path = "../BAYES")
# sapply(c("Baseline", "Control", "Mixture", "Output"), function(folder) {dir.create(path = paste("../BAYES", folder, sep = "/"))} )
# 
# file.copy(from = "V:/Analysis/1_SEAK/Chinook/Baseline/GAPS3.0/Objects/SEAKPops357.txt", to = "../Objects")
# file.copy(from = "V:/Analysis/1_SEAK/Chinook/Baseline/GAPS3.0/Objects/bayesfortran_357.txt", to = "../Objects")
# file.copy(from = "V:/Analysis/1_SEAK/Chinook/Baseline/GAPS3.0/BAYES/Baseline/GAPS357pops13loci.bse", to = "../BAYES/Baseline")
# file.copy(from = "V:/Analysis/4_Westward/Sockeye/KMA Commercial Harvest 2014-2016/Mixtures/Objects/WASSIPSockeyeSeeds.txt", to = "../Objects")
# 
# TBR_mixnames <- setNames(c("D108Gill_2019", "D111Gill_2019", "D111Sport_2019"), TBR_sillys)
# save_objects("TBR_mixnames", "../Objects/")
# load_objects("../Objects/")
```

## Create mixtures

Save the fortran format and create TBR *BAYES* mixture files. This was already done when we ran TBR.
```{r summer_BAYES_mixtures}
# mixfortran <- CreateMixture.GCL(sillys = TBR_sillys[1], loci = GAPSLoci_reordered, IDs = NULL, mixname = TBR_mixnames[TBR_sillys[1]], dir = "../BAYES/Mixture", type = "BAYES", PT = FALSE)
# save_objects("mixfortran", "../Objects/")

sapply(summer_2019_mixnames, function(mix) {
  CreateMixture.GCL(sillys = mix, loci = GAPSLoci_reordered, IDs = NULL, mixname = mix, dir = "../BAYES/Mixture", type = "BAYES", PT = FALSE)
} )
```

## Create priors

Use last year's 33RG estimates
```{r summer_read_2018_estimates}
load_objects(path = "../../SEAK18/Estimates objects/", pattern = "SummerRet1_2018_33RG_EstimatesStats.txt")
load_objects(path = "../../SEAK18/Estimates objects/", pattern = "SummerRet2_2018_33RG_EstimatesStats.txt")

(summer_2018_means <- sapply(c(SummerRet1_2018_33RG_EstimatesStats, SummerRet2_2018_33RG_EstimatesStats), function(mix) {mix[, "mean"]}))
```

Change names
```{r summer_setup_2019_priors}
# Fix dimnames
colnames(summer_2018_means) <- str_replace(string = colnames(summer_2018_means), pattern = "2018", replacement = "2019")

# Verify
apply(summer_2018_means, 2, sum)
```

Now create 2019 priors.
```{r summer_create_2019_priors}
summer_2019_priors <- apply(summer_2018_means, 2, function(mix) {
  Prior.GCL(groupvec = GroupVec33RG_357, groupweights = mix, minval = 0.01)
} )
colnames(summer_2019_priors) <- str_replace(string = colnames(summer_2019_priors), pattern = "2018", replacement = "2019")
save_objects("summer_2019_priors", "../Objects/")
```

## Create control files

Now that we have priors, just need to create *BAYES* control files.
```{r summer_BAYES_control}
sapply(summer_2019_mixnames, function(mix) {
  CreateControlFile.GCL(
    sillyvec = SEAKPops357,
    loci = GAPSLoci_reordered,
    mixname = mix,
    basename = "GAPS357pops13loci",
    suffix = "",
    nreps = 40000,
    nchains = 5,
    groupvec = GroupVec33RG_357,
    priorvec = summer_2019_priors[, mix],
    initmat = GAPS357PopsInits,
    dir = "../BAYES/Control",
    seeds = WASSIPSockeyeSeeds,
    thin = c(1, 1, 100),
    mixfortran = mixfortran,
    basefortran = bayesfortran_357,
    switches = "F T F T F T F"
  )
} )
```

## Create output directories

```{r summer_BAYES_output}
sapply(summer_2019_mixnames, function(mix) {dir.create(paste0("../BAYES/Output/", mix))} )
```


# Summarize *BAYES* results

Summarize results for both the full 33 reporting groups, the 5 TBR groups.

## 33 reporting groups

Create standard summary and save.
```{r summer_BAYES_summarise_33RG}
# full 33 reporting groups
SummerRet1_2019_33RG_EstimatesStats <-
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:33,
    groupnames = GroupNames33,
    maindir = "../BAYES/Output",
    mixvec = summer_2019_mixnames[1:4],
    prior = "",
    ext = "RGN",
    nchains = 5,
    burn = 0.5,
    alpha = 0.1,
    PosteriorOutput = FALSE
  )
SummerRet2_2019_33RG_EstimatesStats <-
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:33,
    groupnames = GroupNames33,
    maindir = "../BAYES/Output",
    mixvec = summer_2019_mixnames[5:8],
    prior = "",
    ext = "RGN",
    nchains = 5,
    burn = 0.5,
    alpha = 0.1,
    PosteriorOutput = FALSE
  )

Summer_2019_33RG_EstimatesStats <-
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:33,
    groupnames = GroupNames33,
    maindir = "../BAYES/Output",
    mixvec = summer_2019_mixnames,
    prior = "",
    ext = "RGN",
    nchains = 5,
    burn = 0.5,
    alpha = 0.1,
    PosteriorOutput = FALSE
  )

# dir.create("../Estimates objects")
save_objects(
  c(
    "SummerRet1_2019_33RG_EstimatesStats",
    "SummerRet2_2019_33RG_EstimatesStats",
    "Summer_2019_33RG_EstimatesStats"
  ),
  "../Estimates objects"
)
```

Make in to tall tibble.
```{r summer_BAYES_33RG_tibble}
# make in to a tidy tibble (tall)
summer_2019_33RG_estimates.tdy <- 
  bind_rows(
    lapply(summer_2019_mixnames, function(mix) {  # loop over mixture names
      c(Summer_2019_33RG_EstimatesStats)[[mix]] %>%  # for each matrix
        as_tibble(rownames = "group") %>%  # make tibble with rownames as group
        mutate(mixname = mix) %>%  # make column for mixname
        mutate(n_group = n_distinct(group))  # make column for number of groups
    } )
  ) %>% 
  gather(estimator, value, -mixname, -group, - n_group) %>%  # gather all estimators
  separate(mixname, c("mix", "year"), sep = "_", remove = FALSE) %>%  # extract mixture and year
  separate(mix, c("fishery", "quadrant"), sep = 10) %>%  # extract district and gear
  mutate(estimator = factor(estimator, c("mean", "sd", "5%", "95%", "median", "P=0", "GR"))) %>%  # factor for ordering
  mutate(group = factor(group, GroupNames33))  # factor for ordering

save_objects(c("summer_2019_33RG_estimates.tdy"), "../Estimates objects")
```

Check GR
```{r summer_GR}
summer_2019_33RG_estimates.tdy %>% 
  filter(estimator == "GR") %>% 
  filter(value > 1.2)
```
This is why we report to Interior Columbia Su/Fa, not to summer and fall separately.


# Sport: import mixture genotypes

Read in genotypes from *LOKI* as `.gcl` objects. Save in directory.
```{r sport_loki}
sport_2019_sillys <- c("KSPORT19")
LOKI2R_GAPS.GCL(sillyvec = sport_2019_sillys, username = .username, password = .password)
rm(.username, .password)

sapply(sport_2019_sillys, function(silly) {get(paste0(silly, ".gcl"))$n} )

save_sillys(sillyvec = sport_2019_sillys, path = "../Genotypes/original")
save_objects(objects = c("sport_2019_sillys"), path = "../Objects/")
```

# Join ASL

## Sport

Read in the sport ASL data.
```{r sport_asl, message=FALSE}
(sport_ASL <- read_csv(file = "../ASL Data/_2019_SEAK_SF_Whatman_AWL_03OCT19.csv") %>% 
   select(Year, SITE, DATE, BIWEEK, STATWEEK, SPECCODE, LENGTH, Whatman_Card, SAMPLE_NO, Adipose_Clipped, DISTRICT, STAT_AREA, Stat_Area_label) %>% 
   mutate(WGC = str_pad(Whatman_Card, 10, "left", "0")) %>% 
   unite(fish_id, c("WGC", "SAMPLE_NO"), sep = "_", remove = FALSE) %>% 
   filter(SPECCODE == 410) %>%
   filter(!is.na(SAMPLE_NO)) %>%
   mutate(site = factor(SITE, c("JUNEAU", "KETCHIKAN", "WRANGELL", "PETERSBURG", "SITKA", "CRAIG_KLAWOCK", "GUSTAVUS", "ELFIN_COVE", "YAKUTAT"))) %>% 
   dplyr::rename(biweek = BIWEEK) %>% 
   mutate(fishery = case_when(site == "KETCHIKAN" ~ "KTN",
                              site %in% c("PETERSBURG", "WRANGELL") ~ "PB-WR",
                              site == "JUNEAU" ~ "Inside",
                              site %in% c("YAKUTAT", "GUSTAVUS", "ELFIN_COVE", "SITKA", "CRAIG_KLAWOCK") & biweek <= 13 ~ "Outside_early",
                              site %in% c("YAKUTAT", "GUSTAVUS", "ELFIN_COVE", "SITKA", "CRAIG_KLAWOCK") & biweek > 13 ~ "Outside_late")) %>% 
   mutate(fishery = factor(fishery, levels = c("KTN", "PB-WR", "Inside", "Outside_early", "Outside_late")))
)

# Any duplicate Dna Specimen No?
table(table(sport_ASL$fish_id, useNA = "always"), useNA = "always")
```

No duplicates, great. Get the fish_id for the fish we ran and verify that all sport samples are in the ASL data.
```{r sport_in_asl}
sport_samples <- KSPORT19.gcl$attributes %>% 
  unite(fish_id, c("DNA_TRAY_CODE", "DNA_TRAY_WELL_CODE"), sep = "_", remove = FALSE) %>% 
  pull(fish_id)

all(sport_samples %in% sport_ASL$fish_id)

setdiff(sport_samples, sport_ASL$fish_id)
```

Crap, just one fish.
```{r}
sport_ASL %>% 
  filter(Whatman_Card == 30769)
```

Huh, fish 1 is missing...
```{r}
read_csv(file = "../ASL Data/_2019_SEAK_SF_Whatman_AWL_03OCT19.csv") %>% 
  filter(Whatman_Card == 30769)
```

Whoops, looks like that fish was a 411, wil lhave to exclude that one.

Excellent, all samples accounted for (except for the one 411)!!

Join with attributes to get port and biweek level information.
```{r join_sport_asl}
# Join ASL with attributes table
# Sport
KSPORT19.gcl$attributes <- KSPORT19.gcl$attributes %>% 
  unite(fish_id, c("DNA_TRAY_CODE", "DNA_TRAY_WELL_CODE"), sep = "_", remove = FALSE) %>% 
  left_join(sport_ASL, by = "fish_id")
```

How many fish per Port and Biweek?
```{r sport_stat_area_counts}
KSPORT19.gcl$attributes %>% 
  count(site, biweek) %>% 
  spread(site, n, fill = 0)
```

Looks good! Lost some fish in the genotyping process, but not too many.

# Define mixture strata

## Simple mixtures

Sport mixtures are by port and biweek, some mixtures are overlapping. Use `case_when` to creat an attribute in the attributes table for "simple" mixtures. Verify samples per biweek by cross checking with ExtractionLists.R. **Note** can't have mixname for other = NA, it messes up `AttributesToIDs`.
```{r sport_mixture_attribute}
KSPORT19.gcl$attributes <- KSPORT19.gcl$attributes %>% 
  mutate(mixname = case_when(site == "CRAIG_KLAWOCK" ~ "CRGSport_2019",
                             site == "SITKA" ~ "SITSport_2019",
                             site == "KETCHIKAN" ~ "KTNSport_2019",
                             TRUE ~ "complex_mixture"))

KSPORT19.gcl$attributes %>% 
  count(mixname)
```

We lost some Craig, Ketchikan, and Sitka fish during genotyping, but not enough to redefine the mixtures. These should be good to go.

Create sport mixtures.
```{r sport_define_mixtures}
sport_2019_mixnames <- sort(unique(KSPORT19.gcl$attributes$mixname))[-1]

sapply(sport_2019_mixnames, function(mixname) {
  ids <- setNames(object = list(AttributesToIDs.GCL(silly = "KSPORT19", attribute = "mixname", matching = mixname)), nm = "KSPORT19")
  PoolCollections.GCL(collections = "KSPORT19", loci = GAPSLoci_reordered, IDs = ids, newname = mixname)
})

sapply(sport_2019_mixnames, function(silly) {get(paste0(silly, ".gcl"))$n} )
```

Save genotypes for sport strata.
```{r save_sport_strata_genotypes}
if(!dir.exists("../Genotypes/strata")) {dir.create("../Genotypes/strata")}

# save_objects(objects = "sport_2019_mixnames", path = "../Objects/")
save_sillys(sillyvec = sport_2019_mixnames, path = "../Genotypes/strata/")
```

## Complex mixtures

Need to thin out PBG/WRN + Inside (too many fish run for TBR), also need to thin SIT and CRG for Outside Period 1 and 2.

Get harvest information and join with ASL in order to recreate what was used in ExtractionLists.R

```{r sport_asl_harvest_join}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Read in ASL data
asl_sport <- read_csv(file = "../ASL Data/_2019_SEAK_SF_Whatman_AWL_03OCT19.csv")

#~~~~~~~~~~~~~~~~~~
## Manipulate ASL data
# Filter for just species 410 (legal), only DNA sampled
asl_sport <- asl_sport %>% 
  filter(SPECCODE == 410) %>% 
  filter(!is.na(SAMPLE_NO))

# Make SITE a factor for ordering purposes
asl_sport <- asl_sport %>% 
  mutate(site = factor(SITE, c("JUNEAU", "KETCHIKAN", "WRANGELL", "PETERSBURG", "SITKA", "CRAIG_KLAWOCK", "GUSTAVUS", "ELFIN_COVE", "YAKUTAT"))) %>% 
  dplyr::rename(biweek = BIWEEK)

# Create a variable for Fishery
asl_sport <- asl_sport %>% 
  mutate(fishery = case_when(site == "KETCHIKAN" ~ "KTN",
                             site %in% c("PETERSBURG", "WRANGELL") ~ "PB-WR",
                             site == "JUNEAU" ~ "Inside",
                             site %in% c("YAKUTAT", "GUSTAVUS", "ELFIN_COVE", "SITKA", "CRAIG_KLAWOCK") & biweek <= 13 ~ "Outside_early",
                             site %in% c("YAKUTAT", "GUSTAVUS", "ELFIN_COVE", "SITKA", "CRAIG_KLAWOCK") & biweek > 13 ~ "Outside_late")) %>% 
  mutate(fishery = factor(fishery, levels = c("KTN", "PB-WR", "Inside", "Outside_early", "Outside_late")))

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Read in Harvest data
# By Site and Biweek
harvest_sport <- read_csv(file = "../Harvest Data/preliminary_2019_sport_harvest_chinook.csv")

#~~~~~~~~~~~~~~~~~~
## Manipulate harvest data
# Make data tall (tidy), recode sites to ALL CAPS
level_key <- list("Juneau" = "JUNEAU", 
                  "Ketchikan" = "KETCHIKAN", 
                  "Wrangell" = "WRANGELL", 
                  "Petersburg" = "PETERSBURG", 
                  "Sitka" = "SITKA", 
                  "Craig" = "CRAIG_KLAWOCK", 
                  "Gustavus" = "GUSTAVUS", 
                  "Elfin Cove" = "ELFIN_COVE", 
                  "Yakutat" = "YAKUTAT")

harvest_sport <- harvest_sport %>% 
  gather(site, harvest, -biweek) %>% 
  mutate(site = recode_factor(site, !!!level_key, .ordered = TRUE))

# Create a variable for Fishery
harvest_sport <- harvest_sport %>% 
  mutate(fishery = case_when(site == "KETCHIKAN" ~ "KTN",
                             site %in% c("PETERSBURG", "WRANGELL") ~ "PB-WR",
                             site == "JUNEAU" ~ "Inside",
                             site %in% c("YAKUTAT", "GUSTAVUS", "ELFIN_COVE", "SITKA", "CRAIG_KLAWOCK") & biweek <= 13 ~ "Outside_early",
                             site %in% c("YAKUTAT", "GUSTAVUS", "ELFIN_COVE", "SITKA", "CRAIG_KLAWOCK") & biweek > 13 ~ "Outside_late")) %>% 
  mutate(fishery = factor(fishery, levels = c("KTN", "PB-WR", "Inside", "Outside_early", "Outside_late")))

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Join ASL and Harvest data by Site and Biweek
# Roll up ASL to biweek and site level, join with harvest
join_sport <- asl_sport %>% 
  count(site, biweek) %>% 
  full_join(harvest_sport, by = c("site", "biweek")) %>%  # very important to do a full join in case some weeks are missing harvest or samples
  replace_na(list(n = 0, harvest = 0))  # replace NA in samples and harvest with 0
```

### Inside

What was the plan (i.e. ideal mixture sample size per biweek)?
```{r sport_inside_mixture_ideal}
# What does proportional sampling look like?
(extraction_JNU <- join_sport %>% 
   filter(site == "JUNEAU") %>% 
   arrange(biweek) %>% 
   mutate(p_harvest = round(harvest / sum(harvest) * 331)) %>%  # if we want 331 samples proportional to harvest by SW
   mutate(n_sufficeint = n >= p_harvest) %>% 
   mutate(n_remainings = n - p_harvest) %>% 
   mutate(n_extract = pmin(n, p_harvest)) %>% 
   select(site, biweek, n_extract))
```

What do we have (i.e. how many fish per biweek made it through genotypeing)? Make adjustments
```{r sport_inside_mixture_n}
(selection_JNU <- KSPORT19.gcl$attributes %>% 
  filter(site == "JUNEAU") %>% 
  count(site, biweek) %>% 
  right_join(extraction_JNU, by = c("site", "biweek")) %>% 
  replace_na(list(n = 0)) %>% 
  mutate(diff = n - n_extract) %>% 
  mutate(n_select = pmin(n, n_extract)))
```

Pick fish and create mixture.
```{r sport_inside_mixture_create}
ids_inside <- KSPORT19.gcl$attributes %>% 
  filter(site == "JUNEAU") %>% 
  nest(-biweek, -site) %>% 
  right_join(filter(selection_JNU, n_select > 0), by = c("site", "biweek")) %>% 
  mutate(sample = map2(data, n_select, sample_n)) %>% 
  unnest(sample) %>% 
  mutate(ids = as.character(FK_FISH_ID)) %>% 
  pull(ids)

ids_inside <- list("KSPORT19" = ids_inside)

PoolCollections.GCL(collections = "KSPORT19", loci = GAPSLoci_reordered, IDs = ids_inside, newname = "InsideSport_2019")
```

Verify that we picked fish appropriately.
```{r sport_inside_mixture_verify}
InsideSport_2019.gcl$attributes %>% 
  count(biweek)
```

Save genotypes for sport strata.
```{r save_sport_inside_strata_genotypes}
save_sillys(sillyvec = "InsideSport_2019", path = "../Genotypes/strata/")
```

### PBG/WRN

What was the plan (i.e. ideal mixture sample size per biweek)?
```{r sport_PBGWRN_mixture_ideal}
# What does proportional sampling look like?
(extraction_PBGWRN <- join_sport %>% 
   filter(site %in% c("PETERSBURG", "WRANGELL")) %>% 
   arrange(biweek) %>% 
   mutate(p_harvest = round(harvest / sum(harvest) * 100)) %>%  # if we want 100 samples proportional to harvest by SW
   mutate(n_sufficeint = n >= p_harvest) %>% 
   mutate(n_remainings = n - p_harvest) %>% 
   mutate(n_extract = pmin(n, p_harvest)) %>% 
   select(site, biweek, n_extract))
```

What do we have (i.e. how many fish per biweek made it through genotypeing)? Make adjustments
```{r sport_PBGWRN_mixture_n}
(selection_PBGWRN <- KSPORT19.gcl$attributes %>% 
  filter(site %in% c("PETERSBURG", "WRANGELL")) %>% 
  count(site, biweek) %>% 
  right_join(extraction_PBGWRN, by = c("site", "biweek")) %>% 
  replace_na(list(n = 0)) %>% 
  mutate(diff = n - n_extract) %>% 
  mutate(n_select = pmin(n, n_extract))) %>% 
  arrange(site, biweek)
```

Pick fish and create mixture.
```{r sport_PBGWRN_mixture_create}
ids_PBGWRN <- KSPORT19.gcl$attributes %>% 
  filter(site %in% c("PETERSBURG", "WRANGELL")) %>% 
  nest(-site, -biweek) %>% 
  right_join(filter(selection_PBGWRN, n_select > 0), by = c("site", "biweek")) %>% 
  mutate(sample = map2(data, n_select, sample_n)) %>% 
  unnest(sample) %>% 
  mutate(ids = as.character(FK_FISH_ID)) %>% 
  pull(ids)

ids_PBGWRN <- list("KSPORT19" = ids_PBGWRN)

PoolCollections.GCL(collections = "KSPORT19", loci = GAPSLoci_reordered, IDs = ids_PBGWRN, newname = "PBGWRNSport_2019")
```

Verify that we picked fish appropriately.
```{r sport_PBGWRN_mixture_verify}
PBGWRNSport_2019.gcl$attributes %>% 
  count(site, biweek) %>% 
  spread(site, n, fill = 0)
```

Save genotypes for sport strata.
```{r save_sport_PBGWRN_strata_genotypes}
save_sillys(sillyvec = "PBGWRNSport_2019", path = "../Genotypes/strata/")
```

### OutsidePer1

What was the plan (i.e. ideal mixture sample size per biweek)?
```{r sport_OutsidePer1_mixture_ideal}
# What does proportional sampling look like?
extraction_OutsidePer1 <- join_sport %>% 
  filter(fishery == "Outside_early") %>% 
  arrange(biweek) %>% 
  mutate(p_harvest = round(harvest / sum(harvest) * 1061)) %>%  # if we want 1061 samples proportional to harvest by SW
  mutate(n_sufficeint = n >= p_harvest) %>% 
  mutate(n_remainings = n - p_harvest) %>% 
  mutate(n_extract = pmin(n, p_harvest)) %>% 
  select(site, biweek, n_extract)

extraction_OutsidePer1 %>% 
  spread(site, n_extract)
```

What do we have (i.e. how many fish per biweek made it through genotypeing)? Make adjustments
```{r sport_OutsidePer1_mixture_n}
(selection_OutsidePer1 <- KSPORT19.gcl$attributes %>% 
  filter(fishery == "Outside_early") %>% 
  count(site, biweek) %>% 
  right_join(extraction_OutsidePer1, by = c("site", "biweek")) %>% 
  replace_na(list(n = 0)) %>% 
  mutate(diff = n - n_extract) %>% 
  mutate(n_select = pmin(n, n_extract))) %>% 
  arrange(site, biweek)
```

Minor adjustments
```{r}
(selection_OutsidePer1 <- selection_OutsidePer1 %>% 
   mutate(n_select = case_when(site == "ELFIN_COVE" & biweek == 12 ~ n,
                               TRUE ~ n_select))
)
```

Pick fish and create mixture.
```{r sport_OutsidePer1_mixture_create}
ids_OutsidePer1 <- KSPORT19.gcl$attributes %>% 
  filter(fishery == "Outside_early") %>% 
  nest(-site, -biweek) %>% 
  right_join(filter(selection_OutsidePer1, n_select > 0), by = c("site", "biweek")) %>% 
  mutate(sample = map2(data, n_select, sample_n)) %>% 
  unnest(sample) %>% 
  mutate(ids = as.character(FK_FISH_ID)) %>% 
  pull(ids)

ids_OutsidePer1 <- list("KSPORT19" = ids_OutsidePer1)

PoolCollections.GCL(collections = "KSPORT19", loci = GAPSLoci_reordered, IDs = ids_OutsidePer1, newname = "OutsidePer1Sport_2019")
```

Verify that we picked fish appropriately.
```{r sport_OutsidePer1_mixture_verify}
OutsidePer1Sport_2019.gcl$attributes %>% 
  count(site, biweek) %>% 
  spread(site, n, fill = 0)
```

Save genotypes for sport strata.
```{r save_sport_OutsidePer1_strata_genotypes}
save_sillys(sillyvec = "OutsidePer1Sport_2019", path = "../Genotypes/strata/")
```

### OutsidePer2

What was the plan (i.e. ideal mixture sample size per biweek)?
```{r sport_OutsidePer2_mixture_ideal}
# What does proportional sampling look like?
extraction_OutsidePer2 <- join_sport %>% 
  filter(fishery == "Outside_late") %>% 
  arrange(biweek) %>% 
  mutate(p_harvest = round(harvest / sum(harvest) * 543)) %>%  # if we want 543 samples proportional to harvest by SW
  mutate(n_sufficeint = n >= p_harvest) %>% 
  mutate(n_remainings = n - p_harvest) %>% 
  mutate(n_extract = pmin(n, p_harvest)) %>% 
  select(site, biweek, n_extract)

extraction_OutsidePer2 %>% 
  spread(site, n_extract)
```

What do we have (i.e. how many fish per biweek made it through genotypeing)? Make adjustments
```{r sport_OutsidePer2_mixture_n}
(selection_OutsidePer2 <- KSPORT19.gcl$attributes %>% 
  filter(fishery == "Outside_late") %>% 
  count(site, biweek) %>% 
  right_join(extraction_OutsidePer2, by = c("site", "biweek")) %>% 
  replace_na(list(n = 0)) %>% 
  mutate(diff = n - n_extract) %>% 
  mutate(n_select = pmin(n, n_extract))) %>% 
  arrange(site, biweek)
```

Minor adjustments to reallocate those missing 8 fish from Sitka in BW 16
```{r}
(selection_OutsidePer2 <- selection_OutsidePer2 %>% 
   mutate(n_select = case_when(site == "SITKA" & biweek == 15 ~ n_select + 4,
                               site == "SITKA" & biweek == 17 ~ n_select + 4,
                               TRUE ~ n_select))
)
```

Pick fish and create mixture.
```{r sport_OutsidePer2_mixture_create}
ids_OutsidePer2 <- KSPORT19.gcl$attributes %>% 
  filter(fishery == "Outside_late") %>% 
  nest(-site, -biweek) %>% 
  right_join(filter(selection_OutsidePer2, n_select > 0), by = c("site", "biweek")) %>% 
  mutate(sample = map2(data, n_select, sample_n)) %>% 
  unnest(sample) %>% 
  mutate(ids = as.character(FK_FISH_ID)) %>% 
  pull(ids)

ids_OutsidePer2 <- list("KSPORT19" = ids_OutsidePer2)

PoolCollections.GCL(collections = "KSPORT19", loci = GAPSLoci_reordered, IDs = ids_OutsidePer2, newname = "OutsidePer2Sport_2019")
```

Verify that we picked fish appropriately.
```{r sport_OutsidePer2_mixture_verify}
OutsidePer2Sport_2019.gcl$attributes %>% 
  count(site, biweek) %>% 
  spread(site, n, fill = 0)
```

Save genotypes for sport strata.
```{r save_sport_OutsidePer2_strata_genotypes}
save_sillys(sillyvec = "OutsidePer2Sport_2019", path = "../Genotypes/strata/")
```

# Data QA

Standard data QA:

  * Remove fish missing <80% genotypes
  * Remove duplicates (>95% genotype concordance)

```{r sport_mixnames}
sport_2019_mixnames <- str_replace(string = dget("../../SEAK18/Objects/sport_2018_mixnames.txt"), pattern = "2018", replacement = "2019")
save_objects(objects = "sport_2019_mixnames", path = "../Objects/")
```


```{r sport_QA}
# original sample sizes
sport_2019_sample_sizes <- tibble(silly = sport_2019_mixnames,
                                   genotyped = sapply(sport_2019_mixnames, function(x) {get(paste0(x, ".gcl"))$n }))

# missing
sport_2019_missing <- RemoveIndMissLoci.GCL(sillyvec = sport_2019_mixnames, proportion = 0.8)
save_objects("sport_2019_missing", "../Objects/")

sport_2019_sample_sizes <- sport_2019_sample_sizes %>% 
  mutate(missing = genotyped - sapply(sport_2019_mixnames, function(x) {get(paste0(x, ".gcl"))$n }))

# duplicate
sport_2019_duplicates <- CheckDupWithinSilly.GCL(sillyvec = sport_2019_mixnames, loci = GAPSLoci_reordered, quantile = NULL, minproportion = 0.95)
(sport_2019_duplicates_summary <- sapply(sport_2019_mixnames, function(x) {sport_2019_duplicates[[x]]$report}))
save_objects("sport_2019_duplicates_summary", "../Objects/")

sport_2019_duplciates_removed <- RemoveDups.GCL(dupcheck = sport_2019_duplicates)

sport_2019_sample_sizes <- sport_2019_sample_sizes %>% 
  mutate(duplicate = genotyped - missing - sapply(sport_2019_mixnames, function(x) {get(paste0(x, ".gcl"))$n }))

# final
sport_2019_sample_sizes <- sport_2019_sample_sizes %>% 
  mutate(final = sapply(sport_2019_mixnames, function(x) {get(paste0(x, ".gcl"))$n }))
sport_2019_sample_sizes
save_objects("sport_2019_sample_sizes", "../Objects/")

write_csv(sport_2019_sample_sizes, "../Tables/sport_2019_sample_sizes.csv")
```

Save post-QA genotypes
```{r sport_post_QA}
if(!dir.exists("../Genotypes/strata_postQA/")) {dir.create("../Genotypes/strata_postQA/")}
save_sillys(sillyvec = sport_2019_mixnames, path = "../Genotypes/strata_postQA")
```
# Create *BAYES* files

## Directory setup

First need to set up *BAYES* directory structure and copy over baseline file and *BAYES* objects. This was already done when we ran TBR.

## Create mixtures

Save the fortran format and create TBR *BAYES* mixture files. This was already done when we ran TBR.
```{r sport_BAYES_mixtures}
# mixfortran <- CreateMixture.GCL(sillys = TBR_sillys[1], loci = GAPSLoci_reordered, IDs = NULL, mixname = TBR_mixnames[TBR_sillys[1]], dir = "../BAYES/Mixture", type = "BAYES", PT = FALSE)
# save_objects("mixfortran", "../Objects/")

sapply(sport_2019_mixnames, function(mix) {
  CreateMixture.GCL(sillys = mix, loci = GAPSLoci_reordered, IDs = NULL, mixname = mix, dir = "../BAYES/Mixture", type = "BAYES", PT = FALSE)
} )
```

## Create priors

New this year, I will be analyzing **ALL** Chinook mixtures with the full 33 reporting groups. Fortunately I had already re-summarized sport for 2017 at 33RG. 

```{r sport_read_2017_estimates}
SummerRet1_2018_33RG_EstimatesStats <- dget("../../SEAK18/Estimates objects/Sport_2018_33RG_EstimatesStats.txt")

sport_2018_means_33RG <- sapply(c(SummerRet1_2018_33RG_EstimatesStats), function(mix) {
  mix[, "mean"]
} )

dimnames(sport_2018_means_33RG)
```

Change column names for 2019 mixtures.
```{r sport_setup_2019_priors}
# Fix dimnames
colnames(sport_2018_means_33RG) <- str_replace(string = colnames(sport_2018_means_33RG), pattern = "2018", replacement = "2019")

# Verify
apply(sport_2018_means_33RG, 2, sum)
```

Now create 2019 priors.
```{r sport_create_2019_priors}
sport_2019_priors <- apply(sport_2018_means_33RG, 2, function(mix) {
  Prior.GCL(groupvec = GroupVec33RG_357, groupweights = mix, minval = 0.01)
} )
colnames(sport_2019_priors) <- sport_2019_mixnames
save_objects("sport_2019_priors", "../Objects/")
```

## Create control files

Now that we have priors, just need to create *BAYES* control files.
```{r sport_BAYES_control}
sapply(sport_2019_mixnames, function(mix) {
  CreateControlFile.GCL(
    sillyvec = SEAKPops357,
    loci = GAPSLoci_reordered,
    mixname = mix,
    basename = "GAPS357pops13loci",
    suffix = "",
    nreps = 40000,
    nchains = 5,
    groupvec = GroupVec33RG_357,
    priorvec = sport_2019_priors[, mix],
    initmat = GAPS357PopsInits,
    dir = "../BAYES/Control",
    seeds = WASSIPSockeyeSeeds,
    thin = c(1, 1, 100),
    mixfortran = mixfortran,
    basefortran = bayesfortran_357,
    switches = "F T F T F T F"
  )
})
```

## Create output directories

```{r sport_BAYES_output}
sapply(sport_2019_mixnames, function(mix) {dir.create(paste0("../BAYES/Output/", mix))} )
```

# Summarize *BAYES* results

Summarize results for both the full 33 reporting groups, the 5 TBR groups, 3 TBR groups, and 2 TBR groups.

## 33 reporting groups

Create standard summary and save.
```{r sport_BAYES_summarise_33RG}
# full 33 reporting groups
Sport_2019_33RG_EstimatesStats <-
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:33,
    groupnames = GroupNames33,
    maindir = "../BAYES/Output",
    mixvec = sport_2019_mixnames,
    prior = "",
    ext = "RGN",
    nchains = 5,
    burn = 0.5,
    alpha = 0.1,
    PosteriorOutput = FALSE
  )

# dir.create("../Estimates objects")
save_objects(c("Sport_2019_33RG_EstimatesStats"), "../Estimates objects")
```


Make in to tall tibble.
```{r sport_BAYES_33RG_tibble}
# make in to a tidy tibble (tall)
sport_2019_33RG_estimates.tdy <- 
  bind_rows(
    lapply(sport_2019_mixnames, function(mix) {  # loop over mixture names
      c(Sport_2019_33RG_EstimatesStats)[[mix]] %>%  # for each matrix
        as_tibble(rownames = "group") %>%  # make tibble with rownames as group
        mutate(mixname = mix) %>%  # make column for mixname
        mutate(n_group = n_distinct(group))  # make column for number of groups
    } )
  ) %>% 
  gather(estimator, value, -mixname, -group, - n_group) %>%  # gather all estimators
  separate(mixname, c("mix", "year"), sep = "Sport_", remove = FALSE) %>%  # extract mixture and year
  mutate(estimator = factor(estimator, c("mean", "sd", "5%", "95%", "median", "P=0", "GR"))) %>%  # factor for ordering
  mutate(group = factor(group, GroupNames33))  # factor for ordering

save_objects(c("sport_2019_33RG_estimates.tdy"), "../Estimates objects")
```

Check GR
```{r sport_GR}
sport_2019_33RG_estimates.tdy %>% 
  filter(estimator == "GR") %>% 
  filter(value > 1.2)
```
This is why we report to Interior Columbia Su/Fa, not to summer and fall separately.


# Troll resummarization

All troll mixtures, all stratified, each fishery stratified for:
  * 33RG (all)
  * 18RG (fine-scale, all > 5%)
  * 8RG (driver stock)
  * 4RG (course-scale)

## All troll, all RGs

```{r troll_mixtures}
troll_2019_mixnames <-
  c(winter_2019_mixnames,
    spring_2019_mixnames,
    summer_2019_mixnames)

Troll_2019_Mixtures_33RG_EstimatesStats <-
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:33,
    groupnames = GroupNames33,
    maindir = "../BAYES/Output",
    mixvec = troll_2019_mixnames,
    prior = "",
    ext = "RGN",
    nchains = 5,
    burn = 0.5,
    alpha = 0.1,
    PosteriorOutput = FALSE
  )

Troll_2019_Mixtures_18RG_EstimatesStats <-
  CustomCombineBAYESOutput.GCL(
    groupvec = GroupVec33RG_to18RG,
    groupnames = GroupNames18,
    maindir = "../BAYES/Output",
    mixvec = troll_2019_mixnames,
    prior = "",
    ext = "RGN",
    nchains = 5,
    burn = 0.5,
    alpha = 0.1,
    PosteriorOutput = FALSE
  )

Troll_2019_Mixtures_8RG_EstimatesStats <-
  CustomCombineBAYESOutput.GCL(
    groupvec = GroupVec33RG_to8RG,
    groupnames = GroupNames8,
    maindir = "../BAYES/Output",
    mixvec = troll_2019_mixnames,
    prior = "",
    ext = "RGN",
    nchains = 5,
    burn = 0.5,
    alpha = 0.1,
    PosteriorOutput = FALSE
  )

Troll_2019_Mixtures_4RG_EstimatesStats <-
  CustomCombineBAYESOutput.GCL(
    groupvec = GroupVec33RG_to4RG,
    groupnames = GroupNames4,
    maindir = "../BAYES/Output",
    mixvec = troll_2019_mixnames,
    prior = "",
    ext = "RGN",
    nchains = 5,
    burn = 0.5,
    alpha = 0.1,
    PosteriorOutput = FALSE
  )

save_objects(objects = "troll_2019_mixnames", path = "../Objects/")
save_objects(objects = objects(pattern = "Troll_2019_Mixtures"),
             path = "../Estimates objects/")
```

## Stratified

Read in harvest data.
```{r troll_harvest_by_quad}
troll_harvest <- bind_rows(
  read_csv("../Harvest Data/20191021_ft - Detailed Fish Tickets.csv")) %>% 
  mutate(Month = month(`Date Fishing Ended`, label = TRUE, abbr = FALSE)) %>% 
  mutate(Fishery = case_when(Month %in% month.name[1:4] ~ "Late Winter",
                             Month %in% month.name[5] ~ "Spring Ret 1", 
                             Month %in% month.name[6] ~ "Spring Ret 2", 
                             Month %in% month.name[7] ~ "Summer Ret 1",
                             Month %in% month.name[8:9] ~ "Summer Ret 2",
                             Month %in% month.name[10:12] ~ "Early Winter"
  )) %>% 
  mutate(Fishery = factor(x = Fishery, levels = c("Early Winter", "Late Winter", "Spring Ret 1", "Spring Ret 2", "Summer Ret 1", "Summer Ret 2"))) %>% 
  mutate(Quadrant = case_when(District %in% c(113, 114, 116, 154, 156, 157, 181, 183, 189) ~ 171,
                              District %in% c(103, 104, 152) ~ 172,
                              District %in% c(109, 110, 111, 112, 115) ~ 173,
                              District %in% c(101, 102, 105, 106, 107, 108) ~ 174)) %>% 
  mutate(AY = case_when(Fishery == "Early Winter" & Year == 2018 ~ 2019,
                        Fishery == "Early Winter" & Year == 2019 ~ 2020,
                        TRUE ~ Year)) %>% 
  filter(AY == 2019)

troll_harvest %>% 
  group_by(Quadrant, Fishery) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  spread(Fishery, Harvest, fill = 0)
```

### Early Winter

```{r troll_EW_stratified}
EWint_2019_33RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = 1:33, groupnames = GroupNames33, maindir = "../BAYES/Output/", mixvec = winter_2019_mixnames[1:4], 
                          catchvec = c(1441, 68, 1878, 2520), newname = "EWintAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

EWint_2019_18RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to18RG, groupnames = GroupNames18, maindir = "../BAYES/Output/", mixvec = winter_2019_mixnames[1:4], 
                          catchvec = c(1441, 68, 1878, 2520), newname = "EWintAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

EWint_2019_8RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to8RG, groupnames = GroupNames8, maindir = "../BAYES/Output/", mixvec = winter_2019_mixnames[1:4], 
                          catchvec = c(1441, 68, 1878, 2520), newname = "EWintAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

EWint_2019_4RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to4RG, groupnames = GroupNames4, maindir = "../BAYES/Output/", mixvec = winter_2019_mixnames[1:4], 
                          catchvec = c(1441, 68, 1878, 2520), newname = "EWintAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

save_objects(objects = objects(pattern = "EWint_2019_"), path = "../Estimates objects/")
```

### Late Winter

```{r troll_LW_stratified}
LWint_2019_33RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = 1:33, groupnames = GroupNames33, maindir = "../BAYES/Output/", mixvec = winter_2019_mixnames[5:8], 
                          catchvec = c(3030, 543, 908, 1978), newname = "LWintAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

LWint_2019_18RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to18RG, groupnames = GroupNames18, maindir = "../BAYES/Output/", mixvec = winter_2019_mixnames[5:8], 
                          catchvec = c(3030, 543, 908, 1978), newname = "LWintAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

LWint_2019_8RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to8RG, groupnames = GroupNames8, maindir = "../BAYES/Output/", mixvec = winter_2019_mixnames[5:8], 
                          catchvec = c(3030, 543, 908, 1978), newname = "LWintAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

LWint_2019_4RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to4RG, groupnames = GroupNames4, maindir = "../BAYES/Output/", mixvec = winter_2019_mixnames[5:8], 
                          catchvec = c(3030, 543, 908, 1978), newname = "LWintAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

save_objects(objects = objects(pattern = "LWint_2019_"), path = "../Estimates objects/")
```

### Summer Ret 1

```{r troll_SU1_stratified}
SummerRet1_2019_33RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = 1:33, groupnames = GroupNames33, maindir = "../BAYES/Output/", mixvec = summer_2019_mixnames[1:4], 
                          catchvec = c(41978, 11215, 2233, 2956), newname = "SummerRet1AllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

SummerRet1_2019_18RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to18RG, groupnames = GroupNames18, maindir = "../BAYES/Output/", mixvec = summer_2019_mixnames[1:4], 
                          catchvec = c(41978, 11215, 2233, 2956), newname = "SummerRet1AllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

SummerRet1_2019_8RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to8RG, groupnames = GroupNames8, maindir = "../BAYES/Output/", mixvec = summer_2019_mixnames[1:4], 
                          catchvec = c(41978, 11215, 2233, 2956), newname = "SummerRet1AllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

SummerRet1_2019_4RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to4RG, groupnames = GroupNames4, maindir = "../BAYES/Output/", mixvec = summer_2019_mixnames[1:4], 
                          catchvec = c(41978, 11215, 2233, 2956), newname = "SummerRet1AllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

save_objects(objects = objects(pattern = "SummerRet1_2019_"), path = "../Estimates objects/")
```

### Summer Ret 2

```{r troll_SU2_stratified}
SummerRet2_2019_33RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = 1:33, groupnames = GroupNames33, maindir = "../BAYES/Output/", mixvec = summer_2019_mixnames[5:8], 
                          catchvec = c(14334, 6827, 2918, 1380), newname = "SummerRet2AllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

SummerRet2_2019_18RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to18RG, groupnames = GroupNames18, maindir = "../BAYES/Output/", mixvec = summer_2019_mixnames[5:8], 
                          catchvec = c(14334, 6827, 2918, 1380), newname = "SummerRet2AllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

SummerRet2_2019_8RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to8RG, groupnames = GroupNames8, maindir = "../BAYES/Output/", mixvec = summer_2019_mixnames[5:8], 
                          catchvec = c(14334, 6827, 2918, 1380), newname = "SummerRet2AllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

SummerRet2_2019_4RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to4RG, groupnames = GroupNames4, maindir = "../BAYES/Output/", mixvec = summer_2019_mixnames[5:8], 
                          catchvec = c(14334, 6827, 2918, 1380), newname = "SummerRet2AllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

save_objects(objects = objects(pattern = "SummerRet2_2019_"), path = "../Estimates objects/")
```

### Spring

#### Ret 1 (May)

Verify harvest by stat area for May.
```{r troll_SP1_stratified_harvest}
troll_harvest %>% 
  filter(Fishery == "Spring Ret 1") %>% 
  group_by(`Stat Area`) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE))
```

What mixutres did we run?
```{r troll_SP1_mixtures}
spring_2019_mixnames
```

Not going to break out May and June separately at the moment because we didnt' last year, can go back and do if necessary/desired.

#### Ret 2 (June)

Not planning to estimate this stratified mixture given that we don't have fine-scale enough mixtures (some stat areas are May + June and there is too much temporal variation to use the season total).

#### NO Quad (171)

All harvest from NO quadrant May + June.
```{r troll_SP_NO_quad_stratified_harvest}
troll_harvest %>% 
  filter(Fishery %in% c("Spring Ret 1", "Spring Ret 2") & Quadrant == 171) %>% 
  group_by(`Stat Area`, Fishery) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  spread(Fishery, Harvest, fill = 0)
```

Have to use some mixtures to represent other "un-genotyped" mixtures. Did so based on time and area (i.e. 113-32 June harvest ~ 113-01 June harvest, not 113-30 harvest because temporal variation was so strong; use 113-41 May for 113-62 May instead of 113-62 June).
```{r troll_SP_NO_quad_stratified}
SpringNO_2019_33RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = 1:33, groupnames = GroupNames33, maindir = "../BAYES/Output/", mixvec = spring_2019_mixnames[c(9, 2, 10, 10, 3, 11, 4, 12, 5, 13)], 
                          catchvec = c(244, 398, 175, 76, 571, 2381, 268, 2075, 482, 267), newname = "SpringNOAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

SpringNO_2019_18RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to18RG, groupnames = GroupNames18, maindir = "../BAYES/Output/", mixvec = spring_2019_mixnames[c(9, 2, 10, 10, 3, 11, 4, 12, 5, 13)], 
                          catchvec = c(244, 398, 175, 76, 571, 2381, 268, 2075, 482, 267), newname = "SpringNOAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

SpringNO_2019_8RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to8RG, groupnames = GroupNames8, maindir = "../BAYES/Output/", mixvec = spring_2019_mixnames[c(9, 2, 10, 10, 3, 11, 4, 12, 5, 13)], 
                          catchvec = c(244, 398, 175, 76, 571, 2381, 268, 2075, 482, 267), newname = "SpringNOAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

SpringNO_2019_4RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to4RG, groupnames = GroupNames4, maindir = "../BAYES/Output/", mixvec = spring_2019_mixnames[c(9, 2, 10, 10, 3, 11, 4, 12, 5, 13)], 
                          catchvec = c(244, 398, 175, 76, 571, 2381, 268, 2075, 482, 267), newname = "SpringNOAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

save_objects(objects = objects(pattern = "SpringNO_2019_"), path = "../Estimates objects/")
```

#### SO Quad (172)

All harvest from SO quadrant May + June.
```{r troll_SP_SO_quad_stratified_harvest}
troll_harvest %>% 
  filter(Fishery %in% c("Spring Ret 1", "Spring Ret 2") & Quadrant == 172) %>% 
  group_by(`Stat Area`, Fishery) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  spread(Fishery, Harvest, fill = 0)
```

This is very straightforward as 103-50 is the only stat area fished in SO quad (172)
```{r troll_SP_SO_quad_stratified}
SpringSO_2019_33RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = 1:33, groupnames = GroupNames33, maindir = "../BAYES/Output/", mixvec = spring_2019_mixnames[c(1, 8, 1, 8)], 
                          catchvec = c(670, 275, 108, 43), newname = "SpringSOAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

SpringSO_2019_18RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to18RG, groupnames = GroupNames18, maindir = "../BAYES/Output/", mixvec = spring_2019_mixnames[c(1, 8, 1, 8)], 
                          catchvec = c(670, 275, 108, 43), newname = "SpringSOAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

SpringSO_2019_8RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to8RG, groupnames = GroupNames8, maindir = "../BAYES/Output/", mixvec = spring_2019_mixnames[c(1, 8, 1, 8)], 
                          catchvec = c(670, 275, 108, 43), newname = "SpringSOAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

SpringSO_2019_4RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to4RG, groupnames = GroupNames4, maindir = "../BAYES/Output/", mixvec = spring_2019_mixnames[c(1, 8, 1, 8)], 
                          catchvec = c(670, 275, 108, 43), newname = "SpringSOAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

save_objects(objects = objects(pattern = "SpringSO_2019_"), path = "../Estimates objects/")
```

#### SI Quad (174)

All harvest from SI quadrant May + June.
```{r troll_SP_SI_quad_stratified_harvest}
troll_harvest %>% 
  filter(Fishery %in% c("Spring Ret 1", "Spring Ret 2") & Quadrant == 174) %>% 
  group_by(`Stat Area`, Fishery) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  spread(Fishery, Harvest, fill = 0)
```

This is very straightforward as 101-45 is the only stat area fished in SI quad (174)
```{r troll_SP_SI_quad_stratified}
SpringSI_2019_33RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = 1:33, groupnames = GroupNames33, maindir = "../BAYES/Output/", mixvec = spring_2019_mixnames[c(6, 7)], 
                          catchvec = c(1761, 583), newname = "SpringSIAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

SpringSI_2019_18RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to18RG, groupnames = GroupNames18, maindir = "../BAYES/Output/", mixvec = spring_2019_mixnames[c(6, 7)], 
                          catchvec = c(1761, 583), newname = "SpringSIAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

SpringSI_2019_8RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to8RG, groupnames = GroupNames8, maindir = "../BAYES/Output/", mixvec = spring_2019_mixnames[c(6, 7)], 
                          catchvec = c(1761, 583), newname = "SpringSIAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

SpringSI_2019_4RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to4RG, groupnames = GroupNames4, maindir = "../BAYES/Output/", mixvec = spring_2019_mixnames[c(6, 7)], 
                          catchvec = c(1761, 583), newname = "SpringSIAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

save_objects(objects = objects(pattern = "SpringSI_2019_"), path = "../Estimates objects/")
```

#### Spring All Quads

All harvest from all quadrants May + June.
```{r troll_SP_stratified_harvest}
troll_harvest %>% 
  filter(Fishery %in% c("Spring Ret 1", "Spring Ret 2")) %>% 
  group_by(`Stat Area`, Fishery) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  spread(Fishery, Harvest, fill = 0)
```

Have to use some mixtures to represent other "un-genotyped" mixtures. Did so based on time and area (i.e. 103-50 to represent 103-60 and 113-30 to represent 113-32).
```{r troll_SP_stratified}
Spring_2019_33RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = 1:33, groupnames = GroupNames33, maindir = "../BAYES/Output/", mixvec = spring_2019_mixnames[c(6, 7, 1, 8, 1, 8, 9, 2, 10, 10, 3, 11, 4, 12, 5, 13)], 
                          catchvec = c(1761, 583, 670, 275, 108, 43, 244, 398, 175, 76, 571, 2381, 268, 2075, 482, 267), newname = "SpringAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

Spring_2019_18RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to18RG, groupnames = GroupNames18, maindir = "../BAYES/Output/", mixvec = spring_2019_mixnames[c(6, 7, 1, 8, 1, 8, 9, 2, 10, 10, 3, 11, 4, 12, 5, 13)], 
                          catchvec = c(1761, 583, 670, 275, 108, 43, 244, 398, 175, 76, 571, 2381, 268, 2075, 482, 267), newname = "SpringAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

Spring_2019_8RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to8RG, groupnames = GroupNames8, maindir = "../BAYES/Output/", mixvec = spring_2019_mixnames[c(6, 7, 1, 8, 1, 8, 9, 2, 10, 10, 3, 11, 4, 12, 5, 13)], 
                          catchvec = c(1761, 583, 670, 275, 108, 43, 244, 398, 175, 76, 571, 2381, 268, 2075, 482, 267), newname = "SpringAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

Spring_2019_4RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to4RG, groupnames = GroupNames4, maindir = "../BAYES/Output/", mixvec = spring_2019_mixnames[c(6, 7, 1, 8, 1, 8, 9, 2, 10, 10, 3, 11, 4, 12, 5, 13)], 
                          catchvec = c(1761, 583, 670, 275, 108, 43, 244, 398, 175, 76, 571, 2381, 268, 2075, 482, 267), newname = "SpringAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

save_objects(objects = objects(pattern = "Spring_2019_"), path = "../Estimates objects/")
```

## All year, publication tables

```{r}
names(Troll_2019_Mixtures_8RG_EstimatesStats)
objects(pattern = "_8RG_Stratified")
```

```{r}
Troll2019_8RG_StratifiedEstimatesStats <- list("EWintAllQuad_2019" = EWint_2019_8RG_StratifiedEstimatesStats,
                                               "LWintAllQuad_2019" = LWint_2019_8RG_StratifiedEstimatesStats,
                                               "SpringAllQuad_2019" = Spring_2019_8RG_StratifiedEstimatesStats,
                                               "SumRet1AllQuad_2019" = SummerRet1_2019_8RG_StratifiedEstimatesStats,
                                               "SumRet2AllQuad_2019" = SummerRet2_2019_8RG_StratifiedEstimatesStats)
dput(x = Troll2019_8RG_StratifiedEstimatesStats, file = "../Estimates objects/Troll2019_8RG_StratifiedEstimatesStats.txt")

Troll2019_8RG_EstimatesStats <- list(
  "EWintNO_2019" = Troll_2019_Mixtures_8RG_EstimatesStats[["EWintNO_2019"]],
  "EWintAllQuad_2019" = EWint_2019_8RG_StratifiedEstimatesStats,
  "LWintNO_2019" = Troll_2019_Mixtures_8RG_EstimatesStats[["LWintNO_2019"]],
  "LWintAllQuad_2019" = LWint_2019_8RG_StratifiedEstimatesStats,
  "SpringNO_2019" = SpringNO_2019_8RG_StratifiedEstimatesStats,
  "SpringSI_2019" = SpringSI_2019_8RG_StratifiedEstimatesStats,
  "SpringAllQuad_2019" = Spring_2019_8RG_StratifiedEstimatesStats,
  "SumRet1NO_2019" = Troll_2019_Mixtures_8RG_EstimatesStats[["SummerRet1NO_2019"]],
  "SumRet1AllQuad_2019" = SummerRet1_2019_8RG_StratifiedEstimatesStats,
  "SumRet2NO_2019" = Troll_2019_Mixtures_8RG_EstimatesStats[["SummerRet2NO_2019"]],
  "SumRet2AllQuad_2019" = SummerRet2_2019_8RG_StratifiedEstimatesStats
  )
dput(x = Troll2019_8RG_EstimatesStats, file = "../Estimates objects/Troll2019_8RG_EstimatesStats.txt")
```

```{r}
# make in to a tidy tibble (tall)
troll_2019_8RG_estimates.tdy <- 
  bind_rows(
    lapply(names(Troll2019_8RG_EstimatesStats), function(mix) {  # loop over mixture names
      Troll2019_8RG_EstimatesStats[[mix]] %>%  # for each matrix
        as_tibble(rownames = "group") %>%  # make tibble with rownames as group
        mutate(mixname = mix) %>%  # make column for mixname
        mutate(n_group = n_distinct(group))  # make column for number of groups
    } )
  ) %>% 
  gather(estimator, value, -mixname, -group, - n_group) %>%  # gather all estimators
  separate(mixname, c("mix", "year"), sep = "_", remove = FALSE) %>%  # extract mixture and year
  mutate(estimator = factor(estimator, c("mean", "sd", "5%", "95%", "median", "P=0", "GR"))) %>%  # factor for ordering
  mutate(group = factor(group, GroupNames8))  # factor for ordering

save_objects(c("troll_2019_8RG_estimates.tdy"), "../Estimates objects")
```


## All year, stratified

Full Accounting Year troll harvest. Note that Winter and Summer are by period and quadrant, but Spring is by month and stat area.
```{r troll_winter_summer_harvest_table}
'%!in%' <- function(x,y)!('%in%'(x,y))

troll_harvest %>% 
  filter(Fishery %!in% c("Spring Ret 1", "Spring Ret 2")) %>% 
  group_by(Quadrant, Fishery) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  spread(Fishery, Harvest, fill = 0)
```

```{r troll_spring_harvest_table}
troll_harvest %>% 
  filter(Fishery %in% c("Spring Ret 1", "Spring Ret 2")) %>% 
  group_by(`Stat Area`, Fishery) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  spread(Fishery, Harvest, fill = 0)
```

Verify that all harvest is accounted for in `catchvec`.
```{r troll_AY_harvest_verify}
troll_harvest %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  pull(Harvest)

sum(c(1441, 68, 1878, 2520, 3030, 543, 908, 1978, 1761, 583, 670, 275, 108, 43, 244, 398, 175, 76, 571, 2381, 268, 2075, 482, 267, 41978, 11215, 2233, 2956, 14334, 6827, 2918, 1380))
```

Full AY stratified estimate
```{r troll_all_year_all_quad_stratified}
AllYearTroll2019_33RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = 1:33, groupnames = GroupNames33, maindir = "../BAYES/Output/", mixvec = c(winter_2019_mixnames, spring_2019_mixnames[c(6, 7, 1, 8, 1, 8, 9, 2, 10, 10, 3, 11, 4, 12, 5, 13)], summer_2019_mixnames), 
                          catchvec = c(1441, 68, 1878, 2520, 3030, 543, 908, 1978, 1761, 583, 670, 275, 108, 43, 244, 398, 175, 76, 571, 2381, 268, 2075, 482, 267, 41978, 11215, 2233, 2956, 14334, 6827, 2918, 1380), newname = "AllYearAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

AllYearTroll2019_18RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to18RG, groupnames = GroupNames18, maindir = "../BAYES/Output/", mixvec = c(winter_2019_mixnames, spring_2019_mixnames[c(6, 7, 1, 8, 1, 8, 9, 2, 10, 10, 3, 11, 4, 12, 5, 13)], summer_2019_mixnames), 
                          catchvec = c(1441, 68, 1878, 2520, 3030, 543, 908, 1978, 1761, 583, 670, 275, 108, 43, 244, 398, 175, 76, 571, 2381, 268, 2075, 482, 267, 41978, 11215, 2233, 2956, 14334, 6827, 2918, 1380), newname = "AllYearAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

AllYearTroll2019_8RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to8RG, groupnames = GroupNames8, maindir = "../BAYES/Output/", mixvec = c(winter_2019_mixnames, spring_2019_mixnames[c(6, 7, 1, 8, 1, 8, 9, 2, 10, 10, 3, 11, 4, 12, 5, 13)], summer_2019_mixnames), 
                          catchvec = c(1441, 68, 1878, 2520, 3030, 543, 908, 1978, 1761, 583, 670, 275, 108, 43, 244, 398, 175, 76, 571, 2381, 268, 2075, 482, 267, 41978, 11215, 2233, 2956, 14334, 6827, 2918, 1380), newname = "AllYearAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

AllYearTroll2019_4RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to4RG, groupnames = GroupNames4, maindir = "../BAYES/Output/", mixvec = c(winter_2019_mixnames, spring_2019_mixnames[c(6, 7, 1, 8, 1, 8, 9, 2, 10, 10, 3, 11, 4, 12, 5, 13)], summer_2019_mixnames), 
                          catchvec = c(1441, 68, 1878, 2520, 3030, 543, 908, 1978, 1761, 583, 670, 275, 108, 43, 244, 398, 175, 76, 571, 2381, 268, 2075, 482, 267, 41978, 11215, 2233, 2956, 14334, 6827, 2918, 1380), newname = "AllYearAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

save_objects(objects = objects(pattern = "AllYearTroll2019_"), path = "../Estimates objects/")
```

# Sport resummarization

## All sport, all RGs

```{r sport_mixtures}
Sport_2019_Mixtures_33RG_EstimatesStats <- 
  CustomCombineBAYESOutput.GCL(groupvec = 1:33, groupnames = GroupNames33, maindir = "../BAYES/Output", mixvec = sport_2019_mixnames,
                               prior = "", ext = "RGN", nchains = 5, burn = 0.5, alpha = 0.1, PosteriorOutput = FALSE)

Sport_2019_Mixtures_18RG_EstimatesStats <- 
  CustomCombineBAYESOutput.GCL(groupvec = GroupVec33RG_to18RG, groupnames = GroupNames18, maindir = "../BAYES/Output", mixvec = sport_2019_mixnames,
                               prior = "", ext = "RGN", nchains = 5, burn = 0.5, alpha = 0.1, PosteriorOutput = FALSE)

Sport_2019_Mixtures_8RG_EstimatesStats <- 
  CustomCombineBAYESOutput.GCL(groupvec = GroupVec33RG_to8RG, groupnames = GroupNames8, maindir = "../BAYES/Output", mixvec = sport_2019_mixnames,
                               prior = "", ext = "RGN", nchains = 5, burn = 0.5, alpha = 0.1, PosteriorOutput = FALSE)

Sport_2019_Mixtures_4RG_EstimatesStats <- 
  CustomCombineBAYESOutput.GCL(groupvec = GroupVec33RG_to4RG, groupnames = GroupNames4, maindir = "../BAYES/Output", mixvec = sport_2019_mixnames,
                               prior = "", ext = "RGN", nchains = 5, burn = 0.5, alpha = 0.1, PosteriorOutput = FALSE)

save_objects(objects = "sport_2019_mixnames", path = "../Objects/")
save_objects(objects = objects(pattern = "Sport_2019_Mixtures"), path = "../Estimates objects/")
```

```{r sport_mixtures_8RG_tidy}
# make in to a tidy tibble (tall)
sport_2019_8RG_estimates.tdy <- 
  bind_rows(
    lapply(sport_2019_mixnames, function(mix) {  # loop over mixture names
      Sport_2019_Mixtures_8RG_EstimatesStats[[mix]] %>%  # for each matrix
        as_tibble(rownames = "group") %>%  # make tibble with rownames as group
        mutate(mixname = mix) %>%  # make column for mixname
        mutate(n_group = n_distinct(group))  # make column for number of groups
    } )
  ) %>% 
  gather(estimator, value, -mixname, -group, - n_group) %>%  # gather all estimators
  separate(mixname, c("mix", "year"), sep = "Sport_", remove = FALSE) %>%  # extract mixture and year
  mutate(estimator = factor(estimator, c("mean", "sd", "5%", "95%", "median", "P=0", "GR"))) %>%  # factor for ordering
  mutate(group = factor(group, GroupNames8))  # factor for ordering

save_objects(c("sport_2019_8RG_estimates.tdy"), "../Estimates objects")
```


## All year, stratified

Full Accounting Year sport harvest.
```{r sport_harvest_table}
'%!in%' <- function(x,y)!('%in%'(x,y))

sport_harvest <- read_csv("../Harvest Data/preliminary_2019_sport_harvest_chinook.csv") %>% 
  gather(port, harvest, -biweek) %>% 
  mutate(period = case_when(biweek <= 13 ~ "early",
                            biweek > 13 ~ "late")) %>% 
  mutate(fishery = case_when(port == "Ketchikan" ~ "Ketchikan",
                             port %in% c("Petersburg", "Wrangell") ~ "PBG/WRN",
                             port == "Juneau" ~ "Inside",
                             TRUE ~ "Outside"))

sport_harvest %>% 
  group_by(fishery, period) %>% 
  summarise(harvest = sum(harvest)) %>% 
  spread(fishery, harvest, fill = 0)
```

Full AY stratified estimate
```{r sport_all_year_all_quad_stratified}
AllYearSport2019_33RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = 1:33, groupnames = GroupNames33, maindir = "../BAYES/Output/", mixvec = sport_2019_mixnames[-c(1:2)], 
                          catchvec = c(3538, 849, 3963, 12715, 6507), newname = "AllYearAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

AllYearSport2019_18RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to18RG, groupnames = GroupNames18, maindir = "../BAYES/Output/", mixvec = sport_2019_mixnames[-c(1:2)], 
                          catchvec = c(3538, 849, 3963, 12715, 6507), newname = "AllYearAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

AllYearSport2019_8RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to8RG, groupnames = GroupNames8, maindir = "../BAYES/Output/", mixvec = sport_2019_mixnames[-c(1:2)], 
                          catchvec = c(3538, 849, 3963, 12715, 6507), newname = "AllYearAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

AllYearSport2019_4RG_StratifiedEstimatesStats <- 
  StratifiedEstimator.GCL(groupvec = GroupVec33RG_to4RG, groupnames = GroupNames4, maindir = "../BAYES/Output/", mixvec = sport_2019_mixnames[-c(1:2)], 
                          catchvec = c(3538, 849, 3963, 12715, 6507), newname = "AllYearAllQuad", ext = "RGN", nchains = 5, xlxs = FALSE, PosteriorOutput = FALSE)

save_objects(objects = objects(pattern = "AllYearSport2019_"), path = "../Estimates objects/")
```

# Compare All Year Troll AY 2009-2019

Get all year stock comp for AY 2009-2019
```{r troll_all_year_all_quad_2009-2018_8RG}
AllYearTroll2009_2019_8RG_StratifiedEstimatesStats <- 
  c(dget("../../SEAK15/Estimates objects/AllYearTroll2009_2015_8RG_StratifiedEstimatesStats.txt"),
    list(`2016` = dget("../../SEAK16/Estimates objects/AllYearTroll2016_8RG_StratifiedEstimatesStats.txt")),
    list(`2017` = dget("../../SEAK17/Estimates objects/AllYearTroll2017_8RG_StratifiedEstimatesStats.txt")),
    list(`2018` = dget("../../SEAK18/Estimates objects/AllYearTroll2018_8RG_StratifiedEstimatesStats.txt")),
    list(`2019` = dget("../Estimates objects/AllYearTroll2019_8RG_StratifiedEstimatesStats.txt")))

save_objects("AllYearTroll2009_2019_8RG_StratifiedEstimatesStats", "../Estimates objects/")
```

Make in to tibble
```{r troll_all_year_all_quad_2009-2019_8RG_tibble}
# make in to a tidy tibble (tall)
troll_AY_2009_2019_8RG_estimates.tdy <- 
  bind_rows(
    sapply(as.character(2009:2019), function(yr) {
      AllYearTroll2009_2019_8RG_StratifiedEstimatesStats[[yr]] %>% 
        as_tibble(rownames = "group") %>%  # make tibble with rownames as group
        mutate(year = as.integer(yr)) %>% # make column for year
        mutate(n_group = n_distinct(group))  # make column for number of groups
    }, simplify = FALSE)
  ) %>% 
  # gather(estimator, value, -year, -group, - n_group) %>%  # gather all estimators
  # mutate(estimator = factor(estimator, c("mean", "sd", "5%", "95%", "median", "P=0", "GR"))) %>%  # factor for ordering
  mutate(group = factor(group, GroupNames8))  # factor for ordering

save_objects(c("troll_AY_2009_2019_8RG_estimates.tdy"), "../Estimates objects")
```

Plot
```{r}
troll_AY_2009_2019_8RG_estimates.tdy %>% 
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = mean * 100, fill = group)) +
  geom_col() +
  scale_fill_manual(name = "Reporting Group", 
                    values = c("blue", "red4", "green2", "purple", "cyan2", "orange", "lightblue", "pink2"),
                    labels = GroupNames8Pub) +
  scale_y_continuous(breaks = seq(0, 100, 20)) +
  ylab("Stock Composition (%)") +
  xlab("Year") +
  ggtitle("SEAK Troll Harvest by AY") +
  theme_classic() +
  theme(text = element_text(size = 14))
```

Get harvest
```{r}
troll_harvest_AY_2009_2019 <- read_csv("../Harvest Data/CE012326.csv", skip = 22) %>% 
  mutate(Quadrant = case_when(`Area Value` == "NE" ~ "NI",
                              `Area Value` == "NW" ~ "NO",
                              `Area Value` == "SE" ~ "SI",
                              `Area Value` == "SW" ~ "SO")) %>% 
  mutate(District = case_when(Quadrant == "NO" ~ 171,
                              Quadrant == "SO" ~ 172,
                              Quadrant == "NI" ~ 173,
                              Quadrant == "SI" ~ 174)) %>% 
  mutate(Fishery = case_when(`Time Value` == 6 ~ "Early Winter",
                             `Time Value` == 1 ~ "Late Winter",
                             `Time Value` == 2 ~ "Spring Ret 1",
                             `Time Value` == 3 ~ "Spring Ret 2",
                             `Time Value` == 4 ~ "Summer Ret 1",
                             `Time Value` == 5 ~ "Summer Ret 2")) %>% 
  mutate(Fishery = factor(Fishery, c("Early Winter", "Late Winter", "Spring Ret 1", "Spring Ret 2", "Summer Ret 1", "Summer Ret 2"))) %>% 
  mutate(AY = case_when(Fishery == "Early Winter" ~ Year + 1,
                        TRUE ~ Year)) %>% 
  filter(AY >= 2009 & AY < 2020) %>% 
  select(AY, Year, Fishery, Quadrant, District, `N Catch`) %>% 
  dplyr::rename(Harvest = `N Catch`)

(annual_troll_harvest_AY_2009_2019 <- troll_harvest_AY_2009_2019 %>% 
    group_by(AY) %>% 
    summarise(Harvest = sum(Harvest)))
```

Stock-specific harvest
```{r}
troll_AY_2009_2019_8RG_estimates.tdy %>% 
  left_join(annual_troll_harvest_AY_2009_2019, by = c("year" = "AY")) %>% 
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = mean * Harvest / 1000, fill = group)) +
  geom_col() +
  scale_fill_manual(name = "Reporting Group", 
                    values = c("blue", "red4", "green2", "purple", "cyan2", "orange", "lightblue", "pink2"),
                    labels = GroupNames8Pub) +
  # scale_y_continuous(breaks = seq(0, 100, 20)) +
  ylab("Stock-Specific Harvest (1,000's)") +
  xlab("Year") +
  ggtitle("SEAK Troll Harvest by AY") +
  theme_classic() +
  theme(text = element_text(size = 14))
```

# Compare All Year Sport AY 2009-2019

Get all year stock comp for AY 2009-2019
```{r sport_all_year_all_quad_2009-2019_8RG}
AllYearSport2009_2019_8RG_StratifiedEstimatesStats <- 
  c(dget("../../SEAK16/Estimates objects/AllYearSport2009_2016_8RG_StratifiedEstimatesStats.txt"),
    list(`2017` = dget("../../SEAK17/Estimates objects/AllYearSport2017_8RG_StratifiedEstimatesStats.txt")),
    list(`2018` = dget("../../SEAK18/Estimates objects/AllYearSport2018_8RG_StratifiedEstimatesStats.txt")),
    list(`2019` = dget("../Estimates objects/AllYearSport2019_8RG_StratifiedEstimatesStats.txt")))

save_objects("AllYearSport2009_2019_8RG_StratifiedEstimatesStats", "../Estimates objects/")
```

Make in to tibble
```{r sport_all_year_all_quad_2009-2018_8RG_tibble}
# make in to a tidy tibble (tall)
sport_AY_2009_2019_8RG_estimates.tdy <- 
  bind_rows(
    sapply(as.character(2009:2019), function(yr) {
      AllYearSport2009_2019_8RG_StratifiedEstimatesStats[[yr]] %>% 
        as_tibble(rownames = "group") %>%  # make tibble with rownames as group
        mutate(year = as.integer(yr)) %>% # make column for year
        mutate(n_group = n_distinct(group))  # make column for number of groups
    }, simplify = FALSE)
  ) %>% 
  # gather(estimator, value, -year, -group, - n_group) %>%  # gather all estimators
  # mutate(estimator = factor(estimator, c("mean", "sd", "5%", "95%", "median", "P=0", "GR"))) %>%  # factor for ordering
  mutate(group = factor(group, GroupNames8))  # factor for ordering

save_objects(c("sport_AY_2009_2019_8RG_estimates.tdy"), "../Estimates objects")
```

Plot
```{r}
sport_AY_2009_2019_8RG_estimates.tdy %>% 
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = mean * 100, fill = group)) +
  geom_col() +
  scale_fill_manual(name = "Reporting Group", 
                    values = c("blue", "red4", "green2", "purple", "cyan2", "orange", "lightblue", "pink2"),
                    labels = GroupNames8Pub) +
  scale_y_continuous(breaks = seq(0, 100, 20)) +
  ylab("Stock Composition (%)") +
  xlab("Year") +
  ggtitle("SEAK Sport Harvest by AY") +
  theme_classic() +
  theme(text = element_text(size = 14))
```

Get harvest
```{r}
sport_harvest_AY_2009_2018 <- read_csv("../Harvest Data/swhs_est_20200127124345.csv", skip = 2) %>% 
  gather(year, harvest, -SOUTHEAST)


(annual_sport_harvest_AY_2009_2019 <- sport_harvest_AY_2009_2018 %>% 
    filter(year >= 2009 & year <= 2018 & SOUTHEAST == "Southeast Total") %>% 
    select(year, harvest) %>% 
    bind_rows(tibble(year = "2019", harvest = sum(sport_harvest$harvest))))
```

Stock-specific harvest
```{r}
sport_AY_2009_2019_8RG_estimates.tdy %>% 
  mutate(year = as.character(year)) %>% 
  left_join(annual_sport_harvest_AY_2009_2019, by = "year") %>% 
  ggplot(aes(x = year, y = mean * harvest / 1000, fill = group)) +
  geom_col() +
  scale_fill_manual(name = "Reporting Group", 
                    values = c("blue", "red4", "green2", "purple", "cyan2", "orange", "lightblue", "pink2"),
                    labels = GroupNames8Pub) +
  # scale_y_continuous(breaks = seq(0, 100, 20)) +
  ylab("Stock-Specific Harvest (1,000's)") +
  xlab("Year") +
  ggtitle("SEAK Sport Harvest by AY") +
  theme_classic() +
  theme(text = element_text(size = 14))
```


# Compare Sport vs. Troll stock-specific harvest
```{r}
sport_AY_2009_2019_8RG_estimates_harvest <- sport_AY_2009_2019_8RG_estimates.tdy %>% 
  mutate(year = as.character(year)) %>% 
  left_join(annual_sport_harvest_AY_2009_2019, by = "year") %>% 
  mutate(fishery = "Sport")

troll_AY_2009_2019_8RG_estimates_harvest <- troll_AY_2009_2019_8RG_estimates.tdy %>% 
  left_join(annual_troll_harvest_AY_2009_2019, by = c("year" = "AY")) %>% 
  mutate(year = as.character(year)) %>% 
  dplyr::rename(harvest = Harvest) %>% 
  mutate(fishery = "Troll")

bind_rows(sport_AY_2009_2019_8RG_estimates_harvest, troll_AY_2009_2019_8RG_estimates_harvest) %>% 
  ggplot(aes(x = year, y = mean * harvest / 1000, fill = group)) +
  geom_col() +
  scale_fill_manual(name = "Reporting Group", 
                    values = c("blue", "red4", "green2", "purple", "cyan2", "orange", "lightblue", "pink2"),
                    labels = GroupNames8Pub) +
  # scale_y_continuous(breaks = seq(0, 100, 20)) +
  ylab("Stock-Specific Harvest (1,000's)") +
  xlab("Year") +
  ggtitle("SEAK Harvest by AY and Fishery") +
  theme_classic() +
  theme(text = element_text(size = 14), axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  facet_grid(. ~ fishery)
```

# Compare Sport vs. Troll stock composition
```{r}
sport_AY_2009_2019_8RG_estimates <- sport_AY_2009_2019_8RG_estimates.tdy %>% 
  mutate(year = as.character(year)) %>% 
  mutate(fishery = "Sport")

troll_AY_2009_2019_8RG_estimates <- troll_AY_2009_2019_8RG_estimates.tdy %>% 
  mutate(year = as.character(year)) %>% 
  mutate(fishery = "Troll")

bind_rows(sport_AY_2009_2019_8RG_estimates, troll_AY_2009_2019_8RG_estimates) %>% 
  ggplot(aes(x = year, y = mean * 100, fill = group)) +
  geom_col() +
  scale_fill_manual(name = "Reporting Group", 
                    values = c("blue", "red4", "green2", "purple", "cyan2", "orange", "lightblue", "pink2"),
                    labels = GroupNames8Pub) +
  # scale_y_continuous(breaks = seq(0, 100, 20)) +
  ylab("Stock Composition (%)") +
  xlab("Year") +
  ggtitle("SEAK Stock Composition by AY and Fishery") +
  theme_classic() +
  theme(text = element_text(size = 14), axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  facet_grid(. ~ fishery)
```

# Make Annual Tables

For Dani's briefing paper
```{r annual_summaries}
write_csv(x = troll_AY_2009_2019_8RG_estimates.tdy, path = "../Tables/troll_AY_2009_2019_8RG_annual_estimates.csv")
write_csv(x = sport_AY_2009_2019_8RG_estimates.tdy, path = "../Tables/sport_AY_2009_2019_8RG_annual_estimates.csv")
write_csv(x = annual_sport_harvest_AY_2009_2019, path = "../Tables/annual_sport_harvest_AY_2009_2019.csv")
write_csv(x = annual_troll_harvest_AY_2009_2019, path = "../Tables/annual_troll_harvest_AY_2009_2019.csv")
```
