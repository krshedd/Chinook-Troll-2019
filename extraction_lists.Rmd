---
title: "Extraction Lists AY 2019"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

## Setup

Load all necessary packages.
```{r setup, message=FALSE, results='hide'}
library(tidyverse)
library(lubridate)
library(scales)

source("~/../R/Functions.GCL.R")
load_objects("../Objects/")
```

# Winter Troll

## ASL Data

### Read raw ASL
```{r}
(asl_winter <- read_csv(file = "../ASL Data/20190813_Harvest - Detailed ASL Samples.csv"))
```

### Manipulate ASL
```{r}
(asl_winter <- asl_winter %>% 
   mutate(Year_f = factor(Year)) %>% 
   rename(Quadrant = District) %>% 
   mutate(Fishery = case_when(Harvest == "Spring Troll Fishery" ~ "Spring",
                              Harvest == "Traditional State Managed Fisheries" & `Stat Week` <= 18 ~ "Late Winter",
                              Harvest == "Traditional State Managed Fisheries" & `Stat Week` >= 41 ~ "Early Winter",
                              Harvest == "Traditional State Managed Fisheries" & `Stat Week` >= 26 & `Stat Week` <= 31 ~ "Summer Ret 1",
                              Harvest == "Traditional State Managed Fisheries" & `Stat Week` >= 32 & `Stat Week` <= 36 ~ "Summer Ret 2")) %>% 
   mutate(Fishery = factor(Fishery, levels = c("Late Winter", "Spring", "Summer Ret 1", "Summer Ret 2", "Early Winter")))
)
```

### Visualize ASL
```{r}
asl_winter %>% 
  filter(!is.na(`Dna Specimen No`)) %>% 
  count(Year, Fishery, Quadrant) %>% 
  filter(Year == 2018 & Fishery == "Early Winter" | Year == "2019" & Fishery == "Late Winter") %>% 
  spread(Quadrant, n)
```


## Harvest Data

### Read Fish Ticket Data
```{r}
(harvest_winter <- read_csv(file = "../Harvest Data/20190813_ft - Detailed Fish Tickets.csv"))
```

### Manipulate Harvest
```{r}
(harvest_winter <- harvest_winter %>% 
   mutate(Quadrant = case_when(District %in% c(113, 114, 116, 154, 156, 157) | District >= 181 ~ 171,
                               District %in% c(103, 104, 152) ~ 172,
                               District %in% c(109, 110, 111, 112, 115) ~ 173,
                               District %in% c(101, 102, 105, 106, 107, 108) ~ 174)) %>% 
   mutate(Year_f = factor(Year)) %>% 
   mutate(Fishery = case_when(`Harvest Code` == 13 ~ "Spring",
                              `Harvest Code` == 11 & `Stat Week` <= 18 ~ "Late Winter",
                              `Harvest Code` == 11 & `Stat Week` >= 41 ~ "Early Winter",
                              `Harvest Code` == 11 & `Stat Week` >= 26 & `Stat Week` <= 31 ~ "Summer Ret 1",
                              `Harvest Code` == 11 & `Stat Week` >= 32 & `Stat Week` <= 36 ~ "Summer Ret 2")) %>% 
   mutate(Fishery = factor(Fishery, levels = c("Late Winter", "Spring", "Summer Ret 1", "Summer Ret 2", "Early Winter")))
)
```

### Visualize Harvest
```{r}
harvest_winter %>% 
  group_by(Year, Fishery, Quadrant) %>% 
  summarise(harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  filter(Year == 2018 & Fishery == "Early Winter" | Year == "2019" & Fishery == "Late Winter") %>% 
  spread(Quadrant, harvest)
```

## Join ASL and Harvest
```{r}
harvest_sw_quadrant <- harvest_winter %>% 
  filter(Year == 2018 & Fishery == "Early Winter" | Year == "2019" & Fishery == "Late Winter") %>% 
  group_by(Year, Fishery, `Stat Week`, `Harvest Code`, Quadrant) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`)) 

(join_winter <- asl_winter %>% 
    filter(!is.na(`Dna Specimen No`)) %>% 
    filter(Year == 2018 & Fishery == "Early Winter" | Year == "2019" & Fishery == "Late Winter") %>% 
    count(Year, Fishery, `Stat Week`, Quadrant) %>% 
    full_join(harvest_sw_quadrant, by = c("Year", "Fishery", "Stat Week", "Quadrant")) %>% 
    replace_na(list(n = 0, Harvest = 0)) %>% 
    select(Year, Fishery, `Stat Week`, Quadrant, n , Harvest)
)

join_winter %>% 
  filter(n > Harvest)
```

### Plot ASL samples and harvest as proportions by fishery
```{r}
join_winter %>% 
  group_by(Fishery, Quadrant) %>% 
  mutate(n = n / sum(n), harvest = Harvest / sum(Harvest)) %>% 
  ungroup() %>% 
  gather(variable, proportion, -`Stat Week`, -`Quadrant`, - Harvest, - Fishery, - Year) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = pretty_breaks()) +
  facet_grid(`Quadrant` ~ variable, scales = "fixed") +
  ggtitle("Proportion of Samples and Harvest\nby Stat Week and Quadrant for Winter Troll AY19") +
  theme_bw()
```

## Early Winter Selection
```{r}
join_winter %>% 
  group_by(Year, Fishery, Quadrant) %>% 
  mutate(n = n / sum(n), Harvest = Harvest / sum(Harvest)) %>% 
  ungroup() %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  filter(Fishery == "Early Winter") %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Samples and Harvest by Stat Week and Quadrant for Early Winter AY19") +
  theme_bw()
```

Thus the plan for extraction is to pick as many fish as possible, with the important caveat of subsampling in proportion to harvest by SW for each quadrant.

**Business rule** is to take fish from within 2 SW on either side to fill in for missing

### 171

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_EW_171 <- join_winter %>% 
   filter(Fishery == "Early Winter" & Year == "2018" & Quadrant == 171) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 120)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in holes from some weeks according to our business rule of +/- 2 weeks.
```{r}
(extraction_EW_171 <- extraction_EW_171 %>% 
   mutate(n_extract = case_when(`Stat Week` == 42 ~ 8,
                                `Stat Week` == 43 ~ 4,
                                `Stat Week` == 46 ~ 15,
                                `Stat Week` == 49 ~ 16,
                                `Stat Week` == 50 ~ 3,
                                TRUE ~ n_extract)) %>%
   select(Quadrant, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_winter %>% 
  filter(Fishery == "Early Winter" & Year == "2018" & Quadrant == 171) %>% 
  full_join(extraction_EW_171, by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Early Winter AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
EW_171_torun <- asl_winter %>% 
  filter(Year == 2018, Fishery == "Early Winter" & Quadrant == 171) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_EW_171, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
EW_171_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 172

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_EW_172 <- join_winter %>% 
   filter(Fishery == "Early Winter" & Year == "2018" & Quadrant == 172) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 11)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in holes from some weeks according to our business rule of +/- 2 weeks. Run all fish!
```{r}
(extraction_EW_172 <- extraction_EW_172 %>% 
   mutate(n_extract = n) %>%
   select(Quadrant, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_winter %>% 
  filter(Fishery == "Early Winter" & Year == "2018" & Quadrant == 172) %>% 
  full_join(extraction_EW_172, by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Early Winter AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
EW_172_torun <- asl_winter %>% 
  filter(Year == 2018, Fishery == "Early Winter" & Quadrant == 172) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_EW_172, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
EW_172_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 173

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_EW_173 <- join_winter %>% 
   filter(Fishery == "Early Winter" & Year == "2018" & Quadrant == 173) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 110)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in holes from some weeks according to our business rule of +/- 2 weeks.
```{r}
(extraction_EW_173 <- extraction_EW_173 %>% 
   mutate(n_extract = case_when(`Stat Week` == 42 ~ 32,
                                `Stat Week` == 43 ~ 21,
                                `Stat Week` == 46 ~ 17,
                                `Stat Week` == 47 ~ 9,
                                `Stat Week` == 49 ~ 9,
                                TRUE ~ n_extract)) %>%
   select(Quadrant, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_winter %>% 
  filter(Fishery == "Early Winter" & Year == "2018" & Quadrant == 173) %>% 
  full_join(extraction_EW_173, by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Early Winter AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
EW_173_torun <- asl_winter %>% 
  filter(Year == 2018, Fishery == "Early Winter" & Quadrant == 173) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_EW_173, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
EW_173_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 174

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_EW_174 <- join_winter %>% 
   filter(Fishery == "Early Winter" & Year == "2018" & Quadrant == 174) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 100)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in holes from some weeks according to our business rule of +/- 2 weeks.
```{r}
(extraction_EW_174 <- extraction_EW_174 %>% 
   mutate(n_extract = case_when(`Stat Week` == 42 ~ 36,
                                `Stat Week` == 43 ~ 18,
                                `Stat Week` == 48 ~ 7,
                                `Stat Week` == 49 ~ 13,
                                `Stat Week` == 50 ~ 2,
                                TRUE ~ n_extract)) %>%
   select(Quadrant, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_winter %>% 
  filter(Fishery == "Early Winter" & Year == "2018" & Quadrant == 174) %>% 
  full_join(extraction_EW_174, by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Early Winter AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
EW_174_torun <- asl_winter %>% 
  filter(Year == 2018, Fishery == "Early Winter" & Quadrant == 174) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_EW_174, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
EW_174_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### Early Winter Extraction

Combine in to a single tibble.
```{r}
EW_torun_asl <- bind_rows(EW_171_torun, EW_172_torun, EW_173_torun, EW_174_torun)
EW_torun_asl %>% 
  count(Quadrant)

save_objects("EW_torun_asl", path = "../Objects")
```

Plot proportions
```{r}
join_winter %>% 
  filter(Fishery == "Early Winter" & Year == "2018") %>% 
  full_join(EW_torun_asl %>% count(Quadrant, `Stat Week`), by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  replace_na(list(n_sample = 0, n_extract = 0, Harvest = 0)) %>%  # replace NA in samples and harvest with 0
  group_by(Quadrant) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Early Winter AY19") +
  theme_bw()
```


## Late Winter Selection
```{r}
join_winter %>% 
  group_by(Year, Fishery, Quadrant) %>% 
  mutate(n = n / sum(n), Harvest = Harvest / sum(Harvest)) %>% 
  ungroup() %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  filter(Fishery == "Late Winter") %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Samples and Harvest by Stat Week and Quadrant for Late Winter AY19") +
  theme_bw()
```

Thus the plan for extraction is to pick ~380 for 171 (NO), ~190 for 173 (NI) and 174 (SI) and run everything for 172 (SO), with the important caveat of subsampling in proportion to harvest by SW for each quadrant.

**Business rule** is to take fish from within 2 SW on either side to fill in for missing

### 171

Plan is to subsample ~380 fish. What would proportional sampling look like?
```{r}
(extraction_LW_171 <- join_winter %>% 
   filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 171) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 380)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

No need to adjust, looks perfect!
```{r}
(extraction_LW_171 <- extraction_LW_171 %>% 
   mutate(n_extract = n_extract) %>%
   select(Quadrant, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_winter %>% 
  filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 171) %>% 
  full_join(extraction_LW_171, by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Late Winter AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
LW_171_torun <- asl_winter %>% 
  filter(Year == 2019, Fishery == "Late Winter" & Quadrant == 171) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_LW_171, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
LW_171_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 172

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_LW_172 <- join_winter %>% 
   filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 172) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 55)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in holes from some weeks according to our business rule of +/- 2 weeks. Run all fish!
```{r}
(extraction_LW_172 <- extraction_LW_172 %>% 
   mutate(n_extract = case_when(`Stat Week` == 3 ~ 10,
                                `Stat Week` == 6 ~ 5,
                                `Stat Week` == 7 ~ 5,
                                `Stat Week` == 10 ~ 10,
                                TRUE ~ n_extract)) %>%
   select(Quadrant, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_winter %>% 
  filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 172) %>% 
  full_join(extraction_LW_172, by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Late Winter AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
LW_172_torun <- asl_winter %>% 
  filter(Year == 2019, Fishery == "Late Winter" & Quadrant == 172) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_LW_172, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
LW_172_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 173

Plan is to subsample 120 fish. What would proportional sampling look like?
```{r}
(extraction_LW_173 <- join_winter %>% 
   filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 173) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 120)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in holes from some weeks according to our business rule of +/- 2 weeks.
```{r}
(extraction_LW_173 <- extraction_LW_173 %>% 
   mutate(n_extract = case_when(`Stat Week` == 2 ~ 5,
                                `Stat Week` == 5 ~ 13,
                                `Stat Week` == 6 ~ 6,
                                `Stat Week` == 9 ~ 13,
                                `Stat Week` == 49 ~ 9,
                                TRUE ~ n_extract)) %>%
   select(Quadrant, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_winter %>% 
  filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 173) %>% 
  full_join(extraction_LW_173, by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Late Winter AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
LW_173_torun <- asl_winter %>% 
  filter(Year == 2019, Fishery == "Late Winter" & Quadrant == 173) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_LW_173, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
LW_173_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 174

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_LW_174 <- join_winter %>% 
   filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 174) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 170)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in holes from some weeks according to our business rule of +/- 2 weeks.
```{r}
(extraction_LW_174 <- extraction_LW_174 %>% 
   mutate(n_extract = case_when(`Stat Week` == 5 ~ 47,
                                `Stat Week` == 7 ~ 19,
                                `Stat Week` == 9 ~ 19,
                                TRUE ~ n_extract)) %>%
   select(Quadrant, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_winter %>% 
  filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 174) %>% 
  full_join(extraction_LW_174, by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Late Winter AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
LW_174_torun <- asl_winter %>% 
  filter(Year == 2019, Fishery == "Late Winter" & Quadrant == 174) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_LW_174, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
LW_174_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### Late Winter Extraction

Combine in to a single tibble.
```{r}
LW_torun_asl <- bind_rows(LW_171_torun, LW_172_torun, LW_173_torun, LW_174_torun)
LW_torun_asl %>% 
  count(Quadrant)

save_objects("LW_torun_asl", path = "../Objects")
```

Plot proportions
```{r}
join_winter %>% 
  filter(Fishery == "Late Winter" & Year == "2019") %>% 
  full_join(LW_torun_asl %>% count(Quadrant, `Stat Week`), by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  replace_na(list(n_sample = 0, n_extract = 0, Harvest = 0)) %>%  # replace NA in samples and harvest with 0
  group_by(Quadrant) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Late Winter AY19") +
  theme_bw()
```

## Write Winter Extraction List

Combine Early and Late Winter into one list and confirm that all `Dna Specimen No` are 6 characters before splitting
```{r}
winter_torun_asl <- bind_rows(EW_torun_asl, LW_torun_asl)

table(nchar(winter_torun_asl$`Dna Specimen No`))
```

### Compare with *LOKI*
Excellent! Next we'll pull tissue collection info from OceanAK and join, need full 10 digit WGC number and Sample number
```{r}
(loki_tissue_winter <- read_csv(file = "../OceanAK/GEN_SAMPLED_FISH_TISSUE_KTROL18EW_KTROL19LW.csv") %>% 
   filter(is.na(IS_MISSING_PAIRED_DATA_EXISTS)) %>%  # make sure we aren't issing the tissue
   select(`Silly Code`, FK_FISH_ID, DNA_TRAY_CODE, DNA_TRAY_WELL_CODE, PK_TISSUE_TYPE) %>% 
   mutate(WGC_4digit = str_sub(DNA_TRAY_CODE, 7, 10)) %>% 
   mutate(WGC_2digit_pos = str_pad(string = DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   unite(dna_specimen_no, c(WGC_4digit, WGC_2digit_pos), sep = '', remove = FALSE) %>% 
   mutate(dna_specimen_no = as.integer(dna_specimen_no))
)
```

Are all my extraction fish in the LOKI tissue table?
```{r}
table(winter_torun_asl$`Dna Specimen No` %in% loki_tissue_winter$dna_specimen_no)
```

### Resolve Discrepancies
Looks like we are missing 5 fish..., but which ones???
```{r}
missing_fish <- sort(setdiff(winter_torun_asl$`Dna Specimen No`, loki_tissue_winter$dna_specimen_no))

winter_torun_asl %>% 
  filter(`Dna Specimen No` %in% missing_fish) %>% 
  select(Fishery, Quadrant, `Stat Week`, `Dna Specimen No`)
```

Do these two Whatman cards exist in LOKI?
```{r}
sum(grepl(pattern = 6474, x = loki_tissue_winter$DNA_TRAY_CODE))
sum(grepl(pattern = 4687, x = loki_tissue_winter$DNA_TRAY_CODE))
```

The first card does NOT exist in LOKI...

Perhaps there was a typo in the Whatman Card number, what barcodes do we have?
```{r}
loki_tissue_winter %>% 
  count(DNA_TRAY_CODE)
```

After Checking Iris' shipment summary sheet, I think that fish from Card 1000006474 are actually 1000004674...I will go double checked this by pulling the physical Whatman Card. 
```{r}
read_csv(file = "../OceanAK/GEN_SAMPLED_FISH_TISSUE_KTROL18EW_KTROL19LW.csv") %>% 
  filter(DNA_TRAY_CODE == "1000004674") %>% 
  select(DNA_TRAY_CODE, STORAGE_ID, UNIT, SHELF_RACK, SLOT)
```

After checking the physical Whatman card, I was correct, these fish are from 1000004674. I'll modify those `Dna Specimen No` now.
```{r}
winter_torun_asl_mod <- winter_torun_asl %>% 
  mutate(`Dna Specimen No` = as.numeric(str_replace(string = as.character(`Dna Specimen No`), pattern = "6474", replacement = "4674")))
```

As for fish 468702, it looks like we only have 1 in LOKI, how many did we want to extract?
```{r}
winter_torun_asl[grep(pattern = 4687, x = winter_torun_asl$`Dna Specimen No`), ]
```

Whoops, well it looks like we wanted all 2 fish from that Whatman card, but we only have one. Can we replace that missing fish with another from that stat week?
```{r}
join_winter %>% 
  filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 172) %>% 
  left_join(extraction_LW_172, by = c("Stat Week", "Quadrant"), suffix = c("_sample", "_extraction")) %>% 
  arrange(`Stat Week`)
```

Nope, looks like we are SOL, we are using all fish from SW 11 and the two prior weeks. We'll just have to drop this fish.
```{r}
winter_torun_asl_mod <- winter_torun_asl_mod %>% 
  filter(`Dna Specimen No` != 468702)
```

Now is everything in LOKI?
```{r}
table(winter_torun_asl_mod$`Dna Specimen No` %in% loki_tissue_winter$dna_specimen_no)
```

### Duplicates
Any duplicates?
```{r}
table(table(loki_tissue_winter$dna_specimen_no))
table(table(winter_torun_asl_mod$`Dna Specimen No`))
```

Shit, looks like two fish selected for extraction have the same Dna Specimen No, which are they?
```{r}
winter_torun_asl_mod %>% 
  count(`Dna Specimen No`) %>% 
  filter(n > 1)
```

Where are they from?
```{r}
winter_torun_asl_mod %>% 
  filter(`Dna Specimen No` == 445601)
```

Any more fish on these cards?
```{r}
winter_torun_asl_mod[grep(pattern = 4456, x = winter_torun_asl_mod$`Dna Specimen No`), ]
```

After reviewing Iris' sample summary sheets, 445601 is the Early Winter fish from 171, Juneau, SW 47. The Late Winter fish from 171, Juneau, SW10 should be 645601.

```{r}
(winter_torun_asl_mod <- winter_torun_asl_mod %>% 
   mutate(`Dna Specimen No` = case_when(`Stat Week` == 10 & `Dna Specimen No` == 445602 ~ 645602,
                                        `Stat Week` == 10 & `Dna Specimen No` == 445601 ~ 645601,
                                        TRUE ~ `Dna Specimen No`))
)
```

Any duplicates now?
```{r}
table(table(winter_torun_asl_mod$`Dna Specimen No`))
```

And everything still in LOKI?
```{r}
all(winter_torun_asl_mod$`Dna Specimen No` %in% loki_tissue_winter$dna_specimen_no)
```

Excellent, all present and accounted for. Verify that we have the correct numbers of fish per fishery/quadrant
```{r}
winter_torun_asl_mod %>% 
  count(Fishery, Quadrant) %>% 
  spread(Quadrant, n, fill = 0)
```

### Format

Join LOKI Tissue Table with ASL and format for Extraction List Template
```{r}
(winter_torun_extraction <- winter_torun_asl_mod %>% 
   left_join(loki_tissue_winter, by = c(`Dna Specimen No` = "dna_specimen_no")) %>% 
   mutate(`WELL CODE` = str_pad(DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   mutate(`TISSUE TYPE` = str_replace(PK_TISSUE_TYPE, pattern = " Process", replacement = "")) %>% 
   mutate(`TISSUE TYPE` = str_replace(`TISSUE TYPE`, pattern = " Clip", replacement = "")) %>% 
   rename(SILLY = `Silly Code`, `SAMPLE #` = FK_FISH_ID, `WGC BARCODE` = `DNA_TRAY_CODE`) %>% 
   select(SILLY, `SAMPLE #`, `WGC BARCODE`, `WELL CODE`, `TISSUE TYPE`) %>% 
   arrange(SILLY, `WGC BARCODE`, `WELL CODE`)
)
```

### Write
```{r}
write_csv(winter_torun_extraction, path = "../Extraction Lists/Winter_Extraction.csv")

winter_torun_extraction %>% 
  count(SILLY, `TISSUE TYPE`)
```

# TBR + Extra Gillnet

We normally run TBR samples which include all large Chinook (>660mm MEF) from District 108 + 111 between statistical weeks 17-29. In addition, this year we will be analyzing D115 SW 25-29 (looking for Chilkat + Taku) and D101 (Tree Point) SW 25-29. These will all be extracted and genotyped with Winter Troll.

## Sport TBR

### ASL Data
```{r}
(asl_sport_tbr <- read_csv("../Associated Data/Sport TBR/_2019_SEAK_SF_Whatman_AWL_31JUL19.csv"))
```

```{r}
(asl_sport_tbr <- asl_sport_tbr %>% 
   filter(DISTRICT %in% c(108, 111)) %>% 
   filter(STATWEEK >= 17 & STATWEEK <= 29) %>% 
   filter(LENGTH >= 660) %>% 
   filter(!is.na(Whatman_Card))
)
```

```{r}
asl_sport_tbr %>% 
  count(DISTRICT, STATWEEK) %>% 
  spread(DISTRICT, n, fill = 0)
```

### Sport TBR Selection

#### 108

Plan is to run all 108 fish since we only have 32.
```{r}
sport_tbr_108_torun <- asl_sport_tbr %>% 
  filter(DISTRICT == 108)
```

#### 111
Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_sport_tbr_111 <- asl_sport_tbr %>% 
   count(DISTRICT, STATWEEK) %>% 
   filter(DISTRICT == 111) %>% 
   arrange(STATWEEK) %>% 
   mutate(p = round(n / sum(n) * 200)) %>% 
   mutate(total = sum(p))
)
```

Randomly pick fish per week
```{r}
sport_tbr_111_torun <- asl_sport_tbr %>% 
  filter(DISTRICT == 111) %>% 
  nest(-STATWEEK) %>% 
  right_join(extraction_sport_tbr_111, by = "STATWEEK") %>% 
  mutate(Sample = map2(data, p, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
sport_tbr_111_torun %>% 
  count(STATWEEK) %>% 
  mutate(total = sum(n))
```

## Write Sport TBR Extraction List

Combine 108 and 111 into one list
```{r}
(sport_tbr_torun_asl <- bind_rows(sport_tbr_108_torun, sport_tbr_111_torun) %>% 
   mutate(Whatman_Card = str_pad(Whatman_Card, 10, "left", "0")) %>%  # pad WGC
   # mutate(SAMPLE_NO = str_pad(SAMPLE_NO, 2, "left", "0")) %>%  # pad well
   unite(silly_source, c("Whatman_Card", "SAMPLE_NO"), sep = "_", remove = FALSE)  # silly_source
)

save_objects("sport_tbr_torun_asl", path = "../Objects")
```

### Compare with *LOKI*
Excellent! Next we'll pull tissue collection info from OceanAK and join, need full 10 digit WGC number and Sample number
```{r}
(loki_tissue_sport_tbr <- read_csv(file = "../OceanAK/GEN_SAMPLED_FISH_TISSUE_KSPORT19.csv") %>% 
   filter(is.na(IS_MISSING_PAIRED_DATA_EXISTS)) %>%  # make sure we aren't issing the tissue
   select(`Silly Code`, FK_FISH_ID, DNA_TRAY_CODE, DNA_TRAY_WELL_CODE, PK_TISSUE_TYPE) %>% 
   unite(silly_source, c("DNA_TRAY_CODE", "DNA_TRAY_WELL_CODE"), sep = "_", remove = FALSE)  # silly_source
)
```

Are all my extraction fish in the LOKI tissue table?
```{r}
table(sport_tbr_torun_asl$silly_source %in% loki_tissue_sport_tbr$silly_source)
```

### Resolve Discrepancies
Looks like we are missing 2 fish..., but which ones???
```{r}
missing_fish <- sort(setdiff(sport_tbr_torun_asl$silly_source, loki_tissue_sport_tbr$silly_source))

sport_tbr_torun_asl %>% 
  filter(silly_source %in% missing_fish) %>% 
  select(DISTRICT, STATWEEK, SITE, silly_source)
```

Do these two Whatman cards exist in LOKI?
```{r}
loki_tissue_sport_tbr %>% 
  filter(DNA_TRAY_CODE %in% c("0000004315", "0000023782"))
```

Nope, evidently neither card exists in LOKI...

There are no more 108 fish available, so I'll just drop that one, but we do have additional D111 SW 26 fish to pick from, so I can replace that one.
```{r}
replacement_sport_tbr <- asl_sport_tbr %>% 
  filter(DISTRICT == 111 & STATWEEK == 26) %>% 
  mutate(Whatman_Card = str_pad(Whatman_Card, 10, "left", "0")) %>%  # pad WGC
  unite(silly_source, c("Whatman_Card", "SAMPLE_NO"), sep = "_", remove = FALSE) %>%  # silly_source
  anti_join(sport_tbr_torun_asl, by = "silly_source") %>% 
  sample_n(1)
```

Drop missing fish, add one replacement
```{r}
(sport_tbr_torun_asl_mod <- sport_tbr_torun_asl %>% 
   filter(!silly_source %in% missing_fish) %>% 
   bind_rows(replacement_sport_tbr)
)
```

### Duplicates

Any duplicates?
```{r}
table(table(loki_tissue_sport_tbr$silly_source))
table(table(sport_tbr_torun_asl_mod$silly_source))
```

Nope, excellent

Everything still in LOKI?
```{r}
all(sport_tbr_torun_asl_mod$silly_source %in% loki_tissue_sport_tbr$silly_source)
```

Excellent, all present and accounted for. Verify that we have the correct numbers of fish per District
```{r}
sport_tbr_torun_asl_mod %>% 
  count(DISTRICT)
```

### Format

Join LOKI Tissue Table with ASL and format for Extraction List Template
```{r}
(sport_tbr_torun_extraction <- sport_tbr_torun_asl_mod %>% 
   left_join(loki_tissue_sport_tbr, by = "silly_source") %>% 
   mutate(`WELL CODE` = str_pad(DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   mutate(`TISSUE TYPE` = str_replace(PK_TISSUE_TYPE, pattern = " Process", replacement = "")) %>% 
   mutate(`TISSUE TYPE` = str_replace(`TISSUE TYPE`, pattern = " Clip", replacement = "")) %>% 
   rename(SILLY = `Silly Code`, `SAMPLE #` = FK_FISH_ID, `WGC BARCODE` = `DNA_TRAY_CODE`) %>% 
   select(SILLY, `SAMPLE #`, `WGC BARCODE`, `WELL CODE`, `TISSUE TYPE`) %>% 
   arrange(SILLY, `WGC BARCODE`, `WELL CODE`)
)
```

### Write
```{r}
write_csv(sport_tbr_torun_extraction, path = "../Extraction Lists/Sport_TBR_Extraction.csv")

sport_tbr_torun_extraction %>% 
  count(SILLY, `TISSUE TYPE`)
```

## Gillnet TBR + District 101 and 115

### ASL Data

#### Read raw ASL
```{r}
(asl_gillnet <- read_csv(file = "../ASL Data/20190822_Gillnet_D8_11_1_15_Detailed ASL Samples.csv"))
```

#### Manipulate ASL
```{r}
(asl_gillnet <- asl_gillnet %>% 
   filter(District %in% c(108, 111) & `Length mm` >= 660 | District %in% c(101, 115)) %>% 
   filter(`Stat Week` <= 29) %>% 
   filter(!is.na(`Dna Specimen No`))
)
```

#### Visualize ASL
```{r}
asl_gillnet %>% 
  count(Year, District, `Stat Week`, `Harvest Code`) %>% 
  spread(District, n, fill = 0)
```


## Harvest Data

### Read Fish Ticket Data
```{r}
(harvest_gillnet <- read_csv(file = "../Harvest Data/20190822_gillnet_ft - Detailed Fish Tickets.csv"))
```

### Manipulate Harvest
```{r}
(harvest_gillnet <- harvest_gillnet %>% 
   filter(District %in% c(101, 108, 111, 115)) %>% 
   filter(between(`Stat Week`, 25, 29)) %>% 
   filter(`Species Code And Name` == "410 - salmon, chinook") %>% 
   filter(`Gear Code` == "03") %>% 
   filter(`Harvest Code` == 11) %>% 
   filter(Year == 2019)
)
```

### Visualize Harvest
```{r}
harvest_gillnet %>% 
  group_by(District, `Stat Week`) %>% 
  summarise(harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  spread(District, harvest, fill = 0)
```

Check average weights
```{r}
harvest_gillnet %>% 
  group_by(District, `Stat Week`) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE), Pounds = sum(`Landed Weight (sum)`, na.rm = TRUE)) %>% 
  mutate(AvgWeight = Pounds/Harvest) %>% 
  select(-Harvest, - Pounds) %>% 
  spread(District, AvgWeight)
```

### Join ASL and Harvest
```{r}
harvest_sw_district <- harvest_gillnet %>% 
  group_by(District, `Stat Week`) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE))

(join_gillnet <- asl_gillnet %>% 
    filter(!is.na(`Dna Specimen No`)) %>% 
    count(`Stat Week`, District) %>% 
    full_join(harvest_sw_district, by = c("Stat Week", "District")) %>% 
    replace_na(list(n = 0, Harvest = 0)) %>% 
    select(`Stat Week`, District, n , Harvest)
)

join_gillnet %>% 
  filter(n > Harvest)
```

#### Plot ASL samples and harvest as proportions by fishery
```{r}
join_gillnet %>% 
  group_by(District) %>% 
  mutate(n = n / sum(n), harvest = Harvest / sum(Harvest)) %>% 
  ungroup() %>% 
  gather(variable, proportion, -`Stat Week`, -`District`, - Harvest) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = pretty_breaks()) +
  facet_grid(District ~ variable, scales = "fixed") +
  ggtitle("Proportion of Samples and Harvest\nby Stat Week and District for Gillnet AY19") +
  theme_bw()
```

Thus the plan for extraction is to pick up to 200 fish, with the important caveat of subsampling in proportion to harvest by SW for each district

**Business rule** is to take fish from within 2 SW on either side to fill in for missing

```{r}
join_gillnet %>% 
  group_by(District) %>% 
  summarise(Harvest = sum(Harvest), n = sum(n))
```

### 101 Gillnet

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_gillnet_101 <- join_gillnet %>% 
   filter(District == 101) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 200)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Plenty of fish, looks great.
```{r}
(extraction_gillnet_101 <- extraction_gillnet_101 %>% 
   select(District, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_gillnet %>% 
  filter(District == 101) %>% 
  full_join(extraction_gillnet_101, by = c("District", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -District) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(District ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and District for Gillnet 101 AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
gillnet_101_torun <- asl_gillnet %>% 
  filter(District == 101) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_gillnet_101, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
gillnet_101_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 115 Gillnet

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_gillnet_115 <- join_gillnet %>% 
   filter(District == 115) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 200)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Plenty of fish, looks great.
```{r}
(extraction_gillnet_115 <- extraction_gillnet_115 %>% 
   mutate(n_extract = case_when(`Stat Week` == 27 ~ 30,
                                TRUE ~ n_extract)) %>% 
   select(District, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_gillnet %>% 
  filter(District == 115) %>% 
  full_join(extraction_gillnet_115, by = c("District", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -District) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(District ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and District for Gillnet 115 AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
gillnet_115_torun <- asl_gillnet %>% 
  filter(District == 115) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_gillnet_115, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
gillnet_115_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 108 Gillnet TBR

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_gillnet_108 <- join_gillnet %>% 
   filter(District == 108) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 105)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Doesn't look great...but goign to go with all fish
```{r}
(extraction_gillnet_108 <- extraction_gillnet_108 %>% 
   mutate(n_extract = case_when(`Stat Week` == 26 ~ 28,
                                `Stat Week` == 29 ~ 17,
                                TRUE ~ n_extract)) %>% 
   select(District, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_gillnet %>% 
  filter(District == 108) %>% 
  full_join(extraction_gillnet_108, by = c("District", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -District) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(District ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and District for Gillnet 108 AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
gillnet_108_torun <- asl_gillnet %>% 
  filter(District == 108) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_gillnet_108, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
gillnet_108_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 111 Gillnet TBR

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_gillnet_111 <- join_gillnet %>% 
   filter(District == 111) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 115)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Doesn't look great...but goign to go with all fish
```{r}
(extraction_gillnet_111 <- extraction_gillnet_111 %>% 
   mutate(n_extract = case_when(`Stat Week` == 27 ~ 48,
                                TRUE ~ n_extract)) %>% 
   select(District, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_gillnet %>% 
  filter(District == 111) %>% 
  full_join(extraction_gillnet_111, by = c("District", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -District) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(District ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and District for Gillnet 111 AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
gillnet_111_torun <- asl_gillnet %>% 
  filter(District == 111) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_gillnet_111, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
gillnet_111_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### Gillnet Extraction

Combine in to a single tibble.
```{r}
gillnet_torun_asl <- bind_rows(gillnet_101_torun, gillnet_108_torun, gillnet_111_torun, gillnet_115_torun)
gillnet_torun_asl %>% 
  count(District)

save_objects("gillnet_torun_asl", path = "../Objects")
```

Plot proportions
```{r}
join_gillnet %>% 
  full_join(gillnet_torun_asl %>% count(District, `Stat Week`), by = c("District", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  replace_na(list(n_sample = 0, n_extract = 0, Harvest = 0)) %>%  # replace NA in samples and harvest with 0
  group_by(District) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -District) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(District ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and District for Gillnet AY19") +
  theme_bw()
```

## Write Gillnet Extraction List

Confirm that all `Dna Specimen No` are 6 characters before splitting
```{r}
table(nchar(gillnet_torun_asl$`Dna Specimen No`))
```

Damn
```{r}
gillnet_torun_asl %>% 
  filter(nchar(`Dna Specimen No`) == 5)
```

Checked Iris' summary for the other card, and it looks like it was missing the leading 5.

Yes, that one is just missing the last 0
```{r}
gillnet_torun_asl <- gillnet_torun_asl %>% 
  mutate(`Dna Specimen No` = case_when(`Dna Specimen No` == 31404 ~ 531404,
                                       TRUE ~ `Dna Specimen No`))
```

Confirm both fixed
```{r}
table(nchar(gillnet_torun_asl$`Dna Specimen No`))
```

### Compare with *LOKI*
Excellent! Next we'll pull tissue collection info from OceanAK and join, need full 10 digit WGC number and Sample number
```{r}
(loki_tissue_gillnet <- read_csv(file = "../OceanAK/GEN_SAMPLED_FISH_TISSUE_KGILL19D1_D11_D8_D15.csv") %>% 
   filter(is.na(IS_MISSING_PAIRED_DATA_EXISTS)) %>%  # make sure we aren't issing the tissue
   select(`Silly Code`, FK_FISH_ID, DNA_TRAY_CODE, DNA_TRAY_WELL_CODE, PK_TISSUE_TYPE) %>% 
   mutate(WGC_4digit = str_sub(DNA_TRAY_CODE, 7, 10)) %>% 
   mutate(WGC_2digit_pos = str_pad(string = DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   unite(dna_specimen_no, c(WGC_4digit, WGC_2digit_pos), sep = '', remove = FALSE) %>% 
   mutate(dna_specimen_no = as.integer(dna_specimen_no))
)
```

Are all my extraction fish in the LOKI tissue table?
```{r}
table(gillnet_torun_asl$`Dna Specimen No` %in% loki_tissue_gillnet$dna_specimen_no)
```

### Resolve Discrepancies
Looks like we are missing 1 fish..., but which ones???
```{r}
missing_fish <- sort(setdiff(gillnet_torun_asl$`Dna Specimen No`, loki_tissue_gillnet$dna_specimen_no))

gillnet_torun_asl %>% 
  filter(`Dna Specimen No` %in% missing_fish) %>% 
  select(District, `Stat Week`, `Dna Specimen No`)
```

Are there more fish left for this SW?
```{r}
asl_gillnet %>% 
  filter(District == 111 & `Stat Week` == 27) %>% 
  anti_join(gillnet_torun_asl) %>% 
  arrange(`Dna Specimen No`)
```

Grab the next fish? If exists in LOKI
```{r}
loki_tissue_gillnet %>% 
  filter(dna_specimen_no == 510209)
```

```{r}
gillnet_torun_asl_mod <- gillnet_torun_asl %>% 
  filter(`Dna Specimen No` != 510309) %>% 
  bind_rows(asl_gillnet %>% filter(`Dna Specimen No` == 510209))
```

Are all my extraction fish in the LOKI tissue table?
```{r}
table(gillnet_torun_asl_mod$`Dna Specimen No` %in% loki_tissue_gillnet$dna_specimen_no)
```

### Duplicates
Any duplicates?
```{r}
table(table(loki_tissue_gillnet$dna_specimen_no))
table(table(gillnet_torun_asl_mod$`Dna Specimen No`))
```

Shit, looks like five fish selected for extraction have the same Dna Specimen No, which are they?
```{r}
gillnet_torun_asl_mod %>% 
  count(`Dna Specimen No`) %>% 
  filter(n > 1)
```

Where are they from?
```{r}
gillnet_torun_asl_mod %>% 
  filter(`Dna Specimen No` %in% c(419301, 419303, 419309, 419605, 419607))
```

The fish from Ketchikan, D101, SW 27 actually have a 5 digit WGC = 34195. So these fish are actually fine.
```{r}
gillnet_torun_asl_mod <- gillnet_torun_asl_mod %>% 
  mutate(`Dna Specimen No` = case_when(`Dna Specimen No` == 419301 & `Port Code` == "KTN" ~ 3419301,
                                       `Dna Specimen No` == 419303 & `Port Code` == "KTN" ~ 3419303,
                                       `Dna Specimen No` == 419309 & `Port Code` == "KTN" ~ 3419309,
                                       `Dna Specimen No` == 419605 & `Port Code` == "KTN" ~ 3419605,
                                       `Dna Specimen No` == 419607 & `Port Code` == "KTN" ~ 3419607,
                                       TRUE ~ `Dna Specimen No`))
```

Need to fix LOKI too otherwise join won't work
```{r}
WGC_5digits <- loki_tissue_gillnet %>% 
  mutate(WGC_5digit = as.integer(str_sub(DNA_TRAY_CODE, 6, 10))) %>% 
  filter(nchar(WGC_5digit) == 5) %>% 
  distinct(DNA_TRAY_CODE) %>% 
  pull(DNA_TRAY_CODE)


loki_tissue_gillnet <- loki_tissue_gillnet %>% 
  mutate(WGC_5digit = str_sub(DNA_TRAY_CODE, 6, 10)) %>% 
  mutate(WGC_2digit_pos = str_pad(string = DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
  unite(dna_specimen_no_7, c(WGC_5digit, WGC_2digit_pos), sep = '', remove = FALSE) %>% 
  mutate(dna_specimen_no = case_when(DNA_TRAY_CODE %in% WGC_5digits ~ as.integer(dna_specimen_no_7),
                                     TRUE ~ dna_specimen_no))
```

Any duplicates now?
```{r}
table(table(gillnet_torun_asl_mod$`Dna Specimen No`))
table(table(loki_tissue_gillnet$dna_specimen_no))
```

And everything still in LOKI?
```{r}
table(gillnet_torun_asl_mod$`Dna Specimen No` %in% loki_tissue_gillnet$dna_specimen_no)
```

```{r}
missing_fish2 <- setdiff(gillnet_torun_asl$`Dna Specimen No`, loki_tissue_gillnet$dna_specimen_no)

gillnet_torun_asl_mod <- gillnet_torun_asl_mod %>% 
  mutate(`Dna Specimen No` = case_when(`Dna Specimen No` %in% missing_fish2 ~ as.numeric(paste0(3, `Dna Specimen No`)),
                                       TRUE ~ `Dna Specimen No`))
```

Any duplicates now?
```{r}
table(table(gillnet_torun_asl_mod$`Dna Specimen No`))
table(table(loki_tissue_gillnet$dna_specimen_no))
```

And everything still in LOKI?
```{r}
table(gillnet_torun_asl_mod$`Dna Specimen No` %in% loki_tissue_gillnet$dna_specimen_no)
```

Excellent, all present and accounted for. Verify that we have the correct numbers of fish per district
```{r}
gillnet_torun_asl_mod %>% 
  count(District)
```

### More Discrepancies

ASL says one district, but Silly Code is another
```{r}
gillnet_torun_asl_mod %>% 
  left_join(loki_tissue_gillnet, by = c(`Dna Specimen No` = "dna_specimen_no")) %>% 
  count(District, `Silly Code`)
```

```{r}
gillnet_torun_asl_mod %>% 
  left_join(loki_tissue_gillnet, by = c(`Dna Specimen No` = "dna_specimen_no")) %>% 
  filter(District == 101 & `Silly Code` == "KGILL19D8")
```

Pick two different fish
```{r}
asl_gillnet %>% 
  filter(District == 101 & `Stat Week` == 27) %>% 
  anti_join(gillnet_torun_asl_mod, by = c("Scale Card No", "Specimen Number", "Average Length mm", "Sample Date"))
```

```{r}
gillnet_torun_asl_mod <- gillnet_torun_asl_mod %>% 
  filter(!`Dna Specimen No` %in% c(419609, 419101)) %>% 
  bind_rows(asl_gillnet %>% filter(`Dna Specimen No` %in% c(500601, 500603)))
```

Any duplicates now?
```{r}
table(table(gillnet_torun_asl_mod$`Dna Specimen No`))
table(table(loki_tissue_gillnet$dna_specimen_no))
```

And everything still in LOKI?
```{r}
table(gillnet_torun_asl_mod$`Dna Specimen No` %in% loki_tissue_gillnet$dna_specimen_no)
```

Excellent, all present and accounted for. Verify that we have the correct numbers of fish per district
```{r}
gillnet_torun_asl_mod %>% 
  count(District)
```

### Format

Join LOKI Tissue Table with ASL and format for Extraction List Template
```{r}
(gillnet_torun_extraction <- gillnet_torun_asl_mod %>% 
   left_join(loki_tissue_gillnet, by = c(`Dna Specimen No` = "dna_specimen_no")) %>% 
   mutate(`WELL CODE` = str_pad(DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   mutate(`TISSUE TYPE` = str_replace(PK_TISSUE_TYPE, pattern = " Process", replacement = "")) %>% 
   mutate(`TISSUE TYPE` = str_replace(`TISSUE TYPE`, pattern = " Clip", replacement = "")) %>% 
   rename(SILLY = `Silly Code`, `SAMPLE #` = FK_FISH_ID, `WGC BARCODE` = `DNA_TRAY_CODE`) %>% 
   select(SILLY, `SAMPLE #`, `WGC BARCODE`, `WELL CODE`, `TISSUE TYPE`) %>% 
   arrange(SILLY, `WGC BARCODE`, `WELL CODE`)
)
```

### Write
```{r}
write_csv(gillnet_torun_extraction, path = "../Extraction Lists/Gillnet_Extraction.csv")

gillnet_torun_extraction %>% 
  count(SILLY, `TISSUE TYPE`)
```

# Summer Troll

Mon Oct 21 11:52:28 2019

Going to do Summer Retention 1 and 2 first because it is easier than Spring (Quad and period vs. Stat Area and month).

## ASL Data

### Read raw ASL
```{r}
(asl_summer <- read_csv(file = "../ASL Data/20191021_Detailed ASL Samples.csv"))
```

### Manipulate ASL

Samples by stat week
```{r}
asl_summer %>% 
  count(Year, `Stat Week`) %>%
  spread(Year, n, fill = 0)
```

Verify break between spring, summer, and early winter
```{r}
asl_summer %>% 
  count(Year, `Harvest Code`, `Stat Week`) %>% 
  filter(`Stat Week` >= 25 & `Stat Week` <= 38)
```

Assign fishery
```{r}
(asl_summer <- asl_summer %>% 
   mutate(Year_f = factor(Year)) %>% 
   rename(Quadrant = District) %>% 
   mutate(Fishery = case_when(Harvest == "Spring Troll Fishery" ~ "Spring",
                              Harvest == "Traditional State Managed Fisheries" & `Stat Week` <= 11 ~ "Late Winter",
                              Harvest == "Traditional State Managed Fisheries" & `Stat Week` >= 41 ~ "Early Winter",
                              Harvest == "Traditional State Managed Fisheries" & `Stat Week` >= 27 & `Stat Week` <= 31 ~ "Summer Ret 1",
                              Harvest == "Traditional State Managed Fisheries" & `Stat Week` >= 32 & `Stat Week` <= 36 ~ "Summer Ret 2")) %>% 
   mutate(Fishery = factor(Fishery, levels = c("Late Winter", "Spring", "Summer Ret 1", "Summer Ret 2", "Early Winter")))
)
```


### Visualize ASL

Samples by fishery and quadrant
```{r}
asl_summer %>% 
  filter(!is.na(`Dna Specimen No`)) %>% 
  count(Year, Fishery, Quadrant) %>% 
  filter(Year == 2019 & Fishery == "Summer Ret 1" | Year == 2019 & Fishery == "Summer Ret 2") %>% 
  spread(Quadrant, n)
```

Check out spring real quick...
```{r}
asl_summer %>% 
  filter(!is.na(`Dna Specimen No`)) %>% 
  count(Year, Fishery, Quadrant) %>% 
  filter(Year == 2019 & Fishery == "Spring") %>% 
  spread(Quadrant, n, fill = 0)
```

```{r}
asl_summer %>% 
  ggplot(aes(x = `Stat Week`, fill = Fishery)) +
  geom_bar() +
  facet_grid(Year ~ .) +
  ggtitle("Samples by Stat Week")
```

### Read Tissue Table from *LOKI*
Excellent! Next we'll pull tissue collection info from OceanAK and join, need full 10 digit WGC number and Sample number
```{r}
(loki_tissue_summer <- read_csv(file = "../OceanAK/GEN_SAMPLED_FISH_TISSUE_KTROL19SU.csv") %>% 
   filter(is.na(IS_MISSING_PAIRED_DATA_EXISTS)) %>%  # make sure we aren't issing the tissue
   select(`Silly Code`, FK_FISH_ID, DNA_TRAY_CODE, DNA_TRAY_WELL_CODE, PK_TISSUE_TYPE) %>% 
   mutate(WGC_4digit = str_sub(DNA_TRAY_CODE, 7, 10)) %>% 
   mutate(WGC_2digit_pos = str_pad(string = DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   unite(dna_specimen_no, c(WGC_4digit, WGC_2digit_pos), sep = '', remove = FALSE) %>% 
   mutate(dna_specimen_no = as.integer(dna_specimen_no))
)
```

### Duplicates in Dna Specimen Number
Any duplicates in *LOKI* or ASL?
```{r}
asl_summer <- asl_summer %>% 
  filter(Fishery %in% c("Summer Ret 1", "Summer Ret 2") & Year == 2019)

table(table(loki_tissue_summer$dna_specimen_no))
table(table(asl_summer$`Dna Specimen No`))
```

Shit, I need to deal with all of the duplicates in *LOKI* before doing anything else or it will cause problems with joining the OceanAK data with the ASL data by `Dna Specimen No`. Figure out which cards are the issue.
```{r}
loki_dups <- loki_tissue_summer %>% 
  count(dna_specimen_no, WGC_4digit) %>% 
  filter(n > 1) %>% 
  distinct(WGC_4digit) %>% 
  pull(WGC_4digit)

loki_tissue_summer %>% 
  filter(WGC_4digit %in% loki_dups) %>% 
  select(DNA_TRAY_CODE, WGC_4digit) %>% 
  arrange(WGC_4digit) %>% 
  distinct()
```

And where are they in ASL (i.e. where are they from?)
```{r}
asl_summer %>% 
  mutate(WGC_4digit = str_sub(string = `Dna Specimen No`, start = 1, end = 4)) %>% 
  filter(WGC_4digit %in% loki_dups) %>% 
  select(WGC_4digit, `Sample Date`, Quadrant, `Port Code`, `Stat Week`) %>% 
  arrange(WGC_4digit) %>% 
  distinct()
```

After checking Iris' sheet, the 100000XXXX WGC are from Wrangell and the 000003XXXX WGC are from Ketchikan!
```{r}
asl_summer <- asl_summer %>%
  mutate(WGC_4digit = str_sub(string = `Dna Specimen No`, start = 1, end = 4)) %>%
  mutate(`Dna Specimen No` = case_when(
      WGC_4digit %in% loki_dups & `Port Code` == "KTN" ~ as.numeric(paste0(3, `Dna Specimen No`)),
      TRUE ~ `Dna Specimen No`
    )
  )
```

Did we fix ASL?
```{r}
table(table(asl_summer$`Dna Specimen No`))
table(nchar(asl_summer$`Dna Specimen No`))
```

Huzzah! Now to fix *LOKI*
```{r}
loki_tissue_summer <- loki_tissue_summer %>% 
  mutate(dna_specimen_no = case_when(
    DNA_TRAY_CODE %in% c("0000034199", "0000034204", "0000034210") ~ as.integer(paste0(3, dna_specimen_no)), 
    TRUE ~ dna_specimen_no
  ))
```

Did we fix *LOKI*?
```{r}
table(table(loki_tissue_summer$dna_specimen_no))
table(nchar(loki_tissue_summer$dna_specimen_no))
```

Cool beans. There were 3 sets of cards with duplicate WGC_4digit (last 4). We identified which ones were 100000XXXX vs. 000003XXXX and assigned the 000003XXXX fish a 7 digit Dna Specimen No that includes the 3. This was done both on the *OceanAK* side and the *ASL* side. So we shouldn't have any issues when we pick fish.

## Harvest Data

### Read Fish Ticket Data
```{r}
(harvest_summer <- read_csv(file = "../Harvest Data/20191021_ft - Detailed Fish Tickets.csv"))
```

### Manipulate Harvest

Don't forget the weird "3rd" retention period for 2019 designed to "mop up" any remaining quota post-2nd retention.
```{r}
(harvest_summer <- harvest_summer %>% 
   mutate(Quadrant = case_when(District %in% c(113, 114, 116, 154, 156, 157) | District >= 181 ~ 171,
                               District %in% c(103, 104, 152) ~ 172,
                               District %in% c(109, 110, 111, 112, 115) ~ 173,
                               District %in% c(101, 102, 105, 106, 107, 108) ~ 174)) %>% 
   mutate(Year_f = factor(Year)) %>% 
   mutate(Fishery = case_when(`Harvest Code` == 13 ~ "Spring",
                              `Harvest Code` == 11 & `Stat Week` <= 17 ~ "Late Winter",
                              `Harvest Code` == 11 & `Stat Week` >= 41 ~ "Early Winter",
                              `Harvest Code` == 11 & `Stat Week` >= 27 & `Stat Week` <= 28 ~ "Summer Ret 1",
                              `Harvest Code` == 11 & `Stat Week` >= 33 & `Stat Week` <= 34 ~ "Summer Ret 2",
                              `Harvest Code` == 11 & `Stat Week` >= 35 & `Stat Week` <= 40 ~ "Summer Ret 3")) %>% 
   mutate(Fishery = factor(Fishery, levels = c("Late Winter", "Spring", "Summer Ret 1", "Summer Ret 2", "Summer Ret 3", "Early Winter")))
)
```

### Visualize Harvest
```{r}
harvest_summer %>% 
  group_by(Year, Fishery, Quadrant) %>% 
  summarise(harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  filter(Year == 2019 & Fishery == "Summer Ret 1" | Year == 2019 & Fishery == "Summer Ret 2") %>% 
  spread(Quadrant, harvest)
```

```{r}
harvest_summer %>% 
  filter(`Stat Week` >= 26 & `Stat Week` <= 41) %>% 
  group_by(Year, `Stat Week`, Fishery) %>% 
  summarize(harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  spread(Year, harvest, fill = 0)
```

## Join ASL and Harvest
```{r}
harvest_sw_quadrant <- harvest_summer %>% 
  filter(Year == 2019 & Fishery == "Summer Ret 1" | Year == 2019 & Fishery == "Summer Ret 2") %>% 
  group_by(Year, Fishery, `Stat Week`, `Harvest Code`, Quadrant) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`)) 

(join_summer <- asl_summer %>% 
    filter(!is.na(`Dna Specimen No`)) %>% 
    filter(Year == 2019 & Fishery == "Summer Ret 1" | Year == 2019 & Fishery == "Summer Ret 2") %>% 
    count(Year, Fishery, `Stat Week`, Quadrant) %>% 
    full_join(harvest_sw_quadrant, by = c("Year", "Fishery", "Stat Week", "Quadrant")) %>% 
    replace_na(list(n = 0, Harvest = 0)) %>% 
    select(Year, Fishery, `Stat Week`, Quadrant, n , Harvest)
)

join_summer %>% 
  filter(n > Harvest)
```

### Plot ASL samples and harvest as proportions by fishery

This year, each fishery only lasted 1 stat week, so that makes things verrrrry easy.
```{r}
join_summer %>% 
  group_by(Fishery, Quadrant) %>% 
  mutate(n = n / sum(n), harvest = Harvest / sum(Harvest)) %>% 
  ungroup() %>% 
  gather(variable, proportion, -`Stat Week`, -`Quadrant`, - Harvest, - Fishery, - Year) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = pretty_breaks()) +
  facet_grid(`Quadrant` ~ variable, scales = "fixed") +
  ggtitle("Proportion of Samples and Harvest\nby Stat Week and Quadrant for Summer Troll AY19") +
  theme_bw()
```

## Summer Selection Combined

After checking with Grant (AMB) and Dani (treaty czaress), we are going to go with the same plan as last year. Enough fish to report NO and SO as stand-alone, 50 each from the others. Selection is very simple this year as each fishery only occured during a single statistical week.
```{r}
(extraction_summer <- tribble(
  ~Fishery, ~Quadrant, ~n,
  "Summer Ret 1", 171, 380,
  "Summer Ret 1", 172, 220,
  "Summer Ret 1", 173, 50,
  "Summer Ret 1", 174, 50,
  "Summer Ret 2", 171, 220,
  "Summer Ret 2", 172, 120,
  "Summer Ret 2", 173, 50,
  "Summer Ret 2", 174, 50,
)
)
```

Ignore statistical week, as the fishery was only open for a single week. **Note**, some ASL samples were taken the following week when fish were offloaded.

Randomly pick fish per Fishery and Quadrant
```{r}
summer_torun_asl <- asl_summer %>% 
  filter(Year == 2019, Fishery %in% c("Summer Ret 1", "Summer Ret 2")) %>% 
  nest(-Fishery, -Quadrant) %>% 
  right_join(extraction_summer, by = c("Fishery", "Quadrant")) %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample) %>% 
  select(-data)
```

Verify picked fish
```{r}
summer_torun_asl %>% 
  count(Fishery, Quadrant) %>% 
  spread(Quadrant, n, fill = 0)
```

```{r}
save_objects(objects = "summer_torun_asl", path = "../Objects/")
```


## Write Summer Extraction List

We already dealt with duplicate issues at the beginning, so now we should just have to see if all of our ASL fish exist in OceanAK.

### Compare with *LOKI*
Are all my extraction fish in the LOKI tissue table?
```{r}
table(summer_torun_asl$`Dna Specimen No` %in% loki_tissue_summer$dna_specimen_no)
```

### Resolve Discrepancies
Looks like we are missing 4 fish..., but which ones???
```{r}
missing_fish <- sort(setdiff(summer_torun_asl$`Dna Specimen No`, loki_tissue_summer$dna_specimen_no))

summer_torun_asl %>% 
  filter(`Dna Specimen No` %in% missing_fish) %>% 
  select(Fishery, Quadrant, `Stat Week`, `Dna Specimen No`)
```

Do these two Whatman cards exist in LOKI?
```{r}
sum(grepl(pattern = 2432, x = loki_tissue_summer$WGC_4digit))
sum(grepl(pattern = 2240, x = loki_tissue_summer$WGC_4digit))
sum(grepl(pattern = 3900, x = loki_tissue_summer$WGC_4digit))
sum(grepl(pattern = 3894, x = loki_tissue_summer$WGC_4digit))
```

One card is completely missing. After reviewing Iris' summary, there is 3903-3906, which one got miscoded?
```{r}
asl_summer %>% 
  filter(`Dna Specimen No` >= 390000 & `Dna Specimen No` <= 390610) %>% 
  count(WGC_4digit)
```

Looks like 3904 is the 3900 incident.

I decided to forgo checking the physical Whatman card, we are just going to make this change. I'll modify those `Dna Specimen No` now.
```{r}
summer_torun_asl_mod <- summer_torun_asl %>% 
  mutate(`Dna Specimen No` = as.numeric(str_replace(string = as.character(`Dna Specimen No`), pattern = "3900", replacement = "3904")))
```

As for fish 243207, it looks like we only have 9 in LOKI from that Whatman card, how many did we want to extract?
```{r}
summer_torun_asl[grep(pattern = 243207, x = summer_torun_asl$`Dna Specimen No`), ] %>% 
  arrange(`Dna Specimen No`)
```

Looks like we wanted 1 total, so we can just drop 243207 and replace with another one.
```{r}
summer_torun_asl_mod <- summer_torun_asl_mod %>% 
  filter(`Dna Specimen No` != 243207) %>% 
  bind_rows(filter(asl_summer, `Dna Specimen No` == 243206))
```

As for fish 224003, it looks like we only have 9 in LOKI from that Whatman card, how many did we want to extract?
```{r}
summer_torun_asl[grep(pattern = 2240, x = summer_torun_asl$`Dna Specimen No`), ] %>% 
  arrange(`Dna Specimen No`)
```

Looks like we wanted 7 total, so we can just drop 243207 and replace with another one.
```{r}
summer_torun_asl_mod <- summer_torun_asl_mod %>% 
  filter(`Dna Specimen No` != 224003) %>% 
  bind_rows(filter(asl_summer, `Dna Specimen No` == 224001))
```

As for fish 389409, it looks like we only have 9 in LOKI from that Whatman card, how many did we want to extract?
```{r}
summer_torun_asl[grep(pattern = 3894, x = summer_torun_asl$`Dna Specimen No`), ] %>% 
  arrange(`Dna Specimen No`)
```

Looks like we wanted 3 total, so we can just drop 389409 and replace with another one.
```{r}
summer_torun_asl_mod <- summer_torun_asl_mod %>% 
  filter(`Dna Specimen No` != 389409) %>% 
  bind_rows(filter(asl_summer, `Dna Specimen No` == 389407))
```

Now is everything in LOKI?
```{r}
table(summer_torun_asl_mod$`Dna Specimen No` %in% loki_tissue_summer$dna_specimen_no)
```

And still no duplicates?
```{r}
table(table(summer_torun_asl_mod$`Dna Specimen No`))
```

Excellent, all present and accounted for. Verify that we have the correct numbers of fish per fishery/quadrant
```{r}
summer_torun_asl_mod %>% 
  count(Fishery, Quadrant) %>% 
  spread(Quadrant, n, fill = 0)
```

Victory is mine!!!
```{r}
save_objects(objects = "summer_torun_asl_mod", path = "../Objects/")
```


### Format

Join LOKI Tissue Table with ASL and format for Extraction List Template
```{r}
(summer_torun_extraction <- summer_torun_asl_mod %>% 
   left_join(loki_tissue_summer, by = c(`Dna Specimen No` = "dna_specimen_no")) %>% 
   mutate(`WELL CODE` = str_pad(DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   mutate(`TISSUE TYPE` = str_replace(PK_TISSUE_TYPE, pattern = " Process", replacement = "")) %>% 
   mutate(`TISSUE TYPE` = str_replace(`TISSUE TYPE`, pattern = " Clip", replacement = "")) %>% 
   rename(SILLY = `Silly Code`, `SAMPLE #` = FK_FISH_ID, `WGC BARCODE` = `DNA_TRAY_CODE`) %>% 
   select(SILLY, `SAMPLE #`, `WGC BARCODE`, `WELL CODE`, `TISSUE TYPE`) %>% 
   arrange(SILLY, `WGC BARCODE`, `WELL CODE`)
)
```

### Write
```{r}
write_csv(summer_torun_extraction, path = "../Extraction Lists/Summer_Extraction.csv")

summer_torun_extraction %>% 
  count(SILLY, `TISSUE TYPE`)
```

# Spring Troll

Mon Oct 21 13:25:12 2019

Spring troll is messy because we do things by Month and Stat Area

## ASL Data

Need to read in ASL data from Iris to get the District/Sub-District data.
### Read raw ASL
```{r}
(asl_spring <- read_csv(file = "../Associated Data/Spring/2019 Spring Troll Chinook with Dist Sub Dist (version 1).csv"))
```

### Manipulate ASL

Samples by stat week
```{r}
asl_spring %>% 
  count(`Harvest Code`, `Stat Week`)
```

Assign fishery, month, and stat area
```{r}
(asl_spring <- asl_spring %>% 
   mutate(`Sample Date` = mdy(`Sample Date`)) %>% 
   mutate(Year_f = factor(Year)) %>% 
   mutate(Fishery = case_when(Harvest == "Spring Troll Fishery" ~ "Spring")) %>% 
   mutate(Fishery = factor(Fishery, levels = c("Late Winter", "Spring", "Summer Ret 1", "Summer Ret 2", "Early Winter"))) %>% 
   mutate(Month = case_when(`Stat Week` <= 22 ~ "May",
                            `Stat Week` >= 23 ~ "June")) %>%  # update! anything SW22 and less is May
   mutate(Month = factor(Month, levels = c("May", "June"))) %>% 
   mutate(month = month(`Sample Date`, label = TRUE, abbr = FALSE)) %>% 
   mutate(subdistrict = str_pad(string = `Sub-District`, width = 2, side = "left", pad = "0")) %>% 
   unite("Stat Area", c(District, subdistrict), sep = '', remove = FALSE)
)
```

Investigate month discrepancies. Planning to stick with "Month" as defined by stat week as opposed to sample date.
```{r}
asl_spring %>% 
  filter(Month == "May" & month == "June") %>% 
  count(`Stat Area`)
```

### Visualize ASL

Samples by month and stat area
```{r, fig.width=8, fig.height=10}
asl_spring %>% 
  filter(Fishery == "Spring" & Year == "2019") %>%
  filter(!is.na(`Dna Specimen No`)) %>% 
  ggplot(aes(x = `Stat Week`, fill = Fishery)) +
  geom_bar() +
  scale_x_continuous(breaks = 18:27) +
  facet_grid(`Stat Area` ~ Month) +
  ylab("# DNA Samples") +
  ggtitle("Samples by Stat Week and Stat Area for Spring AY19")
```

Samples by month and stat area
```{r, fig.width=8}
asl_spring %>% 
  filter(Fishery == "Spring" & Year == "2019") %>%
  filter(!is.na(`Dna Specimen No`)) %>% 
  ggplot(aes(x = `Stat Week`, fill = Fishery)) +
  geom_bar() +
  scale_x_continuous(breaks = 18:27) +
  facet_grid(Quadrant ~ Month) +
  ylab("# DNA Samples") +
  ggtitle("Samples by Stat Week and Quadrant for Spring AY19")
```

```{r}
asl_spring %>% 
  filter(Fishery == "Spring" & Year == "2019") %>%
  filter(!is.na(`Dna Specimen No`)) %>% 
  count(Year_f, Quadrant, Fishery, Month) %>% 
  spread(Quadrant, n, fill = 0)
```

## Harvest Data

### Read Fish Ticket Data
```{r}
(harvest_spring <- read_csv(file = "../Harvest Data/20191021_ft - Detailed Fish Tickets.csv"))
```

### Manipulate Harvest

Don't forget the weird "3rd" retention period for 2019 designed to "mop up" any remaining quota post-2nd retention.
```{r}
(harvest_spring <- harvest_spring %>% 
   filter(`Harvest Code` == 13) %>% 
   mutate(Quadrant = case_when(District %in% c(113, 114, 116, 154, 156, 157) | District >= 181 ~ 171,
                               District %in% c(103, 104, 152) ~ 172,
                               District %in% c(109, 110, 111, 112, 115) ~ 173,
                               District %in% c(101, 102, 105, 106, 107, 108) ~ 174)) %>% 
   mutate(Month = case_when(`Stat Week` <= 22 ~ "May",
                            `Stat Week` >= 23 ~ "June")) %>%  # update! anything SW22 and less is May
   mutate(Month = factor(Month, levels = c("May", "June")))
   )
```

### Visualize Harvest
```{r, fig.width=8, fig.height=10}
harvest_spring %>% 
  filter(`Harvest Code` == 13 & Year == 2019) %>%
  group_by(`Stat Week`, `Harvest Code`, `Stat Area`, Month) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`)) %>% 
  ggplot(aes(x = `Stat Week`, y = Harvest, fill = `Harvest Code`)) +
  geom_col() +
  scale_x_continuous(breaks = 18:27) +
  facet_grid(`Stat Area` ~ Month) +
  ggtitle("Harvest by Stat Week and Stat Area for Spring AY19")
```

```{r, fig.width=8}
harvest_spring %>% 
  filter(`Harvest Code` == 13 & Year == 2019) %>%
  group_by(`Stat Week`, `Harvest Code`, Quadrant, Month) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`)) %>% 
  ggplot(aes(x = `Stat Week`, y = Harvest, fill = `Harvest Code`)) +
  geom_col() +
  scale_x_continuous(breaks = 18:27) +
  facet_grid(Quadrant ~ Month) +
  ggtitle("Harvest by Stat Week and Quadrant for Spring AY19")
```

```{r}
harvest_spring %>% 
  filter(`Harvest Code` == 13 & Year == 2019) %>%
  group_by(`Harvest Code`, Quadrant, Month) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`)) %>% 
  spread(Quadrant, Harvest, fill = 0)
```

```{r}
harvest_spring %>% 
  mutate(`Stat Area` = factor(x = `Stat Area`, levels = sort(unique(`Stat Area`)))) %>% 
  filter(`Harvest Code` == 13 & Year == 2019) %>%
  group_by(`Stat Week`, `Stat Area`) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`)) %>% 
  ggplot(aes(x = `Stat Week`, y = `Stat Area`, fill = Harvest, label = Harvest)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "black", na.value = "white") +
  scale_x_continuous(breaks = 18:27) +
  theme_classic() +
  geom_text(color = "red") +
  ggtitle("Spring - Harvest by Stat Week and Stat Area")
```

## Join ASL and Harvest

```{r}
# Roll up harvest to Quad level
harvest_sw_statarea <- harvest_spring %>% 
  filter(`Harvest Code` == 13 & Year == 2019) %>%
  mutate(`Stat Area` = as.character(`Stat Area`)) %>% 
  group_by(`Stat Week`, `Harvest Code`, `Stat Area`, Quadrant, Month) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`)) 


# Roll up ASL to SW and Quad level, join with harvest
(join_spring <- asl_spring %>% 
    filter(Fishery == "Spring" & Year == 2019) %>%
    filter(!is.na(`Dna Specimen No`)) %>%  # filter for known DNA samples
    count(Fishery, `Stat Week`, `Stat Area`, Month) %>% 
    full_join(harvest_sw_statarea, by = c("Stat Week", "Stat Area", "Month")) %>%  # very important to do a full join in case some weeks are missing harvest or samples
    replace_na(list(n = 0, Harvest = 0)) %>%  # replace NA in samples and harvest with 0
    select(`Stat Area`, Month, `Stat Week`, n, Harvest)
)
```

```{r}
join_spring %>% 
  filter(n > Harvest)  # should be 0 rows...
```

### Plot ASL samples and harvest as proportions by fishery


```{r fig.width=8, fig.height=10}
join_spring %>% 
  select(`Stat Area`, `Stat Week`, n , Harvest) %>% 
  group_by(`Stat Area`) %>% 
  mutate(n = n / sum(n), harvest = Harvest / sum(Harvest)) %>% 
  ungroup() %>% 
  gather(variable, proportion, -`Stat Week`, -`Stat Area`, - Harvest) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = 18:27) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Proportion of Samples and Harvest\nby Stat Week and Stat Area for Spring Troll AY19")
```


