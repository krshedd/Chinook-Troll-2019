---
title: "Extraction Lists AY 2019"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

## Setup

Load all necessary packages.
```{r setup, message=FALSE, results='hide'}
library(tidyverse)
library(lubridate)
library(scales)

source("~/../R/Functions.GCL.R")
load_objects("../Objects/")
```

# Winter Troll

## ASL Data

### Read raw ASL
```{r}
(asl_winter <- read_csv(file = "../ASL Data/20190813_Harvest - Detailed ASL Samples.csv"))
```

### Manipulate ASL
```{r}
(asl_winter <- asl_winter %>% 
   mutate(Year_f = factor(Year)) %>% 
   rename(Quadrant = District) %>% 
   mutate(Fishery = case_when(Harvest == "Spring Troll Fishery" ~ "Spring",
                              Harvest == "Traditional State Managed Fisheries" & `Stat Week` <= 18 ~ "Late Winter",
                              Harvest == "Traditional State Managed Fisheries" & `Stat Week` >= 41 ~ "Early Winter",
                              Harvest == "Traditional State Managed Fisheries" & `Stat Week` >= 26 & `Stat Week` <= 31 ~ "Summer Ret 1",
                              Harvest == "Traditional State Managed Fisheries" & `Stat Week` >= 32 & `Stat Week` <= 36 ~ "Summer Ret 2")) %>% 
   mutate(Fishery = factor(Fishery, levels = c("Late Winter", "Spring", "Summer Ret 1", "Summer Ret 2", "Early Winter")))
)
```

### Visualize ASL
```{r}
asl_winter %>% 
  filter(!is.na(`Dna Specimen No`)) %>% 
  count(Year, Fishery, Quadrant) %>% 
  filter(Year == 2018 & Fishery == "Early Winter" | Year == "2019" & Fishery == "Late Winter") %>% 
  spread(Quadrant, n)
```


## Harvest Data

### Read Fish Ticket Data
```{r}
(harvest_winter <- read_csv(file = "../Harvest Data/20190813_ft - Detailed Fish Tickets.csv"))
```

### Manipulate Harvest
```{r}
(harvest_winter <- harvest_winter %>% 
   mutate(Quadrant = case_when(District %in% c(113, 114, 116, 154, 156, 157) | District >= 181 ~ 171,
                               District %in% c(103, 104, 152) ~ 172,
                               District %in% c(109, 110, 111, 112, 115) ~ 173,
                               District %in% c(101, 102, 105, 106, 107, 108) ~ 174)) %>% 
   mutate(Year_f = factor(Year)) %>% 
   mutate(Fishery = case_when(`Harvest Code` == 13 ~ "Spring",
                              `Harvest Code` == 11 & `Stat Week` <= 18 ~ "Late Winter",
                              `Harvest Code` == 11 & `Stat Week` >= 41 ~ "Early Winter",
                              `Harvest Code` == 11 & `Stat Week` >= 26 & `Stat Week` <= 31 ~ "Summer Ret 1",
                              `Harvest Code` == 11 & `Stat Week` >= 32 & `Stat Week` <= 36 ~ "Summer Ret 2")) %>% 
   mutate(Fishery = factor(Fishery, levels = c("Late Winter", "Spring", "Summer Ret 1", "Summer Ret 2", "Early Winter")))
)
```

### Visualize Harvest
```{r}
harvest_winter %>% 
  group_by(Year, Fishery, Quadrant) %>% 
  summarise(harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  filter(Year == 2018 & Fishery == "Early Winter" | Year == "2019" & Fishery == "Late Winter") %>% 
  spread(Quadrant, harvest)
```

## Join ASL and Harvest
```{r}
harvest_sw_quadrant <- harvest_winter %>% 
  filter(Year == 2018 & Fishery == "Early Winter" | Year == "2019" & Fishery == "Late Winter") %>% 
  group_by(Year, Fishery, `Stat Week`, `Harvest Code`, Quadrant) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`)) 

(join_winter <- asl_winter %>% 
    filter(!is.na(`Dna Specimen No`)) %>% 
    filter(Year == 2018 & Fishery == "Early Winter" | Year == "2019" & Fishery == "Late Winter") %>% 
    count(Year, Fishery, `Stat Week`, Quadrant) %>% 
    full_join(harvest_sw_quadrant, by = c("Year", "Fishery", "Stat Week", "Quadrant")) %>% 
    replace_na(list(n = 0, Harvest = 0)) %>% 
    select(Year, Fishery, `Stat Week`, Quadrant, n , Harvest)
)

join_winter %>% 
  filter(n > Harvest)
```

### Plot ASL samples and harvest as proportions by fishery
```{r}
join_winter %>% 
  group_by(Fishery, Quadrant) %>% 
  mutate(n = n / sum(n), harvest = Harvest / sum(Harvest)) %>% 
  ungroup() %>% 
  gather(variable, proportion, -`Stat Week`, -`Quadrant`, - Harvest, - Fishery, - Year) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = pretty_breaks()) +
  facet_grid(`Quadrant` ~ variable, scales = "fixed") +
  ggtitle("Proportion of Samples and Harvest\nby Stat Week and Quadrant for Winter Troll AY19") +
  theme_bw()
```

## Early Winter Selection
```{r}
join_winter %>% 
  group_by(Year, Fishery, Quadrant) %>% 
  mutate(n = n / sum(n), Harvest = Harvest / sum(Harvest)) %>% 
  ungroup() %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  filter(Fishery == "Early Winter") %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Samples and Harvest by Stat Week and Quadrant for Early Winter AY19") +
  theme_bw()
```

Thus the plan for extraction is to pick as many fish as possible, with the important caveat of subsampling in proportion to harvest by SW for each quadrant.

**Business rule** is to take fish from within 2 SW on either side to fill in for missing

### 171

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_EW_171 <- join_winter %>% 
   filter(Fishery == "Early Winter" & Year == "2018" & Quadrant == 171) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 120)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in holes from some weeks according to our business rule of +/- 2 weeks.
```{r}
(extraction_EW_171 <- extraction_EW_171 %>% 
   mutate(n_extract = case_when(`Stat Week` == 42 ~ 8,
                                `Stat Week` == 43 ~ 4,
                                `Stat Week` == 46 ~ 15,
                                `Stat Week` == 49 ~ 16,
                                `Stat Week` == 50 ~ 3,
                                TRUE ~ n_extract)) %>%
   select(Quadrant, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_winter %>% 
  filter(Fishery == "Early Winter" & Year == "2018" & Quadrant == 171) %>% 
  full_join(extraction_EW_171, by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Early Winter AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
EW_171_torun <- asl_winter %>% 
  filter(Year == 2018, Fishery == "Early Winter" & Quadrant == 171) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_EW_171, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
EW_171_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 172

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_EW_172 <- join_winter %>% 
   filter(Fishery == "Early Winter" & Year == "2018" & Quadrant == 172) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 11)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in holes from some weeks according to our business rule of +/- 2 weeks. Run all fish!
```{r}
(extraction_EW_172 <- extraction_EW_172 %>% 
   mutate(n_extract = n) %>%
   select(Quadrant, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_winter %>% 
  filter(Fishery == "Early Winter" & Year == "2018" & Quadrant == 172) %>% 
  full_join(extraction_EW_172, by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Early Winter AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
EW_172_torun <- asl_winter %>% 
  filter(Year == 2018, Fishery == "Early Winter" & Quadrant == 172) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_EW_172, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
EW_172_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 173

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_EW_173 <- join_winter %>% 
   filter(Fishery == "Early Winter" & Year == "2018" & Quadrant == 173) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 110)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in holes from some weeks according to our business rule of +/- 2 weeks.
```{r}
(extraction_EW_173 <- extraction_EW_173 %>% 
   mutate(n_extract = case_when(`Stat Week` == 42 ~ 32,
                                `Stat Week` == 43 ~ 21,
                                `Stat Week` == 46 ~ 17,
                                `Stat Week` == 47 ~ 9,
                                `Stat Week` == 49 ~ 9,
                                TRUE ~ n_extract)) %>%
   select(Quadrant, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_winter %>% 
  filter(Fishery == "Early Winter" & Year == "2018" & Quadrant == 173) %>% 
  full_join(extraction_EW_173, by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Early Winter AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
EW_173_torun <- asl_winter %>% 
  filter(Year == 2018, Fishery == "Early Winter" & Quadrant == 173) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_EW_173, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
EW_173_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 174

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_EW_174 <- join_winter %>% 
   filter(Fishery == "Early Winter" & Year == "2018" & Quadrant == 174) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 100)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in holes from some weeks according to our business rule of +/- 2 weeks.
```{r}
(extraction_EW_174 <- extraction_EW_174 %>% 
   mutate(n_extract = case_when(`Stat Week` == 42 ~ 36,
                                `Stat Week` == 43 ~ 18,
                                `Stat Week` == 48 ~ 7,
                                `Stat Week` == 49 ~ 13,
                                `Stat Week` == 50 ~ 2,
                                TRUE ~ n_extract)) %>%
   select(Quadrant, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_winter %>% 
  filter(Fishery == "Early Winter" & Year == "2018" & Quadrant == 174) %>% 
  full_join(extraction_EW_174, by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Early Winter AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
EW_174_torun <- asl_winter %>% 
  filter(Year == 2018, Fishery == "Early Winter" & Quadrant == 174) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_EW_174, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
EW_174_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### Early Winter Extraction

Combine in to a single tibble.
```{r}
EW_torun_asl <- bind_rows(EW_171_torun, EW_172_torun, EW_173_torun, EW_174_torun)
EW_torun_asl %>% 
  count(Quadrant)

save_objects("EW_torun_asl", path = "../Objects")
```

Plot proportions
```{r}
join_winter %>% 
  filter(Fishery == "Early Winter" & Year == "2018") %>% 
  full_join(EW_torun_asl %>% count(Quadrant, `Stat Week`), by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  replace_na(list(n_sample = 0, n_extract = 0, Harvest = 0)) %>%  # replace NA in samples and harvest with 0
  group_by(Quadrant) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Early Winter AY19") +
  theme_bw()
```


## Late Winter Selection
```{r}
join_winter %>% 
  group_by(Year, Fishery, Quadrant) %>% 
  mutate(n = n / sum(n), Harvest = Harvest / sum(Harvest)) %>% 
  ungroup() %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  filter(Fishery == "Late Winter") %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Samples and Harvest by Stat Week and Quadrant for Late Winter AY19") +
  theme_bw()
```

Thus the plan for extraction is to pick ~380 for 171 (NO), ~190 for 173 (NI) and 174 (SI) and run everything for 172 (SO), with the important caveat of subsampling in proportion to harvest by SW for each quadrant.

**Business rule** is to take fish from within 2 SW on either side to fill in for missing

### 171

Plan is to subsample ~380 fish. What would proportional sampling look like?
```{r}
(extraction_LW_171 <- join_winter %>% 
   filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 171) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 380)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

No need to adjust, looks perfect!
```{r}
(extraction_LW_171 <- extraction_LW_171 %>% 
   mutate(n_extract = n_extract) %>%
   select(Quadrant, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_winter %>% 
  filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 171) %>% 
  full_join(extraction_LW_171, by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Late Winter AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
LW_171_torun <- asl_winter %>% 
  filter(Year == 2019, Fishery == "Late Winter" & Quadrant == 171) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_LW_171, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
LW_171_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 172

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_LW_172 <- join_winter %>% 
   filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 172) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 55)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in holes from some weeks according to our business rule of +/- 2 weeks. Run all fish!
```{r}
(extraction_LW_172 <- extraction_LW_172 %>% 
   mutate(n_extract = case_when(`Stat Week` == 3 ~ 10,
                                `Stat Week` == 6 ~ 5,
                                `Stat Week` == 7 ~ 5,
                                `Stat Week` == 10 ~ 10,
                                TRUE ~ n_extract)) %>%
   select(Quadrant, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_winter %>% 
  filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 172) %>% 
  full_join(extraction_LW_172, by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Late Winter AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
LW_172_torun <- asl_winter %>% 
  filter(Year == 2019, Fishery == "Late Winter" & Quadrant == 172) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_LW_172, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
LW_172_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 173

Plan is to subsample 120 fish. What would proportional sampling look like?
```{r}
(extraction_LW_173 <- join_winter %>% 
   filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 173) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 120)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in holes from some weeks according to our business rule of +/- 2 weeks.
```{r}
(extraction_LW_173 <- extraction_LW_173 %>% 
   mutate(n_extract = case_when(`Stat Week` == 2 ~ 5,
                                `Stat Week` == 5 ~ 13,
                                `Stat Week` == 6 ~ 6,
                                `Stat Week` == 9 ~ 13,
                                `Stat Week` == 49 ~ 9,
                                TRUE ~ n_extract)) %>%
   select(Quadrant, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_winter %>% 
  filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 173) %>% 
  full_join(extraction_LW_173, by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Late Winter AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
LW_173_torun <- asl_winter %>% 
  filter(Year == 2019, Fishery == "Late Winter" & Quadrant == 173) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_LW_173, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
LW_173_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 174

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_LW_174 <- join_winter %>% 
   filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 174) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 170)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in holes from some weeks according to our business rule of +/- 2 weeks.
```{r}
(extraction_LW_174 <- extraction_LW_174 %>% 
   mutate(n_extract = case_when(`Stat Week` == 5 ~ 47,
                                `Stat Week` == 7 ~ 19,
                                `Stat Week` == 9 ~ 19,
                                TRUE ~ n_extract)) %>%
   select(Quadrant, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_winter %>% 
  filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 174) %>% 
  full_join(extraction_LW_174, by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Late Winter AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
LW_174_torun <- asl_winter %>% 
  filter(Year == 2019, Fishery == "Late Winter" & Quadrant == 174) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_LW_174, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
LW_174_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### Late Winter Extraction

Combine in to a single tibble.
```{r}
LW_torun_asl <- bind_rows(LW_171_torun, LW_172_torun, LW_173_torun, LW_174_torun)
LW_torun_asl %>% 
  count(Quadrant)

save_objects("LW_torun_asl", path = "../Objects")
```

Plot proportions
```{r}
join_winter %>% 
  filter(Fishery == "Late Winter" & Year == "2019") %>% 
  full_join(LW_torun_asl %>% count(Quadrant, `Stat Week`), by = c("Quadrant", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  replace_na(list(n_sample = 0, n_extract = 0, Harvest = 0)) %>%  # replace NA in samples and harvest with 0
  group_by(Quadrant) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -Year, -`Stat Week`, -Fishery, -Quadrant) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(Quadrant ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Quadrant for Late Winter AY19") +
  theme_bw()
```

## Write Winter Extraction List

Combine Early and Late Winter into one list and confirm that all `Dna Specimen No` are 6 characters before splitting
```{r}
winter_torun_asl <- bind_rows(EW_torun_asl, LW_torun_asl)

table(nchar(winter_torun_asl$`Dna Specimen No`))
```

### Compare with *LOKI*
Excellent! Next we'll pull tissue collection info from OceanAK and join, need full 10 digit WGC number and Sample number
```{r}
(loki_tissue_winter <- read_csv(file = "../OceanAK/GEN_SAMPLED_FISH_TISSUE_KTROL18EW_KTROL19LW.csv") %>% 
   filter(is.na(IS_MISSING_PAIRED_DATA_EXISTS)) %>%  # make sure we aren't issing the tissue
   select(`Silly Code`, FK_FISH_ID, DNA_TRAY_CODE, DNA_TRAY_WELL_CODE, PK_TISSUE_TYPE) %>% 
   mutate(WGC_4digit = str_sub(DNA_TRAY_CODE, 7, 10)) %>% 
   mutate(WGC_2digit_pos = str_pad(string = DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   unite(dna_specimen_no, c(WGC_4digit, WGC_2digit_pos), sep = '', remove = FALSE) %>% 
   mutate(dna_specimen_no = as.integer(dna_specimen_no))
)
```

Are all my extraction fish in the LOKI tissue table?
```{r}
table(winter_torun_asl$`Dna Specimen No` %in% loki_tissue_winter$dna_specimen_no)
```

### Resolve Discrepancies
Looks like we are missing 5 fish..., but which ones???
```{r}
missing_fish <- sort(setdiff(winter_torun_asl$`Dna Specimen No`, loki_tissue_winter$dna_specimen_no))

winter_torun_asl %>% 
  filter(`Dna Specimen No` %in% missing_fish) %>% 
  select(Fishery, Quadrant, `Stat Week`, `Dna Specimen No`)
```

Do these two Whatman cards exist in LOKI?
```{r}
sum(grepl(pattern = 6474, x = loki_tissue_winter$DNA_TRAY_CODE))
sum(grepl(pattern = 4687, x = loki_tissue_winter$DNA_TRAY_CODE))
```

The first card does NOT exist in LOKI...

Perhaps there was a typo in the Whatman Card number, what barcodes do we have?
```{r}
loki_tissue_winter %>% 
  count(DNA_TRAY_CODE)
```

After Checking Iris' shipment summary sheet, I think that fish from Card 1000006474 are actually 1000004674...I will go double checked this by pulling the physical Whatman Card. 
```{r}
read_csv(file = "../OceanAK/GEN_SAMPLED_FISH_TISSUE_KTROL18EW_KTROL19LW.csv") %>% 
  filter(DNA_TRAY_CODE == "1000004674") %>% 
  select(DNA_TRAY_CODE, STORAGE_ID, UNIT, SHELF_RACK, SLOT)
```

After checking the physical Whatman card, I was correct, these fish are from 1000004674. I'll modify those `Dna Specimen No` now.
```{r}
winter_torun_asl_mod <- winter_torun_asl %>% 
  mutate(`Dna Specimen No` = as.numeric(str_replace(string = as.character(`Dna Specimen No`), pattern = "6474", replacement = "4674")))
```

As for fish 468702, it looks like we only have 1 in LOKI, how many did we want to extract?
```{r}
winter_torun_asl[grep(pattern = 4687, x = winter_torun_asl$`Dna Specimen No`), ]
```

Whoops, well it looks like we wanted all 2 fish from that Whatman card, but we only have one. Can we replace that missing fish with another from that stat week?
```{r}
join_winter %>% 
  filter(Fishery == "Late Winter" & Year == "2019" & Quadrant == 172) %>% 
  left_join(extraction_LW_172, by = c("Stat Week", "Quadrant"), suffix = c("_sample", "_extraction")) %>% 
  arrange(`Stat Week`)
```

Nope, looks like we are SOL, we are using all fish from SW 11 and the two prior weeks. We'll just have to drop this fish.
```{r}
winter_torun_asl_mod <- winter_torun_asl_mod %>% 
  filter(`Dna Specimen No` != 468702)
```

Now is everything in LOKI?
```{r}
table(winter_torun_asl_mod$`Dna Specimen No` %in% loki_tissue_winter$dna_specimen_no)
```

### Duplicates
Any duplicates?
```{r}
table(table(loki_tissue_winter$dna_specimen_no))
table(table(winter_torun_asl_mod$`Dna Specimen No`))
```

Shit, looks like two fish selected for extraction have the same Dna Specimen No, which are they?
```{r}
winter_torun_asl_mod %>% 
  count(`Dna Specimen No`) %>% 
  filter(n > 1)
```

Where are they from?
```{r}
winter_torun_asl_mod %>% 
  filter(`Dna Specimen No` == 445601)
```

Any more fish on these cards?
```{r}
winter_torun_asl_mod[grep(pattern = 4456, x = winter_torun_asl_mod$`Dna Specimen No`), ]
```

After reviewing Iris' sample summary sheets, 445601 is the Early Winter fish from 171, Juneau, SW 47. The Late Winter fish from 171, Juneau, SW10 should be 645601.

```{r}
(winter_torun_asl_mod <- winter_torun_asl_mod %>% 
   mutate(`Dna Specimen No` = case_when(`Stat Week` == 10 & `Dna Specimen No` == 445602 ~ 645602,
                                        `Stat Week` == 10 & `Dna Specimen No` == 445601 ~ 645601,
                                        TRUE ~ `Dna Specimen No`))
)
```

Any duplicates now?
```{r}
table(table(winter_torun_asl_mod$`Dna Specimen No`))
```

And everything still in LOKI?
```{r}
all(winter_torun_asl_mod$`Dna Specimen No` %in% loki_tissue_winter$dna_specimen_no)
```

Excellent, all present and accounted for. Verify that we have the correct numbers of fish per fishery/quadrant
```{r}
winter_torun_asl_mod %>% 
  count(Fishery, Quadrant) %>% 
  spread(Quadrant, n, fill = 0)
```

### Format

Join LOKI Tissue Table with ASL and format for Extraction List Template
```{r}
(winter_torun_extraction <- winter_torun_asl_mod %>% 
   left_join(loki_tissue_winter, by = c(`Dna Specimen No` = "dna_specimen_no")) %>% 
   mutate(`WELL CODE` = str_pad(DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   mutate(`TISSUE TYPE` = str_replace(PK_TISSUE_TYPE, pattern = " Process", replacement = "")) %>% 
   mutate(`TISSUE TYPE` = str_replace(`TISSUE TYPE`, pattern = " Clip", replacement = "")) %>% 
   rename(SILLY = `Silly Code`, `SAMPLE #` = FK_FISH_ID, `WGC BARCODE` = `DNA_TRAY_CODE`) %>% 
   select(SILLY, `SAMPLE #`, `WGC BARCODE`, `WELL CODE`, `TISSUE TYPE`) %>% 
   arrange(SILLY, `WGC BARCODE`, `WELL CODE`)
)
```

### Write
```{r}
write_csv(winter_torun_extraction, path = "../Extraction Lists/Winter_Extraction.csv")

winter_torun_extraction %>% 
  count(SILLY, `TISSUE TYPE`)
```

# TBR + Extra Gillnet

We normally run TBR samples which include all large Chinook (>660mm MEF) from District 108 + 111 between statistical weeks 17-29. In addition, this year we will be analyzing D115 SW 25-29 (looking for Chilkat + Taku) and D101 (Tree Point) SW 25-29. These will all be extracted and genotyped with Winter Troll.

## Sport TBR

### ASL Data
```{r}
(asl_sport_tbr <- read_csv("../Associated Data/Sport TBR/_2019_SEAK_SF_Whatman_AWL_31JUL19.csv"))
```

```{r}
(asl_sport_tbr <- asl_sport_tbr %>% 
   filter(DISTRICT %in% c(108, 111)) %>% 
   filter(STATWEEK >= 17 & STATWEEK <= 29) %>% 
   filter(LENGTH >= 660) %>% 
   filter(!is.na(Whatman_Card))
)
```

```{r}
asl_sport_tbr %>% 
  count(DISTRICT, STATWEEK) %>% 
  spread(DISTRICT, n, fill = 0)
```

### Sport TBR Selection

#### 108

Plan is to run all 108 fish since we only have 32.
```{r}
sport_tbr_108_torun <- asl_sport_tbr %>% 
  filter(DISTRICT == 108)
```

#### 111
Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_sport_tbr_111 <- asl_sport_tbr %>% 
   count(DISTRICT, STATWEEK) %>% 
   filter(DISTRICT == 111) %>% 
   arrange(STATWEEK) %>% 
   mutate(p = round(n / sum(n) * 200)) %>% 
   mutate(total = sum(p))
)
```

Randomly pick fish per week
```{r}
sport_tbr_111_torun <- asl_sport_tbr %>% 
  filter(DISTRICT == 111) %>% 
  nest(-STATWEEK) %>% 
  right_join(extraction_sport_tbr_111, by = "STATWEEK") %>% 
  mutate(Sample = map2(data, p, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
sport_tbr_111_torun %>% 
  count(STATWEEK) %>% 
  mutate(total = sum(n))
```

## Write Sport TBR Extraction List

Combine 108 and 111 into one list
```{r}
(sport_tbr_torun_asl <- bind_rows(sport_tbr_108_torun, sport_tbr_111_torun) %>% 
   mutate(Whatman_Card = str_pad(Whatman_Card, 10, "left", "0")) %>%  # pad WGC
   # mutate(SAMPLE_NO = str_pad(SAMPLE_NO, 2, "left", "0")) %>%  # pad well
   unite(silly_source, c("Whatman_Card", "SAMPLE_NO"), sep = "_", remove = FALSE)  # silly_source
)

save_objects("sport_tbr_torun_asl", path = "../Objects")
```

### Compare with *LOKI*
Excellent! Next we'll pull tissue collection info from OceanAK and join, need full 10 digit WGC number and Sample number
```{r}
(loki_tissue_sport_tbr <- read_csv(file = "../OceanAK/GEN_SAMPLED_FISH_TISSUE_KSPORT19.csv") %>% 
   filter(is.na(IS_MISSING_PAIRED_DATA_EXISTS)) %>%  # make sure we aren't issing the tissue
   select(`Silly Code`, FK_FISH_ID, DNA_TRAY_CODE, DNA_TRAY_WELL_CODE, PK_TISSUE_TYPE) %>% 
   unite(silly_source, c("DNA_TRAY_CODE", "DNA_TRAY_WELL_CODE"), sep = "_", remove = FALSE)  # silly_source
)
```

Are all my extraction fish in the LOKI tissue table?
```{r}
table(sport_tbr_torun_asl$silly_source %in% loki_tissue_sport_tbr$silly_source)
```

### Resolve Discrepancies
Looks like we are missing 2 fish..., but which ones???
```{r}
missing_fish <- sort(setdiff(sport_tbr_torun_asl$silly_source, loki_tissue_sport_tbr$silly_source))

sport_tbr_torun_asl %>% 
  filter(silly_source %in% missing_fish) %>% 
  select(DISTRICT, STATWEEK, SITE, silly_source)
```

Do these two Whatman cards exist in LOKI?
```{r}
loki_tissue_sport_tbr %>% 
  filter(DNA_TRAY_CODE %in% c("0000004315", "0000023782"))
```

Nope, evidently neither card exists in LOKI...

There are no more 108 fish available, so I'll just drop that one, but we do have additional D111 SW 26 fish to pick from, so I can replace that one.
```{r}
replacement_sport_tbr <- asl_sport_tbr %>% 
  filter(DISTRICT == 111 & STATWEEK == 26) %>% 
  mutate(Whatman_Card = str_pad(Whatman_Card, 10, "left", "0")) %>%  # pad WGC
  unite(silly_source, c("Whatman_Card", "SAMPLE_NO"), sep = "_", remove = FALSE) %>%  # silly_source
  anti_join(sport_tbr_torun_asl, by = "silly_source") %>% 
  sample_n(1)
```

Drop missing fish, add one replacement
```{r}
(sport_tbr_torun_asl_mod <- sport_tbr_torun_asl %>% 
   filter(!silly_source %in% missing_fish) %>% 
   bind_rows(replacement_sport_tbr)
)
```

### Duplicates

Any duplicates?
```{r}
table(table(loki_tissue_sport_tbr$silly_source))
table(table(sport_tbr_torun_asl_mod$silly_source))
```

Nope, excellent

Everything still in LOKI?
```{r}
all(sport_tbr_torun_asl_mod$silly_source %in% loki_tissue_sport_tbr$silly_source)
```

Excellent, all present and accounted for. Verify that we have the correct numbers of fish per District
```{r}
sport_tbr_torun_asl_mod %>% 
  count(DISTRICT)
```

### Format

Join LOKI Tissue Table with ASL and format for Extraction List Template
```{r}
(sport_tbr_torun_extraction <- sport_tbr_torun_asl_mod %>% 
   left_join(loki_tissue_sport_tbr, by = "silly_source") %>% 
   mutate(`WELL CODE` = str_pad(DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   mutate(`TISSUE TYPE` = str_replace(PK_TISSUE_TYPE, pattern = " Process", replacement = "")) %>% 
   mutate(`TISSUE TYPE` = str_replace(`TISSUE TYPE`, pattern = " Clip", replacement = "")) %>% 
   rename(SILLY = `Silly Code`, `SAMPLE #` = FK_FISH_ID, `WGC BARCODE` = `DNA_TRAY_CODE`) %>% 
   select(SILLY, `SAMPLE #`, `WGC BARCODE`, `WELL CODE`, `TISSUE TYPE`) %>% 
   arrange(SILLY, `WGC BARCODE`, `WELL CODE`)
)
```

### Write
```{r}
write_csv(sport_tbr_torun_extraction, path = "../Extraction Lists/Sport_TBR_Extraction.csv")

sport_tbr_torun_extraction %>% 
  count(SILLY, `TISSUE TYPE`)
```

## Gillnet TBR + District 101 and 115

### ASL Data

#### Read raw ASL
```{r}
(asl_gillnet <- read_csv(file = "../ASL Data/20190822_Gillnet_D8_11_1_15_Detailed ASL Samples.csv"))
```

#### Manipulate ASL
```{r}
(asl_gillnet <- asl_gillnet %>% 
   filter(District %in% c(108, 111) & `Length mm` >= 660 | District %in% c(101, 115)) %>% 
   filter(`Stat Week` <= 29) %>% 
   filter(!is.na(`Dna Specimen No`))
)
```

#### Visualize ASL
```{r}
asl_gillnet %>% 
  count(Year, District, `Stat Week`, `Harvest Code`) %>% 
  spread(District, n, fill = 0)
```


## Harvest Data

### Read Fish Ticket Data
```{r}
(harvest_gillnet <- read_csv(file = "../Harvest Data/20190822_gillnet_ft - Detailed Fish Tickets.csv"))
```

### Manipulate Harvest
```{r}
(harvest_gillnet <- harvest_gillnet %>% 
   filter(District %in% c(101, 108, 111, 115)) %>% 
   filter(between(`Stat Week`, 25, 29)) %>% 
   filter(`Species Code And Name` == "410 - salmon, chinook") %>% 
   filter(`Gear Code` == "03") %>% 
   filter(`Harvest Code` == 11) %>% 
   filter(Year == 2019)
)
```

### Visualize Harvest
```{r}
harvest_gillnet %>% 
  group_by(District, `Stat Week`) %>% 
  summarise(harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  spread(District, harvest, fill = 0)
```

Check average weights
```{r}
harvest_gillnet %>% 
  group_by(District, `Stat Week`) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE), Pounds = sum(`Landed Weight (sum)`, na.rm = TRUE)) %>% 
  mutate(AvgWeight = Pounds/Harvest) %>% 
  select(-Harvest, - Pounds) %>% 
  spread(District, AvgWeight)
```

### Join ASL and Harvest
```{r}
harvest_sw_district <- harvest_gillnet %>% 
  group_by(District, `Stat Week`) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE))

(join_gillnet <- asl_gillnet %>% 
    filter(!is.na(`Dna Specimen No`)) %>% 
    count(`Stat Week`, District) %>% 
    full_join(harvest_sw_district, by = c("Stat Week", "District")) %>% 
    replace_na(list(n = 0, Harvest = 0)) %>% 
    select(`Stat Week`, District, n , Harvest)
)

join_gillnet %>% 
  filter(n > Harvest)
```

#### Plot ASL samples and harvest as proportions by fishery
```{r}
join_gillnet %>% 
  group_by(District) %>% 
  mutate(n = n / sum(n), harvest = Harvest / sum(Harvest)) %>% 
  ungroup() %>% 
  gather(variable, proportion, -`Stat Week`, -`District`, - Harvest) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = pretty_breaks()) +
  facet_grid(District ~ variable, scales = "fixed") +
  ggtitle("Proportion of Samples and Harvest\nby Stat Week and District for Gillnet AY19") +
  theme_bw()
```

Thus the plan for extraction is to pick up to 200 fish, with the important caveat of subsampling in proportion to harvest by SW for each district

**Business rule** is to take fish from within 2 SW on either side to fill in for missing

```{r}
join_gillnet %>% 
  group_by(District) %>% 
  summarise(Harvest = sum(Harvest), n = sum(n))
```

### 101 Gillnet

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_gillnet_101 <- join_gillnet %>% 
   filter(District == 101) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 200)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Plenty of fish, looks great.
```{r}
(extraction_gillnet_101 <- extraction_gillnet_101 %>% 
   select(District, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_gillnet %>% 
  filter(District == 101) %>% 
  full_join(extraction_gillnet_101, by = c("District", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -District) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(District ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and District for Gillnet 101 AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
gillnet_101_torun <- asl_gillnet %>% 
  filter(District == 101) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_gillnet_101, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
gillnet_101_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 115 Gillnet

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_gillnet_115 <- join_gillnet %>% 
   filter(District == 115) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 200)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Plenty of fish, looks great.
```{r}
(extraction_gillnet_115 <- extraction_gillnet_115 %>% 
   mutate(n_extract = case_when(`Stat Week` == 27 ~ 30,
                                TRUE ~ n_extract)) %>% 
   select(District, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_gillnet %>% 
  filter(District == 115) %>% 
  full_join(extraction_gillnet_115, by = c("District", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -District) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(District ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and District for Gillnet 115 AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
gillnet_115_torun <- asl_gillnet %>% 
  filter(District == 115) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_gillnet_115, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
gillnet_115_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 108 Gillnet TBR

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_gillnet_108 <- join_gillnet %>% 
   filter(District == 108) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 105)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Doesn't look great...but goign to go with all fish
```{r}
(extraction_gillnet_108 <- extraction_gillnet_108 %>% 
   mutate(n_extract = case_when(`Stat Week` == 26 ~ 28,
                                `Stat Week` == 29 ~ 17,
                                TRUE ~ n_extract)) %>% 
   select(District, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_gillnet %>% 
  filter(District == 108) %>% 
  full_join(extraction_gillnet_108, by = c("District", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -District) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(District ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and District for Gillnet 108 AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
gillnet_108_torun <- asl_gillnet %>% 
  filter(District == 108) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_gillnet_108, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
gillnet_108_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 111 Gillnet TBR

Plan is to subsample as many fish as possible. What would proportional sampling look like?
```{r}
(extraction_gillnet_111 <- join_gillnet %>% 
   filter(District == 111) %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * 115)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Doesn't look great...but goign to go with all fish
```{r}
(extraction_gillnet_111 <- extraction_gillnet_111 %>% 
   mutate(n_extract = case_when(`Stat Week` == 27 ~ 48,
                                TRUE ~ n_extract)) %>% 
   select(District, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_gillnet %>% 
  filter(District == 111) %>% 
  full_join(extraction_gillnet_111, by = c("District", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -District) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(District ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and District for Gillnet 111 AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
gillnet_111_torun <- asl_gillnet %>% 
  filter(District == 111) %>% 
  nest(-`Stat Week`) %>% 
  right_join(extraction_gillnet_111, by = "Stat Week") %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample)
```

Verify picked fish
```{r}
gillnet_111_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### Gillnet Extraction

Combine in to a single tibble.
```{r}
gillnet_torun_asl <- bind_rows(gillnet_101_torun, gillnet_108_torun, gillnet_111_torun, gillnet_115_torun)
gillnet_torun_asl %>% 
  count(District)

save_objects("gillnet_torun_asl", path = "../Objects")
```

Plot proportions
```{r}
join_gillnet %>% 
  full_join(gillnet_torun_asl %>% count(District, `Stat Week`), by = c("District", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  replace_na(list(n_sample = 0, n_extract = 0, Harvest = 0)) %>%  # replace NA in samples and harvest with 0
  group_by(District) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -District) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(District ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and District for Gillnet AY19") +
  theme_bw()
```

## Write Gillnet Extraction List

Confirm that all `Dna Specimen No` are 6 characters before splitting
```{r}
table(nchar(gillnet_torun_asl$`Dna Specimen No`))
```

Damn
```{r}
gillnet_torun_asl %>% 
  filter(nchar(`Dna Specimen No`) == 5)
```

Checked Iris' summary for the other card, and it looks like it was missing the leading 5.

Yes, that one is just missing the last 0
```{r}
gillnet_torun_asl <- gillnet_torun_asl %>% 
  mutate(`Dna Specimen No` = case_when(`Dna Specimen No` == 31404 ~ 531404,
                                       TRUE ~ `Dna Specimen No`))
```

Confirm both fixed
```{r}
table(nchar(gillnet_torun_asl$`Dna Specimen No`))
```

### Compare with *LOKI*
Excellent! Next we'll pull tissue collection info from OceanAK and join, need full 10 digit WGC number and Sample number
```{r}
(loki_tissue_gillnet <- read_csv(file = "../OceanAK/GEN_SAMPLED_FISH_TISSUE_KGILL19D1_D11_D8_D15.csv") %>% 
   filter(is.na(IS_MISSING_PAIRED_DATA_EXISTS)) %>%  # make sure we aren't issing the tissue
   select(`Silly Code`, FK_FISH_ID, DNA_TRAY_CODE, DNA_TRAY_WELL_CODE, PK_TISSUE_TYPE) %>% 
   mutate(WGC_4digit = str_sub(DNA_TRAY_CODE, 7, 10)) %>% 
   mutate(WGC_2digit_pos = str_pad(string = DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   unite(dna_specimen_no, c(WGC_4digit, WGC_2digit_pos), sep = '', remove = FALSE) %>% 
   mutate(dna_specimen_no = as.integer(dna_specimen_no))
)
```

Are all my extraction fish in the LOKI tissue table?
```{r}
table(gillnet_torun_asl$`Dna Specimen No` %in% loki_tissue_gillnet$dna_specimen_no)
```

### Resolve Discrepancies
Looks like we are missing 1 fish..., but which ones???
```{r}
missing_fish <- sort(setdiff(gillnet_torun_asl$`Dna Specimen No`, loki_tissue_gillnet$dna_specimen_no))

gillnet_torun_asl %>% 
  filter(`Dna Specimen No` %in% missing_fish) %>% 
  select(District, `Stat Week`, `Dna Specimen No`)
```

Are there more fish left for this SW?
```{r}
asl_gillnet %>% 
  filter(District == 111 & `Stat Week` == 27) %>% 
  anti_join(gillnet_torun_asl) %>% 
  arrange(`Dna Specimen No`)
```

Grab the next fish? If exists in LOKI
```{r}
loki_tissue_gillnet %>% 
  filter(dna_specimen_no == 510209)
```

```{r}
gillnet_torun_asl_mod <- gillnet_torun_asl %>% 
  filter(`Dna Specimen No` != 510309) %>% 
  bind_rows(asl_gillnet %>% filter(`Dna Specimen No` == 510209))
```

Are all my extraction fish in the LOKI tissue table?
```{r}
table(gillnet_torun_asl_mod$`Dna Specimen No` %in% loki_tissue_gillnet$dna_specimen_no)
```

### Duplicates
Any duplicates?
```{r}
table(table(loki_tissue_gillnet$dna_specimen_no))
table(table(gillnet_torun_asl_mod$`Dna Specimen No`))
```

Shit, looks like five fish selected for extraction have the same Dna Specimen No, which are they?
```{r}
gillnet_torun_asl_mod %>% 
  count(`Dna Specimen No`) %>% 
  filter(n > 1)
```

Where are they from?
```{r}
gillnet_torun_asl_mod %>% 
  filter(`Dna Specimen No` %in% c(419301, 419303, 419309, 419605, 419607))
```

The fish from Ketchikan, D101, SW 27 actually have a 5 digit WGC = 34195. So these fish are actually fine.
```{r}
gillnet_torun_asl_mod <- gillnet_torun_asl_mod %>% 
  mutate(`Dna Specimen No` = case_when(`Dna Specimen No` == 419301 & `Port Code` == "KTN" ~ 3419301,
                                       `Dna Specimen No` == 419303 & `Port Code` == "KTN" ~ 3419303,
                                       `Dna Specimen No` == 419309 & `Port Code` == "KTN" ~ 3419309,
                                       `Dna Specimen No` == 419605 & `Port Code` == "KTN" ~ 3419605,
                                       `Dna Specimen No` == 419607 & `Port Code` == "KTN" ~ 3419607,
                                       TRUE ~ `Dna Specimen No`))
```

Need to fix LOKI too otherwise join won't work
```{r}
WGC_5digits <- loki_tissue_gillnet %>% 
  mutate(WGC_5digit = as.integer(str_sub(DNA_TRAY_CODE, 6, 10))) %>% 
  filter(nchar(WGC_5digit) == 5) %>% 
  distinct(DNA_TRAY_CODE) %>% 
  pull(DNA_TRAY_CODE)


loki_tissue_gillnet <- loki_tissue_gillnet %>% 
  mutate(WGC_5digit = str_sub(DNA_TRAY_CODE, 6, 10)) %>% 
  mutate(WGC_2digit_pos = str_pad(string = DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
  unite(dna_specimen_no_7, c(WGC_5digit, WGC_2digit_pos), sep = '', remove = FALSE) %>% 
  mutate(dna_specimen_no = case_when(DNA_TRAY_CODE %in% WGC_5digits ~ as.integer(dna_specimen_no_7),
                                     TRUE ~ dna_specimen_no))
```

Any duplicates now?
```{r}
table(table(gillnet_torun_asl_mod$`Dna Specimen No`))
table(table(loki_tissue_gillnet$dna_specimen_no))
```

And everything still in LOKI?
```{r}
table(gillnet_torun_asl_mod$`Dna Specimen No` %in% loki_tissue_gillnet$dna_specimen_no)
```

```{r}
missing_fish2 <- setdiff(gillnet_torun_asl$`Dna Specimen No`, loki_tissue_gillnet$dna_specimen_no)

gillnet_torun_asl_mod <- gillnet_torun_asl_mod %>% 
  mutate(`Dna Specimen No` = case_when(`Dna Specimen No` %in% missing_fish2 ~ as.numeric(paste0(3, `Dna Specimen No`)),
                                       TRUE ~ `Dna Specimen No`))
```

Any duplicates now?
```{r}
table(table(gillnet_torun_asl_mod$`Dna Specimen No`))
table(table(loki_tissue_gillnet$dna_specimen_no))
```

And everything still in LOKI?
```{r}
table(gillnet_torun_asl_mod$`Dna Specimen No` %in% loki_tissue_gillnet$dna_specimen_no)
```

Excellent, all present and accounted for. Verify that we have the correct numbers of fish per district
```{r}
gillnet_torun_asl_mod %>% 
  count(District)
```

### More Discrepancies

ASL says one district, but Silly Code is another
```{r}
gillnet_torun_asl_mod %>% 
  left_join(loki_tissue_gillnet, by = c(`Dna Specimen No` = "dna_specimen_no")) %>% 
  count(District, `Silly Code`)
```

```{r}
gillnet_torun_asl_mod %>% 
  left_join(loki_tissue_gillnet, by = c(`Dna Specimen No` = "dna_specimen_no")) %>% 
  filter(District == 101 & `Silly Code` == "KGILL19D8")
```

Pick two different fish
```{r}
asl_gillnet %>% 
  filter(District == 101 & `Stat Week` == 27) %>% 
  anti_join(gillnet_torun_asl_mod, by = c("Scale Card No", "Specimen Number", "Average Length mm", "Sample Date"))
```

```{r}
gillnet_torun_asl_mod <- gillnet_torun_asl_mod %>% 
  filter(!`Dna Specimen No` %in% c(419609, 419101)) %>% 
  bind_rows(asl_gillnet %>% filter(`Dna Specimen No` %in% c(500601, 500603)))
```

Any duplicates now?
```{r}
table(table(gillnet_torun_asl_mod$`Dna Specimen No`))
table(table(loki_tissue_gillnet$dna_specimen_no))
```

And everything still in LOKI?
```{r}
table(gillnet_torun_asl_mod$`Dna Specimen No` %in% loki_tissue_gillnet$dna_specimen_no)
```

Excellent, all present and accounted for. Verify that we have the correct numbers of fish per district
```{r}
gillnet_torun_asl_mod %>% 
  count(District)
```

### Format

Join LOKI Tissue Table with ASL and format for Extraction List Template
```{r}
(gillnet_torun_extraction <- gillnet_torun_asl_mod %>% 
   left_join(loki_tissue_gillnet, by = c(`Dna Specimen No` = "dna_specimen_no")) %>% 
   mutate(`WELL CODE` = str_pad(DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   mutate(`TISSUE TYPE` = str_replace(PK_TISSUE_TYPE, pattern = " Process", replacement = "")) %>% 
   mutate(`TISSUE TYPE` = str_replace(`TISSUE TYPE`, pattern = " Clip", replacement = "")) %>% 
   rename(SILLY = `Silly Code`, `SAMPLE #` = FK_FISH_ID, `WGC BARCODE` = `DNA_TRAY_CODE`) %>% 
   select(SILLY, `SAMPLE #`, `WGC BARCODE`, `WELL CODE`, `TISSUE TYPE`) %>% 
   arrange(SILLY, `WGC BARCODE`, `WELL CODE`)
)
```

### Write
```{r}
write_csv(gillnet_torun_extraction, path = "../Extraction Lists/Gillnet_Extraction.csv")

gillnet_torun_extraction %>% 
  count(SILLY, `TISSUE TYPE`)
```

# Summer Troll

Mon Oct 21 11:52:28 2019

Going to do Summer Retention 1 and 2 first because it is easier than Spring (Quad and period vs. Stat Area and month).

## ASL Data

### Read raw ASL
```{r}
(asl_summer <- read_csv(file = "../ASL Data/20191021_Detailed ASL Samples.csv"))
```

### Manipulate ASL

Samples by stat week
```{r}
asl_summer %>% 
  count(Year, `Stat Week`) %>%
  spread(Year, n, fill = 0)
```

Verify break between spring, summer, and early winter
```{r}
asl_summer %>% 
  count(Year, `Harvest Code`, `Stat Week`) %>% 
  filter(`Stat Week` >= 25 & `Stat Week` <= 38)
```

Assign fishery
```{r}
(asl_summer <- asl_summer %>% 
   mutate(Year_f = factor(Year)) %>% 
   rename(Quadrant = District) %>% 
   mutate(Fishery = case_when(Harvest == "Spring Troll Fishery" ~ "Spring",
                              Harvest == "Traditional State Managed Fisheries" & `Stat Week` <= 11 ~ "Late Winter",
                              Harvest == "Traditional State Managed Fisheries" & `Stat Week` >= 41 ~ "Early Winter",
                              Harvest == "Traditional State Managed Fisheries" & `Stat Week` >= 27 & `Stat Week` <= 31 ~ "Summer Ret 1",
                              Harvest == "Traditional State Managed Fisheries" & `Stat Week` >= 32 & `Stat Week` <= 36 ~ "Summer Ret 2")) %>% 
   mutate(Fishery = factor(Fishery, levels = c("Late Winter", "Spring", "Summer Ret 1", "Summer Ret 2", "Early Winter")))
)
```


### Visualize ASL

Samples by fishery and quadrant
```{r}
asl_summer %>% 
  filter(!is.na(`Dna Specimen No`)) %>% 
  count(Year, Fishery, Quadrant) %>% 
  filter(Year == 2019 & Fishery == "Summer Ret 1" | Year == 2019 & Fishery == "Summer Ret 2") %>% 
  spread(Quadrant, n)
```

Check out spring real quick...
```{r}
asl_summer %>% 
  filter(!is.na(`Dna Specimen No`)) %>% 
  count(Year, Fishery, Quadrant) %>% 
  filter(Year == 2019 & Fishery == "Spring") %>% 
  spread(Quadrant, n, fill = 0)
```

```{r}
asl_summer %>% 
  ggplot(aes(x = `Stat Week`, fill = Fishery)) +
  geom_bar() +
  facet_grid(Year ~ .) +
  ggtitle("Samples by Stat Week")
```

### Read Tissue Table from *LOKI*
Excellent! Next we'll pull tissue collection info from OceanAK and join, need full 10 digit WGC number and Sample number
```{r}
(loki_tissue_summer <- read_csv(file = "../OceanAK/GEN_SAMPLED_FISH_TISSUE_KTROL19SU.csv") %>% 
   filter(is.na(IS_MISSING_PAIRED_DATA_EXISTS)) %>%  # make sure we aren't issing the tissue
   select(`Silly Code`, FK_FISH_ID, DNA_TRAY_CODE, DNA_TRAY_WELL_CODE, PK_TISSUE_TYPE) %>% 
   mutate(WGC_4digit = str_sub(DNA_TRAY_CODE, 7, 10)) %>% 
   mutate(WGC_2digit_pos = str_pad(string = DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   unite(dna_specimen_no, c(WGC_4digit, WGC_2digit_pos), sep = '', remove = FALSE) %>% 
   mutate(dna_specimen_no = as.integer(dna_specimen_no))
)
```

### Duplicates in Dna Specimen Number
Any duplicates in *LOKI* or ASL?
```{r}
asl_summer <- asl_summer %>% 
  filter(Fishery %in% c("Summer Ret 1", "Summer Ret 2") & Year == 2019)

table(table(loki_tissue_summer$dna_specimen_no))
table(table(asl_summer$`Dna Specimen No`))
```

Shit, I need to deal with all of the duplicates in *LOKI* before doing anything else or it will cause problems with joining the OceanAK data with the ASL data by `Dna Specimen No`. Figure out which cards are the issue.
```{r}
loki_dups <- loki_tissue_summer %>% 
  count(dna_specimen_no, WGC_4digit) %>% 
  filter(n > 1) %>% 
  distinct(WGC_4digit) %>% 
  pull(WGC_4digit)

loki_tissue_summer %>% 
  filter(WGC_4digit %in% loki_dups) %>% 
  select(DNA_TRAY_CODE, WGC_4digit) %>% 
  arrange(WGC_4digit) %>% 
  distinct()
```

And where are they in ASL (i.e. where are they from?)
```{r}
asl_summer %>% 
  mutate(WGC_4digit = str_sub(string = `Dna Specimen No`, start = 1, end = 4)) %>% 
  filter(WGC_4digit %in% loki_dups) %>% 
  select(WGC_4digit, `Sample Date`, Quadrant, `Port Code`, `Stat Week`) %>% 
  arrange(WGC_4digit) %>% 
  distinct()
```

After checking Iris' sheet, the 100000XXXX WGC are from Wrangell and the 000003XXXX WGC are from Ketchikan!
```{r}
asl_summer <- asl_summer %>%
  mutate(WGC_4digit = str_sub(string = `Dna Specimen No`, start = 1, end = 4)) %>%
  mutate(`Dna Specimen No` = case_when(
      WGC_4digit %in% loki_dups & `Port Code` == "KTN" ~ as.numeric(paste0(3, `Dna Specimen No`)),
      TRUE ~ `Dna Specimen No`
    )
  )
```

Did we fix ASL?
```{r}
table(table(asl_summer$`Dna Specimen No`))
table(nchar(asl_summer$`Dna Specimen No`))
```

Huzzah! Now to fix *LOKI*
```{r}
loki_tissue_summer <- loki_tissue_summer %>% 
  mutate(dna_specimen_no = case_when(
    DNA_TRAY_CODE %in% c("0000034199", "0000034204", "0000034210") ~ as.integer(paste0(3, dna_specimen_no)), 
    TRUE ~ dna_specimen_no
  ))
```

Did we fix *LOKI*?
```{r}
table(table(loki_tissue_summer$dna_specimen_no))
table(nchar(loki_tissue_summer$dna_specimen_no))
```

Cool beans. There were 3 sets of cards with duplicate WGC_4digit (last 4). We identified which ones were 100000XXXX vs. 000003XXXX and assigned the 000003XXXX fish a 7 digit Dna Specimen No that includes the 3. This was done both on the *OceanAK* side and the *ASL* side. So we shouldn't have any issues when we pick fish.

## Harvest Data

### Read Fish Ticket Data
```{r}
(harvest_summer <- read_csv(file = "../Harvest Data/20191021_ft - Detailed Fish Tickets.csv"))
```

### Manipulate Harvest

Don't forget the weird "3rd" retention period for 2019 designed to "mop up" any remaining quota post-2nd retention.
```{r}
(harvest_summer <- harvest_summer %>% 
   mutate(Quadrant = case_when(District %in% c(113, 114, 116, 154, 156, 157) | District >= 181 ~ 171,
                               District %in% c(103, 104, 152) ~ 172,
                               District %in% c(109, 110, 111, 112, 115) ~ 173,
                               District %in% c(101, 102, 105, 106, 107, 108) ~ 174)) %>% 
   mutate(Year_f = factor(Year)) %>% 
   mutate(Fishery = case_when(`Harvest Code` == 13 ~ "Spring",
                              `Harvest Code` == 11 & `Stat Week` <= 17 ~ "Late Winter",
                              `Harvest Code` == 11 & `Stat Week` >= 41 ~ "Early Winter",
                              `Harvest Code` == 11 & `Stat Week` >= 27 & `Stat Week` <= 28 ~ "Summer Ret 1",
                              `Harvest Code` == 11 & `Stat Week` >= 33 & `Stat Week` <= 34 ~ "Summer Ret 2",
                              `Harvest Code` == 11 & `Stat Week` >= 35 & `Stat Week` <= 40 ~ "Summer Ret 3")) %>% 
   mutate(Fishery = factor(Fishery, levels = c("Late Winter", "Spring", "Summer Ret 1", "Summer Ret 2", "Summer Ret 3", "Early Winter")))
)
```

### Visualize Harvest
```{r}
harvest_summer %>% 
  group_by(Year, Fishery, Quadrant) %>% 
  summarise(harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  filter(Year == 2019 & Fishery == "Summer Ret 1" | Year == 2019 & Fishery == "Summer Ret 2") %>% 
  spread(Quadrant, harvest)
```

```{r}
harvest_summer %>% 
  filter(`Stat Week` >= 26 & `Stat Week` <= 41) %>% 
  group_by(Year, `Stat Week`, Fishery) %>% 
  summarize(harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  spread(Year, harvest, fill = 0)
```

## Join ASL and Harvest
```{r}
harvest_sw_quadrant <- harvest_summer %>% 
  filter(Year == 2019 & Fishery == "Summer Ret 1" | Year == 2019 & Fishery == "Summer Ret 2") %>% 
  group_by(Year, Fishery, `Stat Week`, `Harvest Code`, Quadrant) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`)) 

(join_summer <- asl_summer %>% 
    filter(!is.na(`Dna Specimen No`)) %>% 
    filter(Year == 2019 & Fishery == "Summer Ret 1" | Year == 2019 & Fishery == "Summer Ret 2") %>% 
    count(Year, Fishery, `Stat Week`, Quadrant) %>% 
    full_join(harvest_sw_quadrant, by = c("Year", "Fishery", "Stat Week", "Quadrant")) %>% 
    replace_na(list(n = 0, Harvest = 0)) %>% 
    select(Year, Fishery, `Stat Week`, Quadrant, n , Harvest)
)

join_summer %>% 
  filter(n > Harvest)
```

### Plot ASL samples and harvest as proportions by fishery

This year, each fishery only lasted 1 stat week, so that makes things verrrrry easy.
```{r}
join_summer %>% 
  group_by(Fishery, Quadrant) %>% 
  mutate(n = n / sum(n), harvest = Harvest / sum(Harvest)) %>% 
  ungroup() %>% 
  gather(variable, proportion, -`Stat Week`, -`Quadrant`, - Harvest, - Fishery, - Year) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = pretty_breaks()) +
  facet_grid(`Quadrant` ~ variable, scales = "fixed") +
  ggtitle("Proportion of Samples and Harvest\nby Stat Week and Quadrant for Summer Troll AY19") +
  theme_bw()
```

## Summer Selection Combined

After checking with Grant (AMB) and Dani (treaty czaress), we are going to go with the same plan as last year. Enough fish to report NO and SO as stand-alone, 50 each from the others. Selection is very simple this year as each fishery only occured during a single statistical week.
```{r}
(extraction_summer <- tribble(
  ~Fishery, ~Quadrant, ~n,
  "Summer Ret 1", 171, 380,
  "Summer Ret 1", 172, 220,
  "Summer Ret 1", 173, 50,
  "Summer Ret 1", 174, 50,
  "Summer Ret 2", 171, 220,
  "Summer Ret 2", 172, 120,
  "Summer Ret 2", 173, 50,
  "Summer Ret 2", 174, 50,
)
)
```

Ignore statistical week, as the fishery was only open for a single week. **Note**, some ASL samples were taken the following week when fish were offloaded.

Randomly pick fish per Fishery and Quadrant
```{r}
summer_torun_asl <- asl_summer %>% 
  filter(Year == 2019, Fishery %in% c("Summer Ret 1", "Summer Ret 2")) %>% 
  nest(-Fishery, -Quadrant) %>% 
  right_join(extraction_summer, by = c("Fishery", "Quadrant")) %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample) %>% 
  select(-data)
```

Verify picked fish
```{r}
summer_torun_asl %>% 
  count(Fishery, Quadrant) %>% 
  spread(Quadrant, n, fill = 0)
```

```{r}
save_objects(objects = "summer_torun_asl", path = "../Objects/")
```


## Write Summer Extraction List

We already dealt with duplicate issues at the beginning, so now we should just have to see if all of our ASL fish exist in OceanAK.

### Compare with *LOKI*
Are all my extraction fish in the LOKI tissue table?
```{r}
table(summer_torun_asl$`Dna Specimen No` %in% loki_tissue_summer$dna_specimen_no)
```

### Resolve Discrepancies
Looks like we are missing 4 fish..., but which ones???
```{r}
missing_fish <- sort(setdiff(summer_torun_asl$`Dna Specimen No`, loki_tissue_summer$dna_specimen_no))

summer_torun_asl %>% 
  filter(`Dna Specimen No` %in% missing_fish) %>% 
  select(Fishery, Quadrant, `Stat Week`, `Dna Specimen No`)
```

Do these two Whatman cards exist in LOKI?
```{r}
sum(grepl(pattern = 2432, x = loki_tissue_summer$WGC_4digit))
sum(grepl(pattern = 2240, x = loki_tissue_summer$WGC_4digit))
sum(grepl(pattern = 3900, x = loki_tissue_summer$WGC_4digit))
sum(grepl(pattern = 3894, x = loki_tissue_summer$WGC_4digit))
```

One card is completely missing. After reviewing Iris' summary, there is 3903-3906, which one got miscoded?
```{r}
asl_summer %>% 
  filter(`Dna Specimen No` >= 390000 & `Dna Specimen No` <= 390610) %>% 
  count(WGC_4digit)
```

Looks like 3904 is the 3900 incident.

I decided to forgo checking the physical Whatman card, we are just going to make this change. I'll modify those `Dna Specimen No` now.
```{r}
summer_torun_asl_mod <- summer_torun_asl %>% 
  mutate(`Dna Specimen No` = as.numeric(str_replace(string = as.character(`Dna Specimen No`), pattern = "3900", replacement = "3904")))
```

As for fish 243207, it looks like we only have 9 in LOKI from that Whatman card, how many did we want to extract?
```{r}
summer_torun_asl[grep(pattern = 243207, x = summer_torun_asl$`Dna Specimen No`), ] %>% 
  arrange(`Dna Specimen No`)
```

Looks like we wanted 1 total, so we can just drop 243207 and replace with another one.
```{r}
summer_torun_asl_mod <- summer_torun_asl_mod %>% 
  filter(`Dna Specimen No` != 243207) %>% 
  bind_rows(filter(asl_summer, `Dna Specimen No` == 243206))
```

As for fish 224003, it looks like we only have 9 in LOKI from that Whatman card, how many did we want to extract?
```{r}
summer_torun_asl[grep(pattern = 2240, x = summer_torun_asl$`Dna Specimen No`), ] %>% 
  arrange(`Dna Specimen No`)
```

Looks like we wanted 7 total, so we can just drop 243207 and replace with another one.
```{r}
summer_torun_asl_mod <- summer_torun_asl_mod %>% 
  filter(`Dna Specimen No` != 224003) %>% 
  bind_rows(filter(asl_summer, `Dna Specimen No` == 224001))
```

As for fish 389409, it looks like we only have 9 in LOKI from that Whatman card, how many did we want to extract?
```{r}
summer_torun_asl[grep(pattern = 3894, x = summer_torun_asl$`Dna Specimen No`), ] %>% 
  arrange(`Dna Specimen No`)
```

Looks like we wanted 3 total, so we can just drop 389409 and replace with another one.
```{r}
summer_torun_asl_mod <- summer_torun_asl_mod %>% 
  filter(`Dna Specimen No` != 389409) %>% 
  bind_rows(filter(asl_summer, `Dna Specimen No` == 389407))
```

Now is everything in LOKI?
```{r}
table(summer_torun_asl_mod$`Dna Specimen No` %in% loki_tissue_summer$dna_specimen_no)
```

And still no duplicates?
```{r}
table(table(summer_torun_asl_mod$`Dna Specimen No`))
```

Excellent, all present and accounted for. Verify that we have the correct numbers of fish per fishery/quadrant
```{r}
summer_torun_asl_mod %>% 
  count(Fishery, Quadrant) %>% 
  spread(Quadrant, n, fill = 0)
```

Victory is mine!!!
```{r}
save_objects(objects = "summer_torun_asl_mod", path = "../Objects/")
```


### Format

Join LOKI Tissue Table with ASL and format for Extraction List Template
```{r}
(summer_torun_extraction <- summer_torun_asl_mod %>% 
   left_join(loki_tissue_summer, by = c(`Dna Specimen No` = "dna_specimen_no")) %>% 
   mutate(`WELL CODE` = str_pad(DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   mutate(`TISSUE TYPE` = str_replace(PK_TISSUE_TYPE, pattern = " Process", replacement = "")) %>% 
   mutate(`TISSUE TYPE` = str_replace(`TISSUE TYPE`, pattern = " Clip", replacement = "")) %>% 
   rename(SILLY = `Silly Code`, `SAMPLE #` = FK_FISH_ID, `WGC BARCODE` = `DNA_TRAY_CODE`) %>% 
   select(SILLY, `SAMPLE #`, `WGC BARCODE`, `WELL CODE`, `TISSUE TYPE`) %>% 
   arrange(SILLY, `WGC BARCODE`, `WELL CODE`)
)
```

### Write
```{r}
write_csv(summer_torun_extraction, path = "../Extraction Lists/Summer_Extraction.csv")

summer_torun_extraction %>% 
  count(SILLY, `TISSUE TYPE`)
```


# Spring Troll

Mon Oct 21 13:25:12 2019

Spring troll is messy because we do things by Month and Stat Area

## ASL Data

Need to read in ASL data from Iris to get the District/Sub-District data.
### Read raw ASL
```{r}
(asl_spring <- read_csv(file = "../Associated Data/Spring/2019 Spring Troll Chinook with Dist Sub Dist (version 1).csv") %>% 
   filter(!is.na(`Dna Specimen No`)))
```

### Manipulate ASL

Samples by stat week
```{r}
asl_spring %>% 
  count(`Harvest Code`, `Stat Week`)
```

Assign fishery, month, and stat area
```{r}
(asl_spring <- asl_spring %>% 
   mutate(`Sample Date` = mdy(`Sample Date`)) %>% 
   mutate(Year_f = factor(Year)) %>% 
   mutate(Fishery = case_when(Harvest == "Spring Troll Fishery" ~ "Spring")) %>% 
   mutate(Fishery = factor(Fishery, levels = c("Late Winter", "Spring", "Summer Ret 1", "Summer Ret 2", "Early Winter"))) %>% 
   mutate(Month = case_when(`Stat Week` <= 22 ~ "May",
                            `Stat Week` >= 23 ~ "June")) %>%  # update! anything SW22 and less is May
   mutate(Month = factor(Month, levels = c("May", "June"))) %>% 
   mutate(month = month(`Sample Date`, label = TRUE, abbr = FALSE)) %>% 
   mutate(subdistrict = str_pad(string = `Sub-District`, width = 2, side = "left", pad = "0")) %>% 
   unite("Stat Area", c(District, subdistrict), sep = '', remove = FALSE)
)
```

Investigate month discrepancies. Planning to stick with "Month" as defined by stat week as opposed to sample date.
```{r}
asl_spring %>% 
  filter(Month == "May" & month == "June") %>% 
  count(`Stat Area`)
```

### Visualize ASL

Samples by Month and Stat Area
```{r, fig.width=8, fig.height=10}
asl_spring %>% 
  filter(Fishery == "Spring" & Year == "2019") %>%
  filter(!is.na(`Dna Specimen No`)) %>% 
  ggplot(aes(x = `Stat Week`, fill = Fishery)) +
  geom_bar() +
  scale_x_continuous(breaks = 18:27) +
  facet_grid(`Stat Area` ~ Month) +
  ylab("# DNA Samples") +
  ggtitle("Samples by Stat Week and Stat Area for Spring AY19")
```

Samples by Month and Quadrant
```{r, fig.width=8}
asl_spring %>% 
  filter(Fishery == "Spring" & Year == "2019") %>%
  filter(!is.na(`Dna Specimen No`)) %>% 
  ggplot(aes(x = `Stat Week`, fill = Fishery)) +
  geom_bar() +
  scale_x_continuous(breaks = 18:27) +
  facet_grid(Quadrant ~ Month) +
  ylab("# DNA Samples") +
  ggtitle("Samples by Stat Week and Quadrant for Spring AY19")
```

Sample sizes by Month and Quadrant for the planning spreadsheet.
```{r}
asl_spring %>% 
  filter(Fishery == "Spring" & Year == "2019") %>%
  filter(!is.na(`Dna Specimen No`)) %>% 
  count(Year_f, Quadrant, Fishery, Month) %>% 
  spread(Quadrant, n, fill = 0)
```

### Read Tissue Table from *LOKI*
Excellent! Next we'll pull tissue collection info from OceanAK and join, need full 10 digit WGC number and Sample number
```{r}
(loki_tissue_spring <- read_csv(file = "../OceanAK/GEN_SAMPLED_FISH_TISSUE_KTROL19SP.csv") %>% 
   filter(is.na(IS_MISSING_PAIRED_DATA_EXISTS)) %>%  # make sure we aren't issing the tissue
   select(`Silly Code`, FK_FISH_ID, DNA_TRAY_CODE, DNA_TRAY_WELL_CODE, PK_TISSUE_TYPE) %>% 
   mutate(WGC_4digit = str_sub(DNA_TRAY_CODE, 7, 10)) %>% 
   mutate(WGC_2digit_pos = str_pad(string = DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   unite(dna_specimen_no, c(WGC_4digit, WGC_2digit_pos), sep = '', remove = FALSE) %>% 
   mutate(dna_specimen_no = as.integer(dna_specimen_no))
)
```

### Duplicates in Dna Specimen Number
Any duplicates in *LOKI* or ASL?
```{r}
table(table(loki_tissue_spring$dna_specimen_no))
table(table(asl_spring$`Dna Specimen No`))
```

By good grace of Allah, there are no duplicate Dna Specimen No!

## Harvest Data

### Read Fish Ticket Data
```{r}
(harvest_spring <- read_csv(file = "../Harvest Data/20191021_ft - Detailed Fish Tickets.csv"))
```

### Manipulate Harvest

Don't forget the weird "3rd" retention period for 2019 designed to "mop up" any remaining quota post-2nd retention.
```{r}
(harvest_spring <- harvest_spring %>% 
   filter(`Harvest Code` == 13) %>% 
   mutate(Quadrant = case_when(District %in% c(113, 114, 116, 154, 156, 157) | District >= 181 ~ 171,
                               District %in% c(103, 104, 152) ~ 172,
                               District %in% c(109, 110, 111, 112, 115) ~ 173,
                               District %in% c(101, 102, 105, 106, 107, 108) ~ 174)) %>% 
   mutate(Month = case_when(`Stat Week` <= 22 ~ "May",
                            `Stat Week` >= 23 ~ "June")) %>%  # update! anything SW22 and less is May
   mutate(Month = factor(Month, levels = c("May", "June")))
   )
```

### Visualize Harvest
```{r, fig.width=8, fig.height=10}
harvest_spring %>% 
  filter(`Harvest Code` == 13 & Year == 2019) %>%
  group_by(`Stat Week`, `Harvest Code`, `Stat Area`, Month) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`)) %>% 
  ggplot(aes(x = `Stat Week`, y = Harvest, fill = `Harvest Code`)) +
  geom_col() +
  scale_x_continuous(breaks = 18:27) +
  facet_grid(`Stat Area` ~ Month) +
  ggtitle("Harvest by Stat Week and Stat Area for Spring AY19")
```

```{r, fig.width=8}
harvest_spring %>% 
  filter(`Harvest Code` == 13 & Year == 2019) %>%
  group_by(`Stat Week`, `Harvest Code`, Quadrant, Month) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`)) %>% 
  ggplot(aes(x = `Stat Week`, y = Harvest, fill = `Harvest Code`)) +
  geom_col() +
  scale_x_continuous(breaks = 18:27) +
  facet_grid(Quadrant ~ Month) +
  ggtitle("Harvest by Stat Week and Quadrant for Spring AY19")
```

```{r}
harvest_spring %>% 
  filter(`Harvest Code` == 13 & Year == 2019) %>%
  group_by(`Harvest Code`, Quadrant, Month) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`)) %>% 
  spread(Quadrant, Harvest, fill = 0)
```

```{r}
harvest_spring %>% 
  mutate(`Stat Area` = factor(x = `Stat Area`, levels = sort(unique(`Stat Area`)))) %>% 
  filter(`Harvest Code` == 13 & Year == 2019) %>%
  group_by(`Stat Week`, `Stat Area`) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`)) %>% 
  ggplot(aes(x = `Stat Week`, y = `Stat Area`, fill = Harvest, label = Harvest)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "black", na.value = "white") +
  scale_x_continuous(breaks = 18:27) +
  theme_classic() +
  geom_text(color = "red") +
  ggtitle("Spring - Harvest by Stat Week and Stat Area")
```

## Join ASL and Harvest

```{r}
# Roll up harvest to Quad level
harvest_sw_statarea <- harvest_spring %>% 
  filter(`Harvest Code` == 13 & Year == 2019) %>%
  mutate(`Stat Area` = as.character(`Stat Area`)) %>% 
  group_by(`Stat Week`, `Harvest Code`, `Stat Area`, Quadrant, Month) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`)) 


# Roll up ASL to SW and Quad level, join with harvest
(join_spring <- asl_spring %>% 
    filter(Fishery == "Spring" & Year == 2019) %>%
    filter(!is.na(`Dna Specimen No`)) %>%  # filter for known DNA samples
    count(Fishery, `Stat Week`, `Stat Area`, Month) %>% 
    full_join(harvest_sw_statarea, by = c("Stat Week", "Stat Area", "Month")) %>%  # very important to do a full join in case some weeks are missing harvest or samples
    replace_na(list(n = 0, Harvest = 0)) %>%  # replace NA in samples and harvest with 0
    select(`Stat Area`, Month, `Stat Week`, n, Harvest)
)
```

```{r}
join_spring %>% 
  filter(n > Harvest)  # should be 0 rows...
```

```{r}
join_spring %>% 
  group_by(`Stat Area`, Month) %>% 
  summarise(n = sum(n, na.rm = TRUE), Harvest = sum(Harvest, na.rm = TRUE)) %>% 
  ungroup() %>% 
  select(-n) %>% 
  spread(Month, Harvest, fill = 0) %>% 
  mutate(Total = May + June)

join_spring %>% 
  group_by(`Stat Area`, Month) %>% 
  summarise(n = sum(n, na.rm = TRUE), Harvest = sum(Harvest, na.rm = TRUE)) %>% 
  ungroup() %>% 
  select(-Harvest) %>% 
  spread(Month, n, fill = 0) %>% 
  mutate(Total = May + June)
```

### Plot ASL samples and harvest as proportions by fishery

```{r fig.width=8, fig.height=10}
join_spring %>% 
  select(`Stat Area`, `Stat Week`, n , Harvest) %>% 
  group_by(`Stat Area`) %>% 
  mutate(n = n / sum(n), harvest = Harvest / sum(Harvest)) %>% 
  ungroup() %>% 
  gather(variable, proportion, -`Stat Week`, -`Stat Area`, - Harvest) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = 18:27) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Proportion of Samples and Harvest\nby Stat Week and Stat Area for Spring Troll AY19")
```


## Spring Selection

The plan for extraction is to pick , with the important caveat of subsampling in proportion to harvest by SW for each quadrant.

**Business rule** is to take fish from within 1 SW on either side to fill in for missing.

### 101-45 June

Plan is to subsample ~200 fish. What would proportional sampling look like?
```{r}
n_sub <- 200

(extraction_10145_june <- join_spring %>% 
   filter(`Stat Area` == "10145" & Month == "June") %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * n_sub)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in stat week 26 with fish from stat week 25 according to our business rule of +/- 1 week.
```{r}
(extraction_10145_june <- extraction_10145_june %>% 
   mutate(n_extract = case_when(`Stat Week` == 25 ~ 88,
                                TRUE ~ n_extract)) %>%
   select(`Stat Area`, Month, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_spring %>% 
  filter(`Stat Area` == "10145" & Month == "June") %>% 
  full_join(extraction_10145_june, by = c("Stat Area", "Month", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -Month, -`Stat Area`) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Stat Area for Spring AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
june_10145_torun <- asl_spring %>% 
  filter(`Stat Area` == "10145" & Month == "June") %>% 
  nest(-`Stat Week`, -Month, - `Stat Area`) %>% 
  right_join(extraction_10145_june, by = c("Stat Week", "Month", "Stat Area")) %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample) %>% 
  select(-data)
```

Verify picked fish
```{r}
june_10145_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 101-46 June

Plan is to subsample ~174 (all) fish. What would proportional sampling look like?
```{r}
n_sub <- 174

(extraction_10146_june <- join_spring %>% 
   filter(`Stat Area` == "10146" & Month == "June") %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * n_sub)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to run all fish, according to our business rule of +/- 1 week.
```{r}
(extraction_10146_june <- extraction_10146_june %>% 
   mutate(n_extract = n) %>%
   select(`Stat Area`, Month, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_spring %>% 
  filter(`Stat Area` == "10146" & Month == "June") %>% 
  full_join(extraction_10146_june, by = c("Stat Area", "Month", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -Month, -`Stat Area`) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Stat Area for Spring AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
june_10146_torun <- asl_spring %>% 
  filter(`Stat Area` == "10146" & Month == "June") %>% 
  nest(-`Stat Week`, -Month, - `Stat Area`) %>% 
  right_join(extraction_10146_june, by = c("Stat Week", "Month", "Stat Area")) %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample) %>% 
  select(-data)
```

Verify picked fish
```{r}
june_10146_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 103-50 May

Plan is to subsample ~200 fish if possible. What would proportional sampling look like?
```{r}
n_sub <- 120

(extraction_10350_may <- join_spring %>% 
   filter(`Stat Area` == "10350" & Month == "May") %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * n_sub)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in stat week 22 with fish from stat week 21 according to our business rule of +/- 1 week.
```{r}
(extraction_10350_may <- extraction_10350_may %>% 
   mutate(n_extract = case_when(`Stat Week` == 21 ~ 44,
                                TRUE ~ n_extract)) %>%
   select(`Stat Area`, Month, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_spring %>% 
  filter(`Stat Area` == "10350" & Month == "May") %>% 
  full_join(extraction_10350_may, by = c("Stat Area", "Month", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -Month, -`Stat Area`) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Stat Area for Spring AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
may_10350_torun <- asl_spring %>% 
  filter(`Stat Area` == "10350" & Month == "May") %>% 
  nest(-`Stat Week`, -Month, - `Stat Area`) %>% 
  right_join(extraction_10350_may, by = c("Stat Week", "Month", "Stat Area")) %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample) %>% 
  select(-data)
```

Verify picked fish
```{r}
may_10350_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 103-50 June

Plan is to subsample ~64 (all) fish if possible. What would proportional sampling look like?
```{r}
n_sub <- 58

(extraction_10350_june <- join_spring %>% 
   filter(`Stat Area` == "10350" & Month == "June") %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * n_sub)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

No need to adjust *n_extract*.
```{r}
(extraction_10350_june <- extraction_10350_june %>% 
   select(`Stat Area`, Month, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_spring %>% 
  filter(`Stat Area` == "10350" & Month == "June") %>% 
  full_join(extraction_10350_june, by = c("Stat Area", "Month", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -Month, -`Stat Area`) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Stat Area for Spring AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
june_10350_torun <- asl_spring %>% 
  filter(`Stat Area` == "10350" & Month == "June") %>% 
  nest(-`Stat Week`, -Month, - `Stat Area`) %>% 
  right_join(extraction_10350_june, by = c("Stat Week", "Month", "Stat Area")) %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample) %>% 
  select(-data)
```

Verify picked fish
```{r}
june_10350_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 113-01 June

Plan is to subsample ~100 fish. What would proportional sampling look like?
```{r}
n_sub <- 99.9

(extraction_11301_june <- join_spring %>% 
   filter(`Stat Area` == "11301" & Month == "June") %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * n_sub)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

No need to adjust *n_extract*.
```{r}
(extraction_11301_june <- extraction_11301_june %>% 
   select(`Stat Area`, Month, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_spring %>% 
  filter(`Stat Area` == "11301" & Month == "June") %>% 
  full_join(extraction_11301_june, by = c("Stat Area", "Month", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -Month, -`Stat Area`) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Stat Area for Spring AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
june_11301_torun <- asl_spring %>% 
  filter(`Stat Area` == "11301" & Month == "June") %>% 
  nest(-`Stat Week`, -Month, - `Stat Area`) %>% 
  right_join(extraction_11301_june, by = c("Stat Week", "Month", "Stat Area")) %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample) %>% 
  select(-data)
```

Verify picked fish
```{r}
june_11301_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 113-30 May

Plan is to subsample ~100 fish if possible. What would proportional sampling look like?
```{r}
n_sub <- 100

(extraction_11330_may <- join_spring %>% 
   filter(`Stat Area` == "11330" & Month == "May") %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * n_sub)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

No need to adjust *n_extract*.
```{r}
(extraction_11330_may <- extraction_11330_may %>% 
   select(`Stat Area`, Month, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_spring %>% 
  filter(`Stat Area` == "11330" & Month == "May") %>% 
  full_join(extraction_11330_may, by = c("Stat Area", "Month", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -Month, -`Stat Area`) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Stat Area for Spring AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
may_11330_torun <- asl_spring %>% 
  filter(`Stat Area` == "11330" & Month == "May") %>% 
  nest(-`Stat Week`, -Month, - `Stat Area`) %>% 
  right_join(extraction_11330_may, by = c("Stat Week", "Month", "Stat Area")) %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample) %>% 
  select(-data)
```

Verify picked fish
```{r}
may_11330_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 113-30 June

Plan is to subsample ~59 (all) fish if possible. What would proportional sampling look like?
```{r}
n_sub <- 40

(extraction_11330_june <- join_spring %>% 
   filter(`Stat Area` == "11330" & Month == "June") %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * n_sub)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in stat week 23 with fish from stat week 24 according to our business rule of +/- 1 week.
```{r}
(extraction_11330_june <- extraction_11330_june %>% 
   mutate(n_extract = case_when(`Stat Week` == 24 ~ 7,
                                TRUE ~ n_extract)) %>%
   select(`Stat Area`, Month, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_spring %>% 
  filter(`Stat Area` == "11330" & Month == "June") %>% 
  full_join(extraction_11330_june, by = c("Stat Area", "Month", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -Month, -`Stat Area`) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Stat Area for Spring AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
june_11330_torun <- asl_spring %>% 
  filter(`Stat Area` == "11330" & Month == "June") %>% 
  nest(-`Stat Week`, -Month, - `Stat Area`) %>% 
  right_join(extraction_11330_june, by = c("Stat Week", "Month", "Stat Area")) %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample) %>% 
  select(-data)
```

Verify picked fish
```{r}
june_11330_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 113-41 May

Plan is to subsample ~200 fish if possible. What would proportional sampling look like?
```{r}
n_sub <- 200

(extraction_11341_may <- join_spring %>% 
   filter(`Stat Area` == "11341" & Month == "May") %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * n_sub)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

No need to adjust *n_extract*.
```{r}
(extraction_11341_may <- extraction_11341_may %>% 
   select(`Stat Area`, Month, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_spring %>% 
  filter(`Stat Area` == "11341" & Month == "May") %>% 
  full_join(extraction_11341_may, by = c("Stat Area", "Month", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -Month, -`Stat Area`) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Stat Area for Spring AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
may_11341_torun <- asl_spring %>% 
  filter(`Stat Area` == "11341" & Month == "May") %>% 
  nest(-`Stat Week`, -Month, - `Stat Area`) %>% 
  right_join(extraction_11341_may, by = c("Stat Week", "Month", "Stat Area")) %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample) %>% 
  select(-data)
```

Verify picked fish
```{r}
may_11341_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 113-41 June

Plan is to subsample ~200 fish if possible. What would proportional sampling look like?
```{r}
n_sub <- 200

(extraction_11341_june <- join_spring %>% 
   filter(`Stat Area` == "11341" & Month == "June") %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * n_sub)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

No need to adjust *n_extract*.
```{r}
(extraction_11341_june <- extraction_11341_june %>% 
   select(`Stat Area`, Month, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_spring %>% 
  filter(`Stat Area` == "11341" & Month == "June") %>% 
  full_join(extraction_11341_june, by = c("Stat Area", "Month", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -Month, -`Stat Area`) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Stat Area for Spring AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
june_11341_torun <- asl_spring %>% 
  filter(`Stat Area` == "11341" & Month == "June") %>% 
  nest(-`Stat Week`, -Month, - `Stat Area`) %>% 
  right_join(extraction_11341_june, by = c("Stat Week", "Month", "Stat Area")) %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample) %>% 
  select(-data)
```

Verify picked fish
```{r}
june_11341_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 113-62 May

Plan is to subsample ~100 fish if possible. What would proportional sampling look like?
```{r}
n_sub <- 100

(extraction_11362_may <- join_spring %>% 
   filter(`Stat Area` == "11362" & Month == "May") %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * n_sub)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

Adjust *n_extract* to fill in stat week 20 with fish from stat week 19 and 21 according to our business rule of +/- 1 week.
```{r}
(extraction_11362_may <- extraction_11362_may %>% 
   mutate(n_extract = case_when(`Stat Week` == 19 ~ 16,
                                `Stat Week` == 21 ~ 28,
                                TRUE ~ n_extract)) %>%
   select(`Stat Area`, Month, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_spring %>% 
  filter(`Stat Area` == "11362" & Month == "May") %>% 
  full_join(extraction_11362_may, by = c("Stat Area", "Month", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -Month, -`Stat Area`) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Stat Area for Spring AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
may_11362_torun <- asl_spring %>% 
  filter(`Stat Area` == "11362" & Month == "May") %>% 
  nest(-`Stat Week`, -Month, - `Stat Area`) %>% 
  right_join(extraction_11362_may, by = c("Stat Week", "Month", "Stat Area")) %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample) %>% 
  select(-data)
```

Verify picked fish
```{r}
may_11362_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 113-62 June

Plan is to subsample ~200 fish if possible. What would proportional sampling look like?
```{r}
n_sub <- 200

(extraction_11362_june <- join_spring %>% 
   filter(`Stat Area` == "11362" & Month == "June") %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * n_sub)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

No need to adjust *n_extract*.
```{r}
(extraction_11362_june <- extraction_11362_june %>% 
   select(`Stat Area`, Month, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_spring %>% 
  filter(`Stat Area` == "11362" & Month == "June") %>% 
  full_join(extraction_11362_june, by = c("Stat Area", "Month", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -Month, -`Stat Area`) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Stat Area for Spring AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
june_11362_torun <- asl_spring %>% 
  filter(`Stat Area` == "11362" & Month == "June") %>% 
  nest(-`Stat Week`, -Month, - `Stat Area`) %>% 
  right_join(extraction_11362_june, by = c("Stat Week", "Month", "Stat Area")) %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample) %>% 
  select(-data)
```

Verify picked fish
```{r}
june_11362_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 183-10 May

Plan is to subsample ~100 fish if possible. What would proportional sampling look like?
```{r}
n_sub <- 100

(extraction_18310_may <- join_spring %>% 
   filter(`Stat Area` == "18310" & Month == "May") %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * n_sub)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

No need to adjust *n_extract*.
```{r}
(extraction_18310_may <- extraction_18310_may %>% 
   select(`Stat Area`, Month, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_spring %>% 
  filter(`Stat Area` == "18310" & Month == "May") %>% 
  full_join(extraction_18310_may, by = c("Stat Area", "Month", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -Month, -`Stat Area`) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Stat Area for Spring AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
may_18310_torun <- asl_spring %>% 
  filter(`Stat Area` == "18310" & Month == "May") %>% 
  nest(-`Stat Week`, -Month, - `Stat Area`) %>% 
  right_join(extraction_18310_may, by = c("Stat Week", "Month", "Stat Area")) %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample) %>% 
  select(-data)
```

Verify picked fish
```{r}
may_18310_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### 183-10 June

Plan is to subsample ~100 fish if possible. What would proportional sampling look like?
```{r}
n_sub <- 100

(extraction_18310_june <- join_spring %>% 
   filter(`Stat Area` == "18310" & Month == "June") %>% 
   arrange(`Stat Week`) %>% 
   mutate(pHarvest = round(Harvest / sum(Harvest) * n_sub)) %>%  # if we want XXX samples proportional to harvest by SW
   mutate(n_sufficeint = n >= pHarvest) %>% 
   mutate(n_remainings = n - pHarvest) %>% 
   mutate(n_extract = pmin(n, pHarvest))
)
```

No need to adjust *n_extract*.
```{r}
(extraction_18310_june <- extraction_18310_june %>% 
   select(`Stat Area`, Month, `Stat Week`, n_extract) %>% 
   rename(n = n_extract) %>% 
   filter(n > 0)  # can only keep rows > 0, otherwise nest doesn't work for picking fish
)
```

Does our subsampling make the fish we are planning to extract more representative of harvest than the original sampling?
```{r}
join_spring %>% 
  filter(`Stat Area` == "18310" & Month == "June") %>% 
  full_join(extraction_18310_june, by = c("Stat Area", "Month", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -Month, -`Stat Area`) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Stat Area for Spring AY19") +
  theme_bw()
```

Randomly pick fish per week
```{r}
june_18310_torun <- asl_spring %>% 
  filter(`Stat Area` == "18310" & Month == "June") %>% 
  nest(-`Stat Week`, -Month, - `Stat Area`) %>% 
  right_join(extraction_18310_june, by = c("Stat Week", "Month", "Stat Area")) %>% 
  mutate(Sample = map2(data, n, sample_n)) %>% 
  unnest(Sample) %>% 
  select(-data)
```

Verify picked fish
```{r}
june_18310_torun %>% 
  count(`Stat Week`) %>% 
  mutate(total = sum(n))
```

### Spring Extraction

Combine in to a single tibble.
```{r}
spring_torun_asl <-
  bind_rows(lapply(c(
    grep(pattern = "may", x = objects(pattern = "torun"), value = TRUE),
    grep(pattern = "june", x = objects(pattern = "torun"), value = TRUE)
  ), get))

spring_torun_asl %>% 
  count(`Stat Area`, Month) %>% 
  spread(Month, n, fill = 0)

save_objects("spring_torun_asl", path = "../Objects")
```

Plot proportions for May...
```{r fig.width=8}
join_spring %>% 
  filter(Month == "May") %>% 
  full_join(spring_torun_asl %>% filter(Month == "May") %>% count(`Stat Area`, Month,`Stat Week`), by = c("Stat Area", "Month", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  replace_na(list(n_sample = 0, n_extract = 0, Harvest = 0)) %>%  # replace NA in samples and harvest with 0
  group_by(`Stat Area`) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -Month, -`Stat Area`) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Stat Area for May AY19") +
  theme_bw()
```

... and June
```{r fig.width=8, fig.height=10}
join_spring %>% 
  filter(Month == "June") %>% 
  full_join(spring_torun_asl %>% filter(Month == "June") %>% count(`Stat Area`, Month,`Stat Week`), by = c("Stat Area", "Month", "Stat Week"), suffix = c("_sample", "_extract")) %>% 
  replace_na(list(n_sample = 0, n_extract = 0, Harvest = 0)) %>%  # replace NA in samples and harvest with 0
  group_by(`Stat Area`) %>% 
  mutate(n_extract = n_extract / sum(n_extract, na.rm = TRUE), 
         n_sample = n_sample / sum(n_sample, na.rm = TRUE), 
         Harvest = Harvest / sum(Harvest, na.rm = TRUE)) %>% 
  gather(variable, proportion, -`Stat Week`, -Month, -`Stat Area`) %>% 
  ggplot(aes(x = `Stat Week`, y = proportion, fill = variable)) +
  geom_col() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  facet_grid(`Stat Area` ~ variable, scales = "fixed") +
  ggtitle("Extraction and Harvest by Stat Week and Stat Area for June AY19") +
  theme_bw()
```

## Write Spring Extraction List

We already dealt with duplicate issues at the beginning, so now we should just have to see if all of our ASL fish exist in OceanAK.

### Compare with *LOKI*
Are all my extraction fish in the LOKI tissue table?
```{r}
table(spring_torun_asl$`Dna Specimen No` %in% loki_tissue_spring$dna_specimen_no)
```

### Resolve Discrepancies
Looks like we are missing 14 fish..., but which ones???
```{r}
missing_fish <- sort(setdiff(spring_torun_asl$`Dna Specimen No`, loki_tissue_spring$dna_specimen_no))

spring_torun_asl %>% 
  filter(`Dna Specimen No` %in% missing_fish) %>% 
  select(`Stat Area`, `Port Code`, Month, `Stat Week`, `Dna Specimen No`)
```

Do these five Whatman cards exist in LOKI?
```{r}
sum(grepl(pattern = 4969, x = loki_tissue_spring$WGC_4digit))
sum(grepl(pattern = 2326, x = loki_tissue_spring$WGC_4digit))
sum(grepl(pattern = 2571, x = loki_tissue_spring$WGC_4digit))
sum(grepl(pattern = 5743, x = loki_tissue_spring$WGC_4digit))
sum(grepl(pattern = 2004, x = loki_tissue_spring$WGC_4digit))
```

Two cards are completely missing. 

After reviewing Iris' summary, it looks like 4969 is likely 4696. Verify 4696 not in ASL
```{r}
asl_spring %>% 
  filter(`Dna Specimen No` >= 469600 & `Dna Specimen No` <= 469611)
```

Verify that 4696 is in LOKI
```{r}
loki_tissue_spring %>% 
  filter(WGC_4digit == 4696)
```

Verify that we can do a simple `str_replace`
```{r}
sum(grepl(pattern = "4969", x = spring_torun_asl$`Dna Specimen No`))
```

Looks like 4969 is the 4696 incident.

I decided to forgo checking the physical Whatman card, we are just going to make this change. I'll modify those `Dna Specimen No` now.
```{r}
spring_torun_asl_mod <- spring_torun_asl %>% 
  mutate(`Dna Specimen No` = as.numeric(str_replace(string = as.character(`Dna Specimen No`), pattern = "4969", replacement = "4696")))
```


After reviewing Iris' summary, it looks like 5743 is likely 5473. Verify 5473 not in ASL
```{r}
asl_spring %>% 
  filter(`Dna Specimen No` >= 547300 & `Dna Specimen No` <= 547311)
```

Verify that 5473 is in LOKI
```{r}
loki_tissue_spring %>% 
  filter(WGC_4digit == 5473)
```

Verify that we can do a simple `str_replace`
```{r}
sum(grepl(pattern = "5743", x = spring_torun_asl$`Dna Specimen No`))
```

Looks like 5473 is the 5743 incident.

I decided to forgo checking the physical Whatman card, we are just going to make this change. I'll modify those `Dna Specimen No` now.
```{r}
spring_torun_asl_mod <- spring_torun_asl_mod %>% 
  mutate(`Dna Specimen No` = as.numeric(str_replace(string = as.character(`Dna Specimen No`), pattern = "5743", replacement = "5473")))
```

Okay, now that we've resolved the two cards that were misidentified, we need to resolve the remaining four fish that appear to be missing
```{r}
spring_torun_asl_mod %>% 
  filter(`Dna Specimen No` %in% missing_fish) %>% 
  select(`Stat Area`, `Port Code`, Month, `Stat Week`, `Dna Specimen No`)
```

How many fish are on these three Whatman cards in LOKI?
```{r}
sum(grepl(pattern = 2326, x = loki_tissue_spring$WGC_4digit))
sum(grepl(pattern = 2571, x = loki_tissue_spring$WGC_4digit))
sum(grepl(pattern = 2004, x = loki_tissue_spring$WGC_4digit))
```

Starting with 2326, how many did we want to extract?
```{r}
spring_torun_asl_mod[grep(pattern = 2326, x = spring_torun_asl_mod$`Dna Specimen No`), ] %>% 
  arrange(`Dna Specimen No`)
```

Looks like wanted 5, and there are 5 in LOKI, we can just swap out 232606 for 232603
```{r}
spring_torun_asl_mod <- spring_torun_asl_mod %>% 
  filter(`Dna Specimen No` != 232606) %>% 
  bind_rows(filter(asl_spring, `Dna Specimen No` == 232603))
```

Now how about 2571?
```{r}
spring_torun_asl_mod[grep(pattern = 2571, x = spring_torun_asl_mod$`Dna Specimen No`), ] %>% 
  arrange(`Dna Specimen No`)
```

Looks like we wanted 2, and there are 7 in LOKI, we can just swap out 257113 and 257115 for 257103 and 257105
```{r}
spring_torun_asl_mod <- spring_torun_asl_mod %>% 
  mutate(`Dna Specimen No` = as.numeric(str_replace(string = as.character(`Dna Specimen No`), pattern = "25711", replacement = "25710")))
```

Now how about 2004?
```{r}
spring_torun_asl_mod[grep(pattern = 2004, x = spring_torun_asl_mod$`Dna Specimen No`), ] %>% 
  arrange(`Dna Specimen No`)
```

Looks like we wanted 1, and there are 6 in LOKI, we can just swap out 200411 for 200404
```{r}
spring_torun_asl_mod <- spring_torun_asl_mod %>% 
  filter(`Dna Specimen No` != 200411) %>% 
  bind_rows(filter(asl_spring, `Dna Specimen No` == 200404))
```

Now is everything in LOKI?
```{r}
table(spring_torun_asl_mod$`Dna Specimen No` %in% loki_tissue_spring$dna_specimen_no)
```

And still no duplicates?
```{r}
table(table(spring_torun_asl_mod$`Dna Specimen No`))
```

Excellent, all present and accounted for. Verify that we have the correct numbers of fish per fishery/quadrant
```{r}
spring_torun_asl_mod %>% 
  count(Month, `Stat Area`) %>% 
  spread(Month, n, fill = 0)
```

```{r}
spring_torun_asl_mod %>% 
  count(Month, Quadrant) %>% 
  spread(Quadrant, n, fill = 0)
```

Victory is mine!!!
```{r}
save_objects(objects = "spring_torun_asl_mod", path = "../Objects/")
```


### Format

Join LOKI Tissue Table with ASL and format for Extraction List Template
```{r}
(spring_torun_extraction <- spring_torun_asl_mod %>% 
   left_join(loki_tissue_spring, by = c(`Dna Specimen No` = "dna_specimen_no")) %>% 
   mutate(`WELL CODE` = str_pad(DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   mutate(`TISSUE TYPE` = str_replace(PK_TISSUE_TYPE, pattern = " Process", replacement = "")) %>% 
   mutate(`TISSUE TYPE` = str_replace(`TISSUE TYPE`, pattern = " Clip", replacement = "")) %>% 
   rename(SILLY = `Silly Code`, `SAMPLE #` = FK_FISH_ID, `WGC BARCODE` = `DNA_TRAY_CODE`) %>% 
   select(SILLY, `SAMPLE #`, `WGC BARCODE`, `WELL CODE`, `TISSUE TYPE`) %>% 
   arrange(SILLY, `WGC BARCODE`, `WELL CODE`)
)
```

### Write
```{r}
write_csv(spring_torun_extraction, path = "../Extraction Lists/Spring_Extraction.csv")

spring_torun_extraction %>% 
  count(SILLY, `TISSUE TYPE`)
```

### QC Crosschecks

We had one QC fish not match any project fish, but the QC fish before and after looked fine. We could run a QC Crosscheck on those in-between fish, but may not need to depending on what areas/stat weeks they are from.
```{r}
(barcodes <- readClipboard())
```

```{r}
wells <- readClipboard()
```

```{r}
(qc_xcheck <- tibble(wgc = barcodes, position = wells) %>% 
   mutate(wgc_4_digit = str_sub(string = wgc, start = 7, end = 10),
          wgc_2_digit_pos = str_pad(string = position, width = 2, side = "left", pad = "0")) %>% 
   unite(col = dna_specimen_no, c("wgc_4_digit", "wgc_2_digit_pos"), sep = '')
)
```

Where/when are these fish from?
```{r}
asl_spring %>% 
  filter(`Dna Specimen No` %in% qc_xcheck$dna_specimen_no) %>% 
  count(`Stat Area`, `Stat Week`)
```

What if we drop the 1st and last fish (known QC/project matches)
```{r}
asl_spring %>% 
  filter(`Dna Specimen No` %in% qc_xcheck$dna_specimen_no[2:18]) %>% 
  count(`Stat Area`, `Stat Week`)
```

Awesome, this is great news. Almost all of the fish are from the same Stat Area/Stat week, so even if we have QC issues, we will have ended up with fish from the same mixture. Should be good to go!


# Sport (Origins not Origins)

Tue Nov 05 11:40:27 2019

Goal is to analyze 2,800 fish that we proposed following strata from previous years:  
  - Sitka
  - Craig
  - Ketchikan
  - Petersburg/Wrangell (note some fish were already run for TBR)
  - Outisde through biweek 13 (subset of Sitka and Craig)
  - Outside post biweek 13 (subset of Sitka and Craig)

Business rule is to take fish from within 1 biweek on either side to fill in for missing

## ASL Data

### Read raw ASL

```{r}
(asl_sport <- read_csv(file = "../ASL Data/_2019_SEAK_SF_Whatman_AWL_03OCT19.csv"))
```

### QA ASL

Check Whatman_Card digits...
```{r}
table(nchar(asl_sport$Whatman_Card))
```

Bummer, we have one card with only 3 digits...better look in to.
```{r}
asl_sport %>% 
  mutate(nchar_Whatman_Card = nchar(Whatman_Card)) %>% 
  filter(nchar_Whatman_Card == 3)
```

Are there any other fish on this card? Could be a typo.
```{r}
asl_sport %>% 
  filter(Date_Caught == "20Jun2019" & ScaleCardNumber == "127")
```
It was a typo, went and fixed it in the raw data, then re-read in ASL.

### Manipulate ASL

Filter for just species 410 (legal), only DNA sampled
```{r}
asl_sport <- asl_sport %>% 
  filter(SPECCODE == 410) %>% 
  filter(!is.na(SAMPLE_NO))
```

Make SITE a factor for ordering purposes
```{r}
asl_sport <- asl_sport %>%
  mutate(site = factor(
    SITE,
    c(
      "JUNEAU",
      "KETCHIKAN",
      "WRANGELL",
      "PETERSBURG",
      "SITKA",
      "CRAIG_KLAWOCK",
      "GUSTAVUS",
      "ELFIN_COVE",
      "YAKUTAT"
    )
  )) %>%
  rename(biweek = BIWEEK) %>% 
  mutate(Whatman_Card = str_pad(Whatman_Card, 10, "left", "0")) %>%  # pad WGC
  # mutate(SAMPLE_NO = str_pad(SAMPLE_NO, 2, "left", "0")) %>%  # pad well
  unite(silly_source, c("Whatman_Card", "SAMPLE_NO"), sep = "_", remove = FALSE)  # silly_source
```

Pivot harvest by biweek and site
```{r}
asl_sport %>% 
  count(biweek, site) %>% 
  spread(site, n, fill = 0)
```

Create a variable for Fishery
```{r}
asl_sport <- asl_sport %>%
  mutate(
    fishery = case_when(
      site == "KETCHIKAN" ~ "KTN",
      site %in% c("PETERSBURG", "WRANGELL") ~ "PB-WR",
      site == "JUNEAU" ~ "Inside",
      site %in% c("YAKUTAT", "GUSTAVUS", "ELFIN_COVE", "SITKA", "CRAIG_KLAWOCK") &
        biweek <= 13 ~ "Outside_early",
      site %in% c("YAKUTAT", "GUSTAVUS", "ELFIN_COVE", "SITKA", "CRAIG_KLAWOCK") &
        biweek > 13 ~ "Outside_late"
    )
  ) %>%
  mutate(fishery = factor(
    fishery,
    levels = c("KTN", "PB-WR", "Inside", "Outside_early", "Outside_late")
  ))

asl_sport %>%
  count(biweek, fishery) %>%
  spread(fishery, n, fill = 0)

```

### Read Tissue Table from *LOKI*

Excellent! Next we'll pull tissue collection info from OceanAK and join, need full 10 digit WGC number and Sample number
```{r}
(loki_tissue_sport <- read_csv(file = "../OceanAK/GEN_SAMPLED_FISH_TISSUE_KSPORT19.csv") %>% 
   filter(is.na(IS_MISSING_PAIRED_DATA_EXISTS)) %>%  # make sure we aren't missing the tissue
   select(`Silly Code`, FK_FISH_ID, DNA_TRAY_CODE, DNA_TRAY_WELL_CODE, PK_TISSUE_TYPE) %>% 
   unite(silly_source, c("DNA_TRAY_CODE", "DNA_TRAY_WELL_CODE"), sep = "_", remove = FALSE)  # silly_source
)
```

Check out the number of digits for the Whatman Card barcode.
```{r}
loki_tissue_sport %>% 
  mutate(Whatman_Card = as.numeric(DNA_TRAY_CODE)) %>% 
  mutate(nchar = nchar(Whatman_Card)) %>% 
  count(nchar)
```

Groovy, all 4 and 5 digit numbers, so that is great news. Matches the ASL.

### Duplicates in Dna Specimen Number
Any duplicates in *LOKI* or ASL?
```{r}
table(table(loki_tissue_sport$silly_source))
table(table(asl_sport$silly_source))
```

By good grace of Allah, there are no duplicate silly_source for *LOKI* or ASL!

### All ASL in *LOKI*?

Check to see if all ASL fish are in *LOKI*
```{r}
table(asl_sport$silly_source %in% loki_tissue_sport$silly_source)
```

Damn, we are missing 9 fish. What are they?
```{r}
missing_sport <- setdiff(asl_sport$silly_source, loki_tissue_sport$silly_source)

asl_sport %>% 
  filter(silly_source %in% missing_sport)
```

Here are some resolutions to what was originally missing. I went back to the ASL csv and corrected the source data.  
  - 16980 was missing the SAMPLE_NO
  - 23782_2 was actually 32782_2
  - 52924_5 is missing tissue in *LOKI*
  - 5328_10 is missing tissue in *LOKI*
  - 30484_1 has a note in ASL that says it is missing
  - 5862_1 and _2 are both missing in *LOKI*, perhaps the card got lost?
  - 4196_1, _2, and _3 are likely 4916, but can't know without pulling the card so I'm going to drop them...

Any other fish from this card in *LOKI*?
```{r}
grep(pattern = "4916", x = loki_tissue_sport$silly_source, value = TRUE)
```

Get *LOKI* data that is unfiltered by "IS_MISSING_PAIRED_DATA_EXISTS"
```{r message = FALSE}
loki_tissue_sport_unfiltered <- read_csv(file = "../OceanAK/GEN_SAMPLED_FISH_TISSUE_KSPORT19.csv") %>% 
   select(`Silly Code`, FK_FISH_ID, DNA_TRAY_CODE, DNA_TRAY_WELL_CODE, PK_TISSUE_TYPE, IS_MISSING_PAIRED_DATA_EXISTS) %>% 
   unite(silly_source, c("DNA_TRAY_CODE", "DNA_TRAY_WELL_CODE"), sep = "_", remove = FALSE)

grep(pattern = "5328", x = loki_tissue_sport_unfiltered$silly_source, value = TRUE)
```

Looks like we are missing 24 tissues in *LOKI* that should have been there.
```{r}
loki_tissue_sport_unfiltered %>% 
  count(IS_MISSING_PAIRED_DATA_EXISTS)
```

Since we can not resolve the other 9 missing fish, let's remove them from the ASL data now, so we don't have to deal with this issue later.
```{r}
asl_sport <- asl_sport %>% 
  filter(!silly_source %in% missing_sport)
```

Now are all ASL fish in *LOKI*
```{r}
all(asl_sport$silly_source %in% loki_tissue_sport$silly_source)
```

Baller, and no duplicates, correct?
```{r}
table(table(asl_sport$silly_source))
```

Victory is mine! Now go pick fish for extraction!
```{r}
save_objects("asl_sport", "../Objects")
```


### Visualize ASL data

Plot samples by Stat Week and Site
Using ggplot2 `geom_bar` (we know that there is 1 row per DNA sample)
```{r}
asl_sport %>% 
  ggplot(aes(x = biweek, fill = fishery)) +
  geom_bar() +
  facet_wrap(~ site) +
  ylab("# DNA Samples") +
  ggtitle("Samples by Biweek for Sport AY19")
```


## Harvest Data

### Read Prelim Creel Harvest Data

By Site and Biweek
```{r}
(harvest_sport <- read_csv(file = "../Harvest Data/preliminary_2019_sport_harvest_chinook.csv"))
```

### Manipulate harvest data

Make data tall (tidy), recode sites to ALL CAPS
```{r}
level_key <- list("Juneau" = "JUNEAU", 
                  "Ketchikan" = "KETCHIKAN", 
                  "Wrangell" = "WRANGELL", 
                  "Petersburg" = "PETERSBURG", 
                  "Sitka" = "SITKA", 
                  "Craig" = "CRAIG_KLAWOCK", 
                  "Gustavus" = "GUSTAVUS", 
                  "Elfin Cove" = "ELFIN_COVE", 
                  "Yakutat" = "YAKUTAT")

harvest_sport <- harvest_sport %>% 
  gather(site, harvest, -biweek) %>% 
  mutate(site = recode_factor(site, !!!level_key, .ordered = TRUE))
```

Create a variable for Fishery
```{r}
harvest_sport <- harvest_sport %>%
  mutate(
    fishery = case_when(
      site == "KETCHIKAN" ~ "KTN",
      site %in% c("PETERSBURG", "WRANGELL") ~ "PB-WR",
      site == "JUNEAU" ~ "Inside",
      site %in% c("YAKUTAT", "GUSTAVUS", "ELFIN_COVE", "SITKA", "CRAIG_KLAWOCK") &
        biweek <= 13 ~ "Outside_early",
      site %in% c("YAKUTAT", "GUSTAVUS", "ELFIN_COVE", "SITKA", "CRAIG_KLAWOCK") &
        biweek > 13 ~ "Outside_late"
    )
  ) %>%
  mutate(fishery = factor(
    fishery,
    levels = c("KTN", "PB-WR", "Inside", "Outside_early", "Outside_late")
  ))
```

Table of Harvest by site
```{r}
harvest_sport %>% 
  select(-fishery) %>% 
  spread(site, harvest, fill = 0)
```

Table of Harvest by fishery strata
```{r}
harvest_sport %>% 
  group_by(fishery, biweek) %>% 
  summarise(harvest = sum(harvest)) %>% 
  spread(fishery,  harvest, fill = 0)
```

### Visualize Harvest

Plot samples by Stat Week
Using ggplot2 `geom_col` to plot harvest (identity)
```{r}
harvest_sport %>% 
  ggplot(aes(x = biweek, y = harvest, fill = fishery)) +
  geom_col() +
  facet_wrap(~ site) +
  ggtitle("Harvest by Biweek for Sport AY19")
```

Heatmap of Harvest by Stat Week and District for Sport
```{r}
max_bw_harvest <- max(harvest_sport$harvest)

harvest_sport %>% 
  ggplot(aes(x = biweek, y = site, fill = harvest, label = harvest)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "black", na.value = "white", limits = c(0, max_bw_harvest)) +
  theme_classic() +
  geom_text(color = "red") +
  ggtitle("Sport - Harvest by Biweek and Site")
```

## Join ASL and Harvest data by Site and Biweek

Roll up ASL to biweek and site level, join with harvest
```{r}
join_sport <- asl_sport %>%
  count(site, biweek) %>%
  full_join(harvest_sport, by = c("site", "biweek")) %>%  # very important to do a full join in case some weeks are missing harvest or samples
  replace_na(list(n = 0, harvest = 0))  # replace NA in samples and harvest with 0

join_sport %>%
  filter(n > harvest)  # should be 0 rows...
```

## Sport Selection

All sample size numbers come from "Associated Data/Sport/Sport Extractions - Origins.xlsx".
The game plan is to sample each port proportional to harvest (i.e. total harvest / 2800 samples to run).

Plot samples and harvest together as proportions
```{r fig.height=10, fig.width=8}
join_sport %>% 
  group_by(site) %>% 
  mutate(n = n / sum(n), harvest = harvest / sum(harvest)) %>% 
  ungroup() %>% 
  gather(variable, proportion, -biweek, -fishery, -site) %>% 
  ggplot(aes(x = biweek, y = proportion, fill = variable)) +
  geom_col() +
  facet_grid(site ~ variable, scales = "fixed") +
  ggtitle("Samples and Harvest by Stat Week and Quadrant for Sport AY19")
```


### Craig

Thus the plan for extraction is to pick ~541 for CRG (proportional for 2,800 for sport)
With the important caveat of subsampling in proportion to harvest by biweek for each port
Business rule is to take fish from within 1 SW on either side to fill in for missing

```{r}
n_sub <- 510

# What does proportional sampling look like?
(extraction_CRG <- join_sport %>% 
  filter(site == "CRAIG_KLAWOCK") %>% 
  arrange(biweek) %>% 
  mutate(p_harvest = round(harvest / sum(harvest) * n_sub)) %>%  # if we want 380 samples proportional to harvest by SW
  mutate(n_sufficeint = n >= p_harvest) %>% 
  mutate(n_remainings = n - p_harvest) %>% 
  mutate(n_extract = pmin(n, p_harvest)))
```

Decided to drop the number of samples from 541 to 510 to avoid having to move fish around. Plenty of samples, so just go with n_extract.
```{r}
(extraction_CRG <- extraction_CRG %>% 
    select(site, biweek, n_extract) %>% 
    rename(n = n_extract) %>% 
    filter(n > 0))  # can only keep rows > 0, otherwise nest doesn't work for picking fish
```

Check sample size
```{r}
sum(extraction_CRG$n)
```

Randomly pick fish
```{r warning=FALSE}
CRG_torun <- asl_sport %>% 
  filter(site == "CRAIG_KLAWOCK") %>% 
  nest(-biweek, -site) %>% 
  right_join(extraction_CRG, by = c("biweek", "site")) %>% 
  mutate(sample = map2(data, n, sample_n)) %>% 
  select(-data) %>% 
  unnest(sample)
```

Verify picked fish
```{r}
CRG_torun %>% 
  count(biweek)
```


### Sitka

Thus the plan for extraction is to pick ~1123 for SIT (proportional for 2,800 for sport)
With the important caveat of subsampling in proportion to harvest by biweek for each port
Business rule is to take fish from within 1 SW on either side to fill in for missing

```{r}
n_sub <- 1123

# What does proportional sampling look like?
(extraction_SIT <- join_sport %>% 
  filter(site == "SITKA") %>% 
  arrange(biweek) %>% 
  mutate(p_harvest = round(harvest / sum(harvest) * n_sub)) %>%  # if we want 380 samples proportional to harvest by SW
  mutate(n_sufficeint = n >= p_harvest) %>% 
  mutate(n_remainings = n - p_harvest) %>% 
  mutate(n_extract = pmin(n, p_harvest)))
```

Decided to stick with 1,123 and grab fish from surrounding biweeks. Missing 5 from 9, grab from 10. Missing 16 from 16, grab 8 from 15 and 8 from 17.
```{r}
(extraction_SIT <- extraction_SIT %>% 
    mutate(n_extract = case_when(biweek == 10 ~ n_extract + 5,
                                 biweek == 15 ~ n_extract + 8,
                                 biweek == 17 ~ n_extract + 8,
                                 TRUE ~ n_extract)) %>% 
    select(site, biweek, n_extract) %>% 
    rename(n = n_extract) %>% 
    filter(n > 0))  # can only keep rows > 0, otherwise nest doesn't work for picking fish
```

Check sample size
```{r}
sum(extraction_SIT$n)
```

Randomly pick fish
```{r warning=FALSE}
SIT_torun <- asl_sport %>% 
  filter(site == "SITKA") %>% 
  nest(-biweek, -site) %>% 
  right_join(extraction_SIT, by = c("biweek", "site")) %>% 
  mutate(sample = map2(data, n, sample_n)) %>% 
  select(-data) %>% 
  unnest(sample)
```

Verify picked fish
```{r}
SIT_torun %>% 
  count(biweek)
```


### Yakutat

Thus the plan for extraction is to pick ~79 for YAK (proportional for 2,300 for sport; 71 thru BW13, 9 post BW13)
With the important caveat of subsampling in proportion to harvest by biweek for each port
Business rule is to take fish from within 1 SW on either side to fill in for missing

**NOTE** I picked "extra" fish for Craig and Sitka, so we'll need to subsample down to get a representative mixture for the two Outside estimates (thru BW 13 + post BW 13)
Craig: 258 and 186
Sitka: 606 and 316

```{r}
n_sub <- 79

# What does proportional sampling look like?
(extraction_YAK <- join_sport %>% 
  filter(site == "YAKUTAT") %>% 
  arrange(biweek) %>% 
  mutate(p_harvest = round(harvest / sum(harvest) * n_sub)) %>% 
  mutate(n_sufficeint = n >= p_harvest) %>% 
  mutate(n_remainings = n - p_harvest) %>% 
  mutate(n_extract = pmin(n, p_harvest)))
```

Almost, missing 1 fish from BW12, but due to rounding, it adds up to 79 anyways, let it go.
```{r}
(extraction_YAK <- extraction_YAK %>% 
    select(site, biweek, n_extract) %>% 
    rename(n = n_extract) %>% 
    filter(n > 0))  # can only keep rows > 0, otherwise nest doesn't work for picking fish
```

Check sample size
```{r}
sum(extraction_YAK$n)
```

Randomly pick fish
```{r warning=FALSE}
YAK_torun <- asl_sport %>% 
  filter(site == "YAKUTAT") %>% 
  nest(-biweek, -site) %>% 
  right_join(extraction_YAK, by = c("biweek", "site")) %>% 
  mutate(sample = map2(data, n, sample_n)) %>% 
  select(-data) %>% 
  unnest(sample)
```

Verify picked fish
```{r}
YAK_torun %>% 
  count(biweek)
```


### Gustavus

Thus the plan for extraction is to pick ~13 for GUS (proportional for 2,300 for sport)
With the important caveat of subsampling in proportion to harvest by biweek for each port
Business rule is to take fish from within 1 SW on either side to fill in for missing

**NOTE** I picked "extra" fish for Craig and Sitka, so we'll need to subsample down to get a representative mixture for the two Outside estimates (thru BW 13 + post BW 13)

```{r}
n_sub <- 13

# What does proportional sampling look like?
(extraction_GUS <- join_sport %>% 
  filter(site == "GUSTAVUS") %>% 
  arrange(biweek) %>% 
  mutate(p_harvest = round(harvest / sum(harvest) * n_sub)) %>% 
  mutate(n_sufficeint = n >= p_harvest) %>% 
  mutate(n_remainings = n - p_harvest) %>% 
  mutate(n_extract = pmin(n, p_harvest)))
```

Almost, missing 1 fish from BW13, grab and extra from BW12.
```{r}
(extraction_GUS <- extraction_GUS %>% 
    mutate(n_extract = case_when(biweek == 12 ~ n_extract + 1,
                                 TRUE ~ n_extract)) %>% 
    select(site, biweek, n_extract) %>% 
    rename(n = n_extract) %>% 
    filter(n > 0))  # can only keep rows > 0, otherwise nest doesn't work for picking fish
```

Check sample size
```{r}
sum(extraction_GUS$n)
```

Randomly pick fish
```{r warning=FALSE}
GUS_torun <- asl_sport %>% 
  filter(site == "GUSTAVUS") %>% 
  nest(-biweek, -site) %>% 
  right_join(extraction_GUS, by = c("biweek", "site")) %>% 
  mutate(sample = map2(data, n, sample_n)) %>% 
  select(-data) %>% 
  unnest(sample)
```

Verify picked fish
```{r}
GUS_torun %>% 
  count(biweek)
```


### Elfin Cove

Thus the plan for extraction is to pick ~143 for ELF (proportional for 2,300 for sport)
With the important caveat of subsampling in proportion to harvest by biweek for each port
Business rule is to take fish from within 1 SW on either side to fill in for missing

**NOTE** I picked "extra" fish for Craig and Sitka, so we'll need to subsample down to get a representative mixture for the two Outside estimates (thru BW 13 + post BW 13)

```{r}
n_sub <- 143

# What does proportional sampling look like?
(extraction_ELF <- join_sport %>% 
  filter(site == "ELFIN_COVE") %>% 
  arrange(biweek) %>% 
  mutate(p_harvest = round(harvest / sum(harvest) * n_sub)) %>% 
  mutate(n_sufficeint = n >= p_harvest) %>% 
  mutate(n_remainings = n - p_harvest) %>% 
  mutate(n_extract = pmin(n, p_harvest)))
```

Missing 10 fish from BW13, grab from BW12
```{r}
(extraction_ELF <- extraction_ELF %>% 
    mutate(n_extract = case_when(biweek == 12 ~ n_extract + 10,
                                 TRUE ~ n_extract)) %>% 
    select(site, biweek, n_extract) %>% 
    rename(n = n_extract) %>% 
    filter(n > 0))  # can only keep rows > 0, otherwise nest doesn't work for picking fish
```

Check sample size
```{r}
sum(extraction_ELF$n)
```

Randomly pick fish
```{r warning=FALSE}
ELF_torun <- asl_sport %>% 
  filter(site == "ELFIN_COVE") %>% 
  nest(-biweek, -site) %>% 
  right_join(extraction_ELF, by = c("biweek", "site")) %>% 
  mutate(sample = map2(data, n, sample_n)) %>% 
  select(-data) %>% 
  unnest(sample)
```

Verify picked fish
```{r}
ELF_torun %>% 
  count(biweek)
```


### Ketchikan

Thus the plan for extraction is to pick ~359 for KTN (proportional for 2,800 for sport)
With the important caveat of subsampling in proportion to harvest by biweek for each port
Business rule is to take fish from within 1 SW on either side to fill in for missing

```{r}
n_sub <- 359

# What does proportional sampling look like?
(extraction_KTN <- join_sport %>% 
  filter(site == "KETCHIKAN") %>% 
  arrange(biweek) %>% 
  mutate(p_harvest = round(harvest / sum(harvest) * n_sub)) %>% 
  mutate(n_sufficeint = n >= p_harvest) %>% 
  mutate(n_remainings = n - p_harvest) %>% 
  mutate(n_extract = pmin(n, p_harvest)))
```

Missing 17 fish from BW11, grab from BW12. Missing 5 from BW18, grab from BW17
```{r}
(extraction_KTN <- extraction_KTN %>% 
    mutate(n_extract = case_when(biweek == 12 ~ n_extract + 17,
                                 biweek == 17 ~ n_extract + 5,
                                 TRUE ~ n_extract)) %>% 
    select(site, biweek, n_extract) %>% 
    rename(n = n_extract) %>% 
    filter(n > 0))  # can only keep rows > 0, otherwise nest doesn't work for picking fish
```

Check sample size
```{r}
sum(extraction_KTN$n)
```

Randomly pick fish
```{r warning=FALSE}
KTN_torun <- asl_sport %>% 
  filter(site == "KETCHIKAN") %>% 
  nest(-biweek, -site) %>% 
  right_join(extraction_KTN, by = c("biweek", "site")) %>% 
  mutate(sample = map2(data, n, sample_n)) %>% 
  select(-data) %>% 
  unnest(sample)
```

Verify picked fish
```{r}
KTN_torun %>% 
  count(biweek)
```


### Juneau

Thus the plan for extraction is to pick ~402 for JNU (proportional for 2,800 for sport)
With the important caveat of subsampling in proportion to harvest by biweek for each port
Business rule is to take fish from within 1 SW on either side to fill in for missing

```{r}
n_sub <- 331

# What does proportional sampling look like?
(extraction_JNU <- join_sport %>% 
  filter(site == "JUNEAU") %>% 
  arrange(biweek) %>% 
  mutate(p_harvest = round(harvest / sum(harvest) * n_sub)) %>% 
  mutate(n_sufficeint = n >= p_harvest) %>% 
  mutate(n_remainings = n - p_harvest) %>% 
  mutate(n_extract = pmin(n, p_harvest)))
```

Dropped from 402 to 331 due to sample size issues (proportional to harvest). Since we already ran a bunch of fish from BW12-14 for TBR, need to reduce sample size based on the "Sport Extractions - Origins.xlsx"
```{r}
(extraction_JNU <- extraction_JNU %>% 
    mutate(n_extract = case_when(biweek == 12 ~ 21,
                                 biweek == 13 ~ 44,
                                 biweek == 14 ~ 11,
                                 TRUE ~ n_extract)) %>% 
    select(site, biweek, n_extract) %>% 
    rename(n = n_extract) %>% 
    filter(n > 0))  # can only keep rows > 0, otherwise nest doesn't work for picking fish
```

Check sample size
```{r}
sum(extraction_JNU$n)
```

Randomly pick fish, *after removing fish already run for TBR*
```{r warning=FALSE}
JNU_torun <- asl_sport %>% 
  filter(site == "JUNEAU") %>% 
  filter(!silly_source %in% sport_tbr_torun_asl$silly_source) %>% 
  nest(-biweek, -site) %>% 
  right_join(extraction_JNU, by = c("biweek", "site")) %>% 
  mutate(sample = map2(data, n, sample_n)) %>% 
  select(-data) %>% 
  unnest(sample)
```

Verify picked fish
```{r}
JNU_torun %>% 
  count(biweek)
```

Verify TBR ASL
```{r}
filter(sport_tbr_torun_asl, SITE == "JUNEAU") %>% 
  count(BIWEEK)
```


### Petersburg

Thus the plan for extraction is to pick ~48 for PBG (proportional for 2,300 for sport)
With the important caveat of subsampling in proportion to harvest by biweek for each port
Business rule is to take fish from within 1 SW on either side to fill in for missing

```{r}
n_sub <- 48

# What does proportional sampling look like?
(extraction_PBG <- join_sport %>% 
  filter(site == "PETERSBURG") %>% 
  arrange(biweek) %>% 
  mutate(p_harvest = round(harvest / sum(harvest) * n_sub)) %>% 
  mutate(n_sufficeint = n >= p_harvest) %>% 
  mutate(n_remainings = n - p_harvest) %>% 
  mutate(n_extract = pmin(n, p_harvest)))
```

Since we already ran a bunch of fish from BW12-14 for TBR, need to reduce sample size based on the "Sport Extractions - Origins.xlsx"
```{r}
(extraction_PBG <- extraction_PBG %>% 
    mutate(n_extract = case_when(biweek == 12 ~ 13,
                                 biweek == 13 ~ 2,
                                 biweek == 14 ~ 1,
                                 TRUE ~ n_extract)) %>% 
    select(site, biweek, n_extract) %>% 
    rename(n = n_extract) %>% 
    filter(n > 0))  # can only keep rows > 0, otherwise nest doesn't work for picking fish
```

Check sample size
```{r}
sum(extraction_PBG$n)
```

Randomly pick fish, *after removing fish already run for TBR*
```{r warning=FALSE}
PBG_torun <- asl_sport %>% 
  filter(site == "PETERSBURG") %>% 
  filter(!silly_source %in% sport_tbr_torun_asl$silly_source) %>% 
  nest(-biweek, -site) %>% 
  right_join(extraction_PBG, by = c("biweek", "site")) %>% 
  mutate(sample = map2(data, n, sample_n)) %>% 
  select(-data) %>% 
  unnest(sample)
```

Verify picked fish
```{r}
PBG_torun %>% 
  count(biweek)
```

Verify TBR ASL
```{r}
filter(sport_tbr_torun_asl, SITE == "PETERSBURG") %>% 
  count(BIWEEK)
```


### Wrangell

Thus the plan for extraction is to pick ~52 for WRN (proportional for 2,300 for sport)
With the important caveat of subsampling in proportion to harvest by biweek for each port
Business rule is to take fish from within 1 SW on either side to fill in for missing

```{r}
n_sub <- 52

# What does proportional sampling look like?
(extraction_WRN <- join_sport %>% 
  filter(site == "WRANGELL") %>% 
  arrange(biweek) %>% 
  mutate(p_harvest = round(harvest / sum(harvest) * n_sub)) %>% 
  mutate(n_sufficeint = n >= p_harvest) %>% 
  mutate(n_remainings = n - p_harvest) %>% 
  mutate(n_extract = pmin(n, p_harvest)))
```

Since we already ran 4 fish from BW13 for TBR, need to reduce sample size based on the "Sport Extractions - Origins.xlsx". Also need to replace missing fish from BW11, 16, and 17 if possible.
```{r}
(extraction_WRN <- extraction_WRN %>% 
    mutate(n_extract = case_when(biweek == 12 ~ n_extract + 1,
                                 biweek == 13 ~ 8,
                                 biweek == 15 ~ n_extract + 5,
                                 TRUE ~ n_extract)) %>% 
    select(site, biweek, n_extract) %>% 
    rename(n = n_extract) %>% 
    filter(n > 0))  # can only keep rows > 0, otherwise nest doesn't work for picking fish
```

Check sample size
```{r}
sum(extraction_WRN$n)
```

Randomly pick fish, *after removing fish already run for TBR*
```{r warning=FALSE}
WRN_torun <- asl_sport %>% 
  filter(site == "WRANGELL") %>% 
  filter(!silly_source %in% sport_tbr_torun_asl$silly_source) %>% 
  nest(-biweek, -site) %>% 
  right_join(extraction_WRN, by = c("biweek", "site")) %>% 
  mutate(sample = map2(data, n, sample_n)) %>% 
  select(-data) %>% 
  unnest(sample)
```

Verify picked fish
```{r}
WRN_torun %>% 
  count(biweek)
```

Verify TBR ASL
```{r}
filter(sport_tbr_torun_asl, SITE == "WRANGELL") %>% 
  count(BIWEEK)
```


### Sport Extraction

Save each individual list
```{r}
save_objects(
  objects = c(
    "CRG_torun",
    "SIT_torun",
    "KTN_torun",
    "JNU_torun",
    "PBG_torun",
    "WRN_torun",
    "YAK_torun",
    "GUS_torun",
    "ELF_torun"
  ),
  path = "../Objects/"
)
```

Combine list and save
```{r}
sport_torun_asl <-
  bind_rows(
    CRG_torun,
    SIT_torun,
    KTN_torun,
    JNU_torun,
    PBG_torun,
    WRN_torun,
    YAK_torun,
    GUS_torun,
    ELF_torun
  )
save_objects(objects = "sport_torun_asl", path = "../Objects/")

sport_torun_asl %>% 
  count(site)
```

```{r}
nrow(sport_torun_asl)

nrow(sport_torun_asl) / 95
```

## Write Sport Extraction List

We already dealt with duplicate and missing issues at the beginning, so this should all be perfunctory and check out.

### Compare with *LOKI*
Are all my extraction fish in the LOKI tissue table?
```{r}
table(sport_torun_asl$silly_source %in% loki_tissue_sport$silly_source)
```

Fuck ya, and no duplicates?
```{r}
table(table(sport_torun_asl$silly_source))
```

VICTORY!!!!

Now I just need to write this MF out and we'll be good to go.

### Format

Join LOKI Tissue Table with ASL and format for Extraction List Template
```{r}
(sport_torun_extraction <- sport_torun_asl %>% 
   left_join(loki_tissue_sport, by = "silly_source") %>% 
   mutate(`WELL CODE` = str_pad(DNA_TRAY_WELL_CODE, width = 2, side = "left", pad = 0)) %>% 
   mutate(`TISSUE TYPE` = str_replace(PK_TISSUE_TYPE, pattern = " Process", replacement = "")) %>% 
   mutate(`TISSUE TYPE` = str_replace(`TISSUE TYPE`, pattern = " Clip", replacement = "")) %>% 
   rename(SILLY = `Silly Code`, `SAMPLE #` = FK_FISH_ID, `WGC BARCODE` = `DNA_TRAY_CODE`) %>% 
   select(SILLY, `SAMPLE #`, `WGC BARCODE`, `WELL CODE`, `TISSUE TYPE`) %>% 
   arrange(SILLY, `WGC BARCODE`, `WELL CODE`)
)
```

### Write
```{r}
write_csv(sport_torun_extraction, path = "../Extraction Lists/Sport_Origins_Extraction.csv")

sport_torun_extraction %>% 
  count(SILLY, `TISSUE TYPE`)
```
